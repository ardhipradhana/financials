<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Statement Generator - MontPro</title>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- AOS Animation Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    
    <style>
        /* Georgetown-inspired Professional Theme */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #E2E8F0;
            position: relative;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(99, 102, 241, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.04) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 100px 20px 40px;
            position: relative;
            z-index: 1;
        }

        /* Navigation */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
            z-index: 1000;
            padding: 0;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .brand-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0px;
        }
        
        .brand-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .brand-text {
            font-size: 1.4rem;
            font-weight: 700;
            color: #F8FAFC;
        }
        
        .nav-links {
            display: flex;
            align-items: center;
            gap: 32px;
        }
        
        .nav-link {
            color: #94A3B8;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .nav-link:hover {
            color: #F8FAFC;
        }
        
        .btn-nav-cta {
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-nav-cta:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-back-home,
        .btn-load-analysis {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .btn-back-home {
            background: rgba(15, 23, 42, 0.6);
            color: #94A3B8;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .btn-back-home:hover {
            color: #F8FAFC;
            border-color: rgba(59, 130, 246, 0.3);
            background: rgba(59, 130, 246, 0.05);
        }

        .btn-load-analysis {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(30, 41, 59, 0.8));
            color: #60A5FA;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .btn-load-analysis:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(30, 41, 59, 0.9));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }
        
        .back-link {
            margin-bottom: 0; /* Remove margin from original style */
        }
        
        .back-link:hover {
            color: #F8FAFC;
        }

        /* Workspace Hero */
        .workspace-hero {
            text-align: center;
            margin-bottom: 60px;
            margin-top: 80px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .trust-badge {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 25px;
            padding: 12px 20px;
            margin-bottom: 32px;
            color: #10B981;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .trust-icon {
            width: 20px;
            height: 20px;
            color: #10B981;
        }

        .workspace-hero h1 {
            font-size: 3rem;
            font-weight: 700;
            color: #F8FAFC;
            margin-bottom: 24px;
            letter-spacing: -1px;
            line-height: 1.1;
        }

        .hero-description {
            font-size: 1.2rem;
            color: #94A3B8;
            line-height: 1.7;
            margin-bottom: 40px;
        }
        
        .hero-description strong {
            color: #10B981;
            font-weight: 600;
        }
        
        .hero-benefits {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }
        
        .benefit-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #CBD5E1;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .benefit-icon {
            font-size: 1.2rem;
        }
        
        .social-proof {
            padding-top: 24px;
            border-top: 1px solid rgba(59, 130, 246, 0.1);
        }
        
        .proof-text {
            color: #64748B;
            font-size: 0.9rem;
            font-style: italic;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .workspace-hero h1 {
                font-size: 2.2rem;
            }
            
            .hero-benefits {
                gap: 20px;
                justify-content: space-around;
            }
            
            .benefit-item {
                font-size: 0.85rem;
            }
            
            .trust-badge {
                font-size: 0.8rem;
                padding: 10px 16px;
            }
        }

        .workspace-hero p {
            font-size: 1.2rem;
            color: #94A3B8;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Progress Indicator */
        .progress-indicator {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            margin-bottom: 40px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #94A3B8;
            text-align: center;
        }

        /* Workspace Cards */
        .workspace-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .workspace-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .workspace-card.active {
            border-color: rgba(59, 130, 246, 0.4);
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.05), rgba(30, 41, 59, 0.9));
        }

        .workspace-card.hidden {
            display: none;
        }

        .workspace-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #F8FAFC;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #F8FAFC;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            color: #F8FAFC;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #60A5FA;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }

        .form-input::placeholder {
            color: #64748B;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            background: rgba(15, 23, 42, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .upload-zone:hover, .upload-zone.drag-over {
            border-color: #60A5FA;
            background: rgba(59, 130, 246, 0.05);
        }

        .upload-icon {
            font-size: 3rem;
            color: #60A5FA;
            margin-bottom: 16px;
        }

        .upload-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #F8FAFC;
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #94A3B8;
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* File List */
        .file-list {
            margin-top: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(15, 23, 42, 0.6);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-icon {
            color: #60A5FA;
            font-size: 1.2rem;
        }

        .file-details h4 {
            color: #F8FAFC;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .file-size {
            color: #94A3B8;
            font-size: 0.8rem;
        }

        .file-remove {
            background: none;
            border: none;
            color: #EF4444;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .file-remove:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Enhanced Professional Processing Animation */
        .processing-animation {
            text-align: center;
            padding: 40px;
            max-height: 200px; /* Limit height */
        }
        
        .ai-processor-compact {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .processor-core {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s ease-in-out infinite;
            position: relative;
        }
        
        .processor-core::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #3B82F6, #8B5CF6, #10B981, #3B82F6);
            border-radius: 14px;
            z-index: -1;
            animation: borderFlow 3s linear infinite;
            background-size: 400% 400%;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes borderFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .processor-icon {
            color: white;
            animation: rotate 4s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .processing-dots {
            display: flex;
            gap: 8px;
        }
        
        .dot {
            width: 8px;
            height: 8px;
            background: #60A5FA;
            border-radius: 50%;
            animation: dotPulse 1.5s ease-in-out infinite;
        }
        
        .dot:nth-child(1) { animation-delay: 0s; }
        .dot:nth-child(2) { animation-delay: 0.3s; }
        .dot:nth-child(3) { animation-delay: 0.6s; }
        
        @keyframes dotPulse {
            0%, 80%, 100% { opacity: 0.3; transform: scale(1); }
            40% { opacity: 1; transform: scale(1.2); }
        }
        
        .processing-status-compact h4 {
            color: #F8FAFC;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .processing-status-compact p {
            color: #94A3B8;
            font-size: 0.95rem;
        }

        .processing-steps {
            margin-top: 32px;
            max-width: 320px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .processing-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            color: #64748B;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .processing-step::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: rgba(59, 130, 246, 0.2);
            transition: all 0.5s ease;
        }
        
        .processing-step.active {
            color: #60A5FA;
            border-color: rgba(59, 130, 246, 0.3);
            background: rgba(59, 130, 246, 0.05);
            transform: translateX(8px);
        }
        
        .processing-step.active::before {
            background: linear-gradient(180deg, #60A5FA, #3B82F6);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        
        .processing-step.completed {
            color: #10B981;
            border-color: rgba(16, 185, 129, 0.3);
            background: rgba(16, 185, 129, 0.05);
        }
        
        .processing-step.completed::before {
            background: linear-gradient(180deg, #10B981, #059669);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        
        .step-indicator {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            flex-shrink: 0;
            transition: all 0.5s ease;
            background: rgba(15, 23, 42, 0.6);
        }
        
        .processing-step.active .step-indicator {
            background: rgba(59, 130, 246, 0.2);
            border-color: #60A5FA;
            animation: stepPulse 2s ease-in-out infinite;
        }
        
        .processing-step.completed .step-indicator {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10B981;
            animation: none;
        }
        
        @keyframes stepPulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 0 8px rgba(59, 130, 246, 0);
                transform: scale(1.05);
            }
        }
        
        .processing-step span {
            font-weight: 500;
            font-size: 0.85rem;
            letter-spacing: 0.02em;
        }

        /* Results Dashboard */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .result-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .result-card:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }

        .result-icon {
            font-size: 2rem;
            color: #60A5FA;
            margin-bottom: 16px;
        }

        .result-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #F8FAFC;
            margin-bottom: 8px;
        }

        .result-description {
            color: #94A3B8;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            color: white;
            border: 1px solid transparent;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: #94A3B8;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        .btn-secondary:hover {
            border-color: rgba(59, 130, 246, 0.5);
            color: #F8FAFC;
        }

        .btn-success {
            background: linear-gradient(135deg, #059669, #10B981);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 24px;
            border-top: 1px solid rgba(59, 130, 246, 0.1);
        }

        /* Report Tabs */
        .report-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 32px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #94A3B8;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            color: #60A5FA;
            border-bottom-color: #60A5FA;
        }
        
        .tab-btn:hover {
            color: #F8FAFC;
        }
        
        /* Report Container */
        .report-container {
            display: none;
        }
        
        .report-container.active {
            display: block;
        }
        
        .report-header {
            margin-bottom: 24px;
            text-align: center;
        }
        
        .report-header h4 {
            font-size: 1.3rem;
            color: #F8FAFC;
            margin-bottom: 8px;
        }
        
        .report-header p {
            color: #94A3B8;
            font-size: 0.9rem;
        }
        
        /* Financial Table */
        .financial-table {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .financial-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .financial-table th {
            background: rgba(59, 130, 246, 0.1);
            color: #F8FAFC;
            padding: 16px;
            font-weight: 600;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .financial-table td {
            padding: 12px 16px;
            color: #E2E8F0;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
        }
        
        .financial-table .section-header td {
            background: rgba(30, 41, 59, 0.8);
            color: #60A5FA;
            font-weight: 600;
            padding-top: 16px;
        }
        
        .financial-table .subtotal td {
            border-top: 1px solid rgba(59, 130, 246, 0.3);
            font-weight: 600;
            color: #F8FAFC;
        }
        
        .financial-table .total-line td {
            border-top: 2px solid #60A5FA;
            font-weight: 700;
            color: #60A5FA;
            font-size: 1.05rem;
            padding-top: 16px;
        }

        /* Export Toolbar */
        .export-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 24px;
        }
        
        .export-actions {
            display: flex;
            gap: 12px;
        }
        
        .export-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            font-size: 0.85rem;
        }
        
        .export-icon {
            font-size: 1rem;
        }
        
        .export-options {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .export-select {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            color: #F8FAFC;
            padding: 8px 12px;
            font-size: 0.85rem;
            min-width: 180px;
        }
        
        .export-select:focus {
            outline: none;
            border-color: #60A5FA;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
        }
        
        /* Loading state for export buttons */
        .export-btn.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .export-btn.loading::after {
            content: '';
            width: 12px;
            height: 12px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        .export-options {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        @media (max-width: 768px) {
            .export-options {
                justify-content: center;
                flex-wrap: wrap;
            }
        }
        
        @media (max-width: 768px) {
            .export-toolbar {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .export-actions {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .export-options {
                justify-content: center;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .workspace-hero h1 {
                font-size: 2.2rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .action-bar {
                flex-direction: column;
                gap: 16px;
            }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* History Modal */
        .history-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .history-modal.hidden {
            display: none;
        }
        
        .history-modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        
        .history-modal-content {
            position: relative;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .history-header h3 {
            color: #F8FAFC;
            font-size: 1.5rem;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #94A3B8;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
        }
        
        .history-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
        }
        
        .search-container {
            display: flex;
            gap: 8px;
            flex: 1;
            max-width: 300px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            color: #F8FAFC;
            font-size: 0.9rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #60A5FA;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
        }
        
        .search-btn {
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            border: none;
            color: white;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .search-btn:hover {
            transform: translateY(-1px);
        }
        
        .history-stats {
            color: #94A3B8;
            font-size: 0.9rem;
        }
        
        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 24px;
            max-height: 400px;
        }
        
        .history-item {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .history-item:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }
        
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .history-item-title {
            color: #F8FAFC;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .history-item-date {
            color: #94A3B8;
            font-size: 0.8rem;
        }
        
        .history-item-details {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            font-size: 0.85rem;
            color: #CBD5E1;
        }
        
        .history-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .history-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .history-btn-load {
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            color: white;
        }
        
        .history-btn-delete {
            background: transparent;
            color: #EF4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .history-btn-delete:hover {
            background: rgba(239, 68, 68, 0.1);
        }
        
        .history-actions {
            padding: 20px 24px;
            border-top: 1px solid rgba(59, 130, 246, 0.1);
            display: flex;
            justify-content: space-between;
        }
        
        .empty-history {
            text-align: center;
            padding: 40px;
            color: #94A3B8;
        }
        
        @media (max-width: 768px) {
            .history-modal-content {
                width: 95%;
                max-height: 90vh;
            }
            
            .history-controls {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .search-container {
                max-width: none;
            }
        }

        .quick-actions-bar {
            margin-bottom: 40px;
        }
        
        .quick-action-item {
            max-width: 400px;
            margin: 20px auto 40px auto; /* Centered with spacing */
        }
        
        .btn-quick-action {
            width: 100%;
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.05), rgba(30, 41, 59, 0.3));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .btn-quick-action:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }
        
        .quick-action-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        .quick-action-text {
            flex: 1;
        }
        
        .quick-action-title {
            color: #F8FAFC;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .quick-action-subtitle {
            color: #94A3B8;
            font-size: 0.85rem;
        }

        .generate-action { 
            margin-top: 32px; 
            text-align: center; 
            width: 100%;
            display: flex;
            justify-content: center;
        }
        
        .generate-container { 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }
        
        .btn-generate-premium {
            background: linear-gradient(135deg, #1E40AF 0%, #3B82F6 50%, #60A5FA 100%);
            border: none;
            border-radius: 12px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
            white-space: nowrap;
            color: white;
            margin-bottom: 16px;
        }
        
        .btn-generate-premium::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }
        
        .btn-generate-premium:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.4);
        }
        .btn-generate-premium:hover::before { left: 100%; }
        
        .btn-generate-icon {
            width: 28px; height: 28px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .btn-generate-content { 
            flex: 0 0 auto;
            text-align: center; 
        }
        
        .btn-generate-title {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .btn-generate-arrow {
            font-size: 1.2rem; 
            font-weight: bold;
            transition: transform 0.3s ease;
        }
        .btn-generate-premium:hover .btn-generate-arrow { transform: translateX(4px); }
        
        .generate-features {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .feature-badge {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            color: #60A5FA;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .feature-badge.coming-soon {
            background: rgba(75, 85, 99, 0.1);
            border-color: rgba(75, 85, 99, 0.2);
            color: #9CA3AF;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            border-radius: 3px;
            width: 0%;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .progress-text {
            font-size: 0.95rem;
            color: #94A3B8;
            text-align: center;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        /* Modern Processing Animation */
        .modern-processing-container {
            text-align: center;
            padding: 40px 20px;
            max-height: 400px;
        }
        
        .ai-processing-hub {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 32px;
        }
        
        .hub-core {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 20px auto;
            background: linear-gradient(135deg, #1E40AF 0%, #3B82F6 50%, #60A5FA 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.4);
            animation: hubFloat 3s ease-in-out infinite;
        }
        
        .core-icon {
            color: white;
            z-index: 2;
            animation: iconRotate 8s linear infinite;
        }
        
        .pulse-ring {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 100px;
            height: 100px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 25px;
            animation: pulseRing 2s ease-out infinite;
        }
        
        .pulse-ring-2 {
            position: absolute;
            top: -20px;
            left: -20px;
            width: 120px;
            height: 120px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 30px;
            animation: pulseRing 2s ease-out infinite 0.5s;
        }
        
        /* Status Text */
        .processing-status-modern {
            margin-bottom: 32px;
        }
        
        .processing-status-modern h4 {
            color: #F8FAFC;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.6s ease;
        }
        
        .processing-status-modern p {
            color: #94A3B8;
            font-size: 1rem;
            transition: all 0.6s ease;
        }
        
        /* Progress Segments */
        .progress-segments {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 24px;
        }
        
        .segment {
            width: 60px;
            height: 6px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 3px;
            position: relative;
            overflow: hidden;
        }
        
        .segment.active {
            background: linear-gradient(90deg, #1E40AF, #60A5FA);
            animation: segmentGlow 1.5s ease-in-out infinite alternate;
        }
        
        .segment.completed {
            background: linear-gradient(90deg, #10B981, #059669);
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.4);
        }
        
        /* Progress Percentage */
        .progress-percentage {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        #modernProgressPercent {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60A5FA, #10B981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s ease;
        }
        
        .progress-label {
            color: #94A3B8;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        /* Animations */
        @keyframes hubFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        
        @keyframes iconRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulseRing {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1.3);
                opacity: 0;
            }
        }
        
        @keyframes segmentGlow {
            0% { box-shadow: 0 0 8px rgba(59, 130, 246, 0.5); }
            100% { box-shadow: 0 0 16px rgba(59, 130, 246, 0.8), 0 0 24px rgba(59, 130, 246, 0.3); }
        }

        .security-notice {
            background: linear-gradient(145deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 40px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .security-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .security-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #10B981, #059669);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        .security-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .security-main {
            color: #10B981;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .security-detail {
            color: #6B7280;
            font-size: 0.85rem;
        }
        
        @media (max-width: 768px) {
            .security-notice {
                margin: 0 20px 40px 20px;
            }
        }

        .file-validation-success,
        .file-validation-error {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(15, 23, 42, 0.6);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #10B981;
            animation: slideInValidation 0.3s ease;
        }
        
        .file-validation-error {
            border-left-color: #EF4444;
        }
        
        @keyframes slideInValidation {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .validation-icon {
            width: 24px;
            height: 24px;
            background: #10B981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        .validation-icon.error {
            background: #EF4444;
        }
        
        .validation-text {
            flex: 1;
        }
        
        .validation-main {
            color: #10B981;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }
        
        .file-validation-error .validation-main {
            color: #EF4444;
        }
        
        .validation-details {
            color: #94A3B8;
            font-size: 0.8rem;
        }

        .actions-grid {
            display: flex;
            justify-content: center;
        }
        
        .security-quick-notice {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(16, 185, 129, 0.05);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 20px;
            padding: 8px 16px;
            color: #10B981;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .security-quick-notice .security-icon {
            width: 16px;
            height: 16px;
            color: #10B981;
        }
        
        .quick-action-item {
            flex: 1;
            max-width: 350px;
        }
        
        @media (max-width: 768px) {
            .actions-grid {
                flex-direction: column;
                align-items: stretch;
            }
            
            .security-quick-notice {
                justify-content: center;
                margin-bottom: 16px;
            }
        }

        .hero-cta {
            margin-bottom: 40px;
            margin-top: 50px;
        }
        
        .btn-hero-start {
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        
        .btn-hero-start:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.4);
        }
        
        .btn-hero-start svg {
            transition: transform 0.3s ease;
        }
        
        .btn-hero-start:hover svg {
            transform: translateX(4px);
        }

        .form-input[type="month"] {
            cursor: pointer;
            position: relative;
        }
        
        .form-input[type="date"] {
            cursor: pointer;
        }
        
        .form-input[type="month"]::-webkit-calendar-picker-indicator,
        .form-input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .form-group {
            position: relative;
        }
        
        .form-group[data-clickable="true"] {
            cursor: pointer;
        }
        
        .form-group[data-clickable="true"]:hover .form-input {
            border-color: #60A5FA;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation Header -->
        <nav class="top-nav">
            <div class="nav-container">
                <div class="nav-brand">
                    <div class="brand-icon"><img src="logo.png" alt="MontPro Logo"></div>
                    <span class="brand-text">MontPro Financier - Generator</span>
                </div>
                <div class="nav-links">
                    <a href="https://financier.montpro.xyz" class="nav-link">← Back to Home</a>
                    <button class="btn-nav-cta" onclick="showHistoryModal()">Load Previous Analysis</button>
                </div>
            </div>
        </nav>
        
        <!-- Enhanced Workspace Hero -->
        <div class="workspace-hero" data-aos="fade-up">
            <!-- Trust Badge -->
            <div class="trust-badge">
                <div class="trust-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        <path d="m9 12 2 2 4-4"/>
                    </svg>
                </div>
                <span>Bank-Grade Security • SOC 2 Compliant • Zero Data Retention</span>
            </div>
        
            <!-- Main Hero Content -->
            <h1>Financial Intelligence Workspace</h1>
            <p class="hero-description">
                Replace weeks of manual work with minutes of AI precision. Generate 
                <strong>bank-approved financial statements</strong> that unlock financing opportunities, 
                processed securely with <strong>automatic data deletion</strong> after delivery.
            </p>
        
            <!-- CTA Button -->
            <div class="hero-cta">
                <button class="btn-hero-start" onclick="scrollToForms()">
                    <span>Start Generating</span>
                </button>
            </div>
        </div>

        <!-- Progress Indicator -->
        <div class="progress-indicator" data-aos="fade-up" data-aos-delay="100">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Step 1 of 4: Company Information</div>
        </div>

        <!-- Workspace Container -->
        <div class="workspace-container">
            
            <!-- Company Profile Card -->
            <div class="workspace-card active" id="companyCard" data-aos="fade-up" data-aos-delay="200">
                <h3>
                    <span class="card-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"></svg>
                    </span>
                    Executive Summary
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="companyName">Company Name</label>
                        <input type="text" id="companyName" class="form-input" placeholder="e.g. Acme Industries Ltd.">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="industry">Industry</label>
                        <select id="industry" class="form-select">
                            <option value="">Select industry</option>
                            <option value="manufacturing">Manufacturing</option>
                            <option value="retail">Retail & Trade</option>
                            <option value="services">Professional Services</option>
                            <option value="technology">Technology</option>
                            <option value="construction">Construction</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="businessSize">Business Size</label>
                        <select id="businessSize" class="form-select">
                            <option value="">Select size</option>
                            <option value="micro">Micro (1-10 employees)</option>
                            <option value="small">Small (11-50 employees)</option>
                            <option value="medium">Medium (51-250 employees)</option>
                            <option value="big">Big (250+ employees)</option>
                        </select>
                    </div>
                    <div class="form-group" data-clickable="true" onclick="openMonthPicker(this)">
                        <label class="form-label" for="reportingPeriod">Reporting Period</label>
                        <input type="month" id="reportingPeriod" class="form-input" max="2025-06">
                    </div>
                </div>
            </div>

            <!-- Document Upload Card -->
            <div class="workspace-card hidden" id="uploadCard">
                <h3>
                    <span class="card-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"></svg>
                    </span>
                    Document Processing
                </h3>
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">📄</div>
                    <div class="upload-text">Drag & drop your bank statements here</div>
                    <div class="upload-hint">Click to browse. We only accept PDF files for your security.</div>
                    <input type="file" class="file-input" id="fileInput" multiple accept=".pdf">
                </div>
                <div class="file-list" id="fileList"></div>

                <div class="generate-action" id="uploadActions" style="display: none;">
                    <div class="generate-container">
                        <button class="btn-generate-premium" id="generateBtn" onclick="startAnalysis()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="4" y="4" width="16" height="16" rx="2"/>
                                <rect x="9" y="9" width="6" height="6"/>
                                <line x1="9" y1="1" x2="9" y2="4"/>
                                <line x1="15" y1="1" x2="15" y2="4"/>
                                <line x1="9" y1="20" x2="9" y2="23"/>
                                <line x1="15" y1="20" x2="15" y2="23"/>
                                <line x1="20" y1="9" x2="23" y2="9"/>
                                <line x1="20" y1="14" x2="23" y2="14"/>
                                <line x1="1" y1="9" x2="4" y2="9"/>
                                <line x1="1" y1="14" x2="4" y2="14"/>
                            </svg>
                            <span class="btn-generate-title">Generate Financial Statements</span>
                            <span class="btn-generate-arrow">→</span>
                        </button>
                        <div class="generate-features">
                            <div class="feature-badge">✓ Income Statement</div>
                            <div class="feature-badge">✓ Balance Sheet</div>
                            <div class="feature-badge">✓ Cash Flow</div>
                            <div class="feature-badge coming-soon">Working Capital (Coming Soon)</div>
                            <div class="feature-badge coming-soon">Financial Ratios (Coming Soon)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Processing Card -->
            <div class="workspace-card hidden" id="processingCard">
                <h3>
                    <span class="card-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"></svg>
                    </span>
                    Intelligence Processing
                </h3>
                
                <!-- Modern Processing Animation -->
                <div class="modern-processing-container">
                    <!-- Central AI Hub -->
                    <div class="ai-processing-hub">
                        <div class="hub-core">
                            <div class="core-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="4" y="4" width="16" height="16" rx="2"/>
                                    <rect x="9" y="9" width="6" height="6"/>
                                    <line x1="9" y1="1" x2="9" y2="4"/>
                                    <line x1="15" y1="1" x2="15" y2="4"/>
                                    <line x1="9" y1="20" x2="9" y2="23"/>
                                    <line x1="15" y1="20" x2="15" y2="23"/>
                                    <line x1="20" y1="9" x2="23" y2="9"/>
                                    <line x1="20" y1="14" x2="23" y2="14"/>
                                    <line x1="1" y1="9" x2="4" y2="9"/>
                                    <line x1="1" y1="14" x2="4" y2="14"/>
                                </svg>
                            </div>
                            <div class="pulse-ring"></div>
                            <div class="pulse-ring-2"></div>
                        </div>
                    </div>
                    
                    <!-- Status Display -->
                    <div class="processing-status-modern">
                        <h4 id="modernProcessingTitle">Initializing AI Analysis...</h4>
                        <p id="modernProcessingSubtitle">Preparing your financial intelligence engine</p>
                    </div>
                    
                    <!-- Progress Segments -->
                    <div class="progress-segments">
                        <div class="segment segment-1"></div>
                        <div class="segment segment-2"></div>
                        <div class="segment segment-3"></div>
                        <div class="segment segment-4"></div>
                    </div>
                    
                    <!-- Progress Percentage -->
                    <div class="progress-percentage">
                        <span id="modernProgressPercent">0%</span>
                        <span class="progress-label">Complete</span>
                    </div>
                </div>
            </div>

            <!-- Results Card -->
            <div class="workspace-card hidden" id="resultsCard">
                <h3>
                    <span class="card-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"></svg>
                    </span>
                    Financial Intelligence Dashboard
                </h3>
                
                <!-- Report Navigation Tabs -->
                <div class="report-tabs">
                    <button class="tab-btn active" onclick="showReport('income')">Income Statement</button>
                    <button class="tab-btn" onclick="showReport('balance')">Balance Sheet</button>
                    <button class="tab-btn" onclick="showReport('cashflow')">Cash Flow Statement</button>
                </div>
            
                <!-- Income Statement Report -->
                <div class="report-container active" id="incomeReport">
                    <div class="report-header">
                        <h4>Income Statement</h4>
                        <p>For the period ending <span id="reportPeriod1">December 2024</span></p>
                    </div>
                    <div class="financial-table">
                        <table>
                            <thead>
                                <tr>
                                    <th style="text-align: left;">Item</th>
                                    <th style="text-align: right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="section-header">
                                    <td><strong>Revenue</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Sales Revenue</td>
                                    <td style="text-align: right;">$125,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Service Revenue</td>
                                    <td style="text-align: right;">$45,000</td>
                                </tr>
                                <tr class="subtotal">
                                    <td><strong>Total Revenue</strong></td>
                                    <td style="text-align: right;"><strong>$170,000</strong></td>
                                </tr>
                                <tr class="section-header">
                                    <td><strong>Expenses</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Cost of Goods Sold</td>
                                    <td style="text-align: right;">$65,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Operating Expenses</td>
                                    <td style="text-align: right;">$45,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Interest Expense</td>
                                    <td style="text-align: right;">$2,500</td>
                                </tr>
                                <tr class="subtotal">
                                    <td><strong>Total Expenses</strong></td>
                                    <td style="text-align: right;"><strong>$112,500</strong></td>
                                </tr>
                                <tr class="total-line">
                                    <td><strong>Net Income</strong></td>
                                    <td style="text-align: right;"><strong>$57,500</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            
                <!-- Balance Sheet Report -->
                <div class="report-container" id="balanceReport">
                    <div class="report-header">
                        <h4>Balance Sheet</h4>
                        <p>As of <span id="reportPeriod2">December 31, 2024</span></p>
                    </div>
                    <div class="financial-table">
                        <table>
                            <thead>
                                <tr>
                                    <th style="text-align: left;">Item</th>
                                    <th style="text-align: right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="section-header">
                                    <td><strong>Assets</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Cash and Cash Equivalents</td>
                                    <td style="text-align: right;">$85,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Accounts Receivable</td>
                                    <td style="text-align: right;">$35,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Inventory</td>
                                    <td style="text-align: right;">$25,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Property, Plant & Equipment</td>
                                    <td style="text-align: right;">$120,000</td>
                                </tr>
                                <tr class="subtotal">
                                    <td><strong>Total Assets</strong></td>
                                    <td style="text-align: right;"><strong>$265,000</strong></td>
                                </tr>
                                <tr class="section-header">
                                    <td><strong>Liabilities</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Accounts Payable</td>
                                    <td style="text-align: right;">$15,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Short-term Debt</td>
                                    <td style="text-align: right;">$25,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Long-term Debt</td>
                                    <td style="text-align: right;">$80,000</td>
                                </tr>
                                <tr class="subtotal">
                                    <td><strong>Total Liabilities</strong></td>
                                    <td style="text-align: right;"><strong>$120,000</strong></td>
                                </tr>
                                <tr class="section-header">
                                    <td><strong>Equity</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Owner's Capital</td>
                                    <td style="text-align: right;">$87,500</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Retained Earnings</td>
                                    <td style="text-align: right;">$57,500</td>
                                </tr>
                                <tr class="subtotal">
                                    <td><strong>Total Equity</strong></td>
                                    <td style="text-align: right;"><strong>$145,000</strong></td>
                                </tr>
                                <tr class="total-line">
                                    <td><strong>Total Liabilities & Equity</strong></td>
                                    <td style="text-align: right;"><strong>$265,000</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            
                <!-- Cash Flow Statement Report -->
                <div class="report-container" id="cashflowReport">
                    <div class="report-header">
                        <h4>Cash Flow Statement</h4>
                        <p>For the period ending <span id="reportPeriod3">December 2024</span></p>
                    </div>
                    <div class="financial-table">
                        <table>
                            <thead>
                                <tr>
                                    <th style="text-align: left;">Item</th>
                                    <th style="text-align: right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="section-header">
                                    <td><strong>Operating Activities</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Net Income</td>
                                    <td style="text-align: right;">$57,500</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Depreciation</td>
                                    <td style="text-align: right;">$8,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Changes in Working Capital</td>
                                    <td style="text-align: right;">($5,000)</td>
                                </tr>
                                <tr class="subtotal">
                                    <td><strong>Net Cash from Operating</strong></td>
                                    <td style="text-align: right;"><strong>$60,500</strong></td>
                                </tr>
                                <tr class="section-header">
                                    <td><strong>Investing Activities</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Equipment Purchase</td>
                                    <td style="text-align: right;">($15,000)</td>
                                </tr>
                                <tr class="subtotal">
                                    <td><strong>Net Cash from Investing</strong></td>
                                    <td style="text-align: right;"><strong>($15,000)</strong></td>
                                </tr>
                                <tr class="section-header">
                                    <td><strong>Financing Activities</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Loan Repayment</td>
                                    <td style="text-align: right;">($10,000)</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Owner Contributions</td>
                                    <td style="text-align: right;">$15,000</td>
                                </tr>
                                <tr class="subtotal">
                                    <td><strong>Net Cash from Financing</strong></td>
                                    <td style="text-align: right;"><strong>$5,000</strong></td>
                                </tr>
                                <tr class="total-line">
                                    <td><strong>Net Change in Cash</strong></td>
                                    <td style="text-align: right;"><strong>$50,500</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Export Toolbar -->
            <div class="export-toolbar">
                <div class="export-actions">
                    <button class="btn btn-secondary export-btn" onclick="exportReport('pdf')">
                        <span class="export-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10,9 9,9 8,9"/>
                            </svg>
                        </span>
                        Export to PDF
                    </button>
                    <button class="btn btn-secondary export-btn" onclick="exportReport('csv')">
                        <span class="export-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="9" y1="13" x2="15" y2="13"/>
                                <line x1="9" y1="17" x2="15" y2="17"/>
                            </svg>
                        </span>
                        Export to CSV
                    </button>
                </div>
                <div class="export-options">
                    <select class="export-select" id="currencySelect" onchange="changeCurrency()">
                        <option value="IDR">Indonesian Rupiah (Rp)</option>
                        <option value="USD">US Dollar ($)</option>
                        <option value="EUR">Euro (€)</option>
                        <option value="SGD">Singapore Dollar (S$)</option>
                    </select>
                    <select class="export-select" id="exportScope">
                        <option value="current">Current Report Only</option>
                        <option value="all">All Financial Statements</option>
                    </select>
                </div>
            </div>

            <div class="action-bar">
                <button class="btn btn-secondary" onclick="scrollToForms()">Generate New Report</button>
                <button class="btn btn-primary">Analyze Creditworthiness →</button>
            </div>
            
        </div>
    </div>

    <!-- AOS Script -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({
            duration: 750,
            once: false,
        });
    </script>

    <script>
        // Progressive form logic
        let currentStep = 1;
        let uploadedFiles = [];

        // Elements
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const companyCard = document.getElementById('companyCard');
        const uploadCard = document.getElementById('uploadCard');
        const processingCard = document.getElementById('processingCard');
        const resultsCard = document.getElementById('resultsCard');

        // Form validation and progression
        function validateCompanyInfo() {
            const companyName = document.getElementById('companyName').value.trim();
            const industry = document.getElementById('industry').value;
            const businessSize = document.getElementById('businessSize').value;
            const reportingPeriod = document.getElementById('reportingPeriod').value;
            
            return companyName && industry && businessSize && reportingPeriod;
        }
        
        function updateProgress(step) {
            const progressPercentages = [25, 50, 75, 100];
            const progressTexts = [
                'Step 1 of 4: Company Information',
                'Step 2 of 4: Document Upload',
                'Step 3 of 4: Processing Data',
                'Step 4 of 4: Results Ready'
            ];
            
            progressFill.style.width = progressPercentages[step - 1] + '%';
            progressText.textContent = progressTexts[step - 1];
        }

        // Enhanced Progress System
        let progressInterval;
        let currentProgress = 0;
        let progressSpeed = 1;
        
        function startSatisfyingProgress() {
            currentProgress = 0;
            progressSpeed = 1;
            
            // Calculate total estimated time based on uploaded files
            const totalSize = uploadedFiles.reduce((sum, file) => sum + file.size, 0);
            const totalSizeMB = totalSize / 1024 / 1024;
            
            let estimatedSeconds;
            if (totalSizeMB < 5) {
                estimatedSeconds = 30;
            } else if (totalSizeMB < 10) {
                estimatedSeconds = 60;
            } else {
                estimatedSeconds = 90;
            }
            
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            // Add smooth CSS transition
            progressFill.style.transition = 'width 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
            
            let timeRemaining = estimatedSeconds;
            
            progressInterval = setInterval(() => {
                if (currentProgress < 95) {
                    // Variable speed logic (same as before)
                    if (currentProgress < 20) {
                        progressSpeed = 0.5 + Math.random() * 1;
                    } else if (currentProgress < 70) {
                        progressSpeed = 1.5 + Math.random() * 2;
                    } else {
                        progressSpeed = 0.3 + Math.random() * 0.5;
                    }
                    
                    currentProgress += progressSpeed;
                    currentProgress = Math.min(currentProgress, 95);
                    
                    // Update time remaining
                    timeRemaining = Math.max(0, Math.round(estimatedSeconds * (1 - currentProgress / 100)));
                    
                    progressFill.style.width = currentProgress + '%';
                    
                    // Dynamic text with time estimates
                    const roundedProgress = Math.round(currentProgress);
                    let statusText = '';
                    
                    if (currentProgress < 25) {
                        statusText = 'Reading your bank statements...';
                    } else if (currentProgress < 50) {
                        statusText = 'Analyzing transaction patterns...';
                    } else if (currentProgress < 75) {
                        statusText = 'Building financial statements...';
                    } else {
                        statusText = 'Applying finishing touches...';
                    }
                    
                    progressText.textContent = `${roundedProgress}% Complete - ${statusText} (${timeRemaining}s remaining)`;
                    
                    // Milestone effects (same as before)
                    if (roundedProgress === 25 || roundedProgress === 50 || roundedProgress === 75) {
                        progressFill.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.6)';
                        setTimeout(() => {
                            progressFill.style.boxShadow = 'none';
                        }, 500);
                    }
                }
            }, 400);
        }
        
        function completeProgressSatisfying() {
            clearInterval(progressInterval);
            
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            // Dramatic completion
            progressFill.style.transition = 'width 1.2s cubic-bezier(0.2, 0, 0, 1)';
            progressFill.style.width = '100%';
            progressText.textContent = '100% Complete - Your financial statements are ready! ✨';
            
            // Success glow effect
            progressFill.style.background = 'linear-gradient(135deg, #10B981, #059669)';
            progressFill.style.boxShadow = '0 0 30px rgba(16, 185, 129, 0.5)';
            
            // Reset after a moment
            setTimeout(() => {
                progressFill.style.background = 'linear-gradient(135deg, #1E40AF, #60A5FA)';
                progressFill.style.boxShadow = 'none';
            }, 2000);
        }

        function showCard(card) {
            card.classList.remove('hidden');
            card.classList.add('active');
            setTimeout(() => {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        // Company info validation
        document.addEventListener('input', (e) => {
            if (['companyName', 'industry', 'businessSize', 'reportingPeriod'].includes(e.target.id)) {
                if (validateCompanyInfo() && currentStep === 1) {
                    currentStep = 2;
                    updateProgress(2);
                    setTimeout(() => showCard(uploadCard), 500);
                }
            }
        });

        // File upload handling - CORRECTED VERSION
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        
        // Only trigger file input on click, not the zone
        uploadZone.addEventListener('click', (e) => {
            // Prevent triggering if clicking on the input itself
            if (e.target !== fileInput) {
                fileInput.click();
            }
        });
        
        // Remove the existing change listener and replace with this
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFiles(e.target.files);
                // Clear the input to allow same file to be selected again
                e.target.value = '';
            }
        });
        
        // Drag and drop (keep as is)
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        function handleFiles(files) {
            const pdfFiles = Array.from(files).filter(file => file.type === 'application/pdf');
            
            if (pdfFiles.length === 0) {
                showFileError('Only PDF files are accepted for bank statements.');
                return;
            }
            
            // Process each file with validation
            pdfFiles.forEach(file => {
                validateAndAddFile(file);
            });
            
            // Show generate button if we have valid files
            if (uploadedFiles.length > 0) {
                document.getElementById('uploadActions').style.display = 'block';
            }
        }
        
        function validateAndAddFile(file) {
            const fileSize = file.size;
            const fileSizeMB = (fileSize / 1024 / 1024).toFixed(1);
            
            // Basic PDF validation (you can enhance this)
            const isValidSize = fileSize > 1000 && fileSize < 50 * 1024 * 1024; // 1KB to 50MB
            
            if (!isValidSize) {
                showFileError(`File "${file.name}" is too large or too small. Please upload files between 1KB and 50MB.`);
                return;
            }
            
            // Add to uploaded files
            uploadedFiles.push(file);
            
            // Show immediate validation feedback
            showFileValidation(file, fileSizeMB);
            
            // Update file list
            updateFileList();
        }
        
        function showFileValidation(file, fileSizeMB) {
            const fileName = file.name;
            const fileSize = file.size;
            
            // Estimate processing time
            let estimatedTime;
            if (fileSize < 5 * 1024 * 1024) { // < 5MB
                estimatedTime = '~30 seconds';
            } else if (fileSize < 10 * 1024 * 1024) { // 5-10MB
                estimatedTime = '~60 seconds';
            } else {
                estimatedTime = '~90 seconds';
            }
            
            // Create validation notification
            const notification = document.createElement('div');
            notification.className = 'file-validation-success';
            notification.innerHTML = `
                <div class="validation-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20,6 9,17 4,12"/>
                    </svg>
                </div>
                <div class="validation-text">
                    <div class="validation-main">✓ Valid bank statement detected</div>
                    <div class="validation-details">PDF, ${fileSizeMB}MB • Est. processing: ${estimatedTime}</div>
                </div>
            `;
            
            // Add to file list (it will be replaced by updateFileList, but shows immediate feedback)
            document.getElementById('fileList').appendChild(notification);
            
            // Remove after file list updates
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }
        
        function showFileError(message) {
            const notification = document.createElement('div');
            notification.className = 'file-validation-error';
            notification.innerHTML = `
                <div class="validation-icon error">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                </div>
                <div class="validation-text">
                    <div class="validation-main">⚠ Upload Error</div>
                    <div class="validation-details">${message}</div>
                </div>
            `;
            
            document.getElementById('fileList').appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        function startAnalysis() {
            if (uploadedFiles.length === 0) {
                alert('Please upload at least one bank statement to continue.');
                return;
            }
            
            // Reset processing animation state
            resetProcessingAnimation();
            
            // Prepare form data
            const formData = new FormData();
            
            // Add company information
            formData.append('companyName', document.getElementById('companyName').value);
            formData.append('industry', document.getElementById('industry').value);
            formData.append('businessSize', document.getElementById('businessSize').value);
            formData.append('reportingPeriod', document.getElementById('reportingPeriod').value);
            
            // Add files
            uploadedFiles.forEach((file, index) => {
                formData.append(`bankStatement_${index}`, file);
            });
            
            // Add metadata
            formData.append('timestamp', new Date().toISOString());
            formData.append('totalFiles', uploadedFiles.length);
            
            // Start UI processing
            currentStep = 3;
            updateProgress(3);
            showCard(processingCard);
        
            startSatisfyingProgress();
            startModernProcessing();
            
            // Send to backend
            sendToBackend(formData);
        }

        function resetProcessingAnimation() {
            // Reset the processing animation to initial state
            const processingAnimation = document.querySelector('.processing-animation');
            if (processingAnimation) {
                processingAnimation.innerHTML = `
                    <div class="ai-processor-compact">
                        <div class="processor-core">
                            <div class="processor-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="4" y="4" width="16" height="16" rx="2"/>
                                    <rect x="9" y="9" width="6" height="6"/>
                                    <line x1="9" y1="1" x2="9" y2="4"/>
                                    <line x1="15" y1="1" x2="15" y2="4"/>
                                    <line x1="9" y1="20" x2="9" y2="23"/>
                                    <line x1="15" y1="20" x2="15" y2="23"/>
                                    <line x1="20" y1="9" x2="23" y2="9"/>
                                    <line x1="20" y1="14" x2="23" y2="14"/>
                                    <line x1="1" y1="9" x2="4" y2="9"/>
                                    <line x1="1" y1="14" x2="4" y2="14"/>
                                </svg>
                            </div>
                        </div>
                        <div class="processing-dots">
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                        </div>
                    </div>
                    <div class="processing-status-compact">
                        <h4>AI Processing Your Financial Data</h4>
                        <p>Analyzing transaction patterns and building statements...</p>
                    </div>
                `;
            }
            
            // Reset all processing steps to initial state
            const steps = document.querySelectorAll('.processing-step');
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed');
                step.querySelector('.step-indicator').textContent = index + 1;
            });
            
            // Clear any existing intervals
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            if (window.processingInterval) {
                clearInterval(window.processingInterval);
            }
            
            // Reset progress variables
            currentProgress = 0;
            progressSpeed = 1;
        }
        
        async function sendToBackend(formData) {
            try {
                const response = await fetch('https://montpro.app.n8n.cloud/webhook/financier-generator', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                handleBackendResponse(result);
                
            } catch (error) {
                console.error('Backend error:', error);
                alert('Error processing your files. Please try again.');
                // Reset to upload step
                currentStep = 2;
                updateProgress(2);
            }
        }
        
        function handleBackendResponse(data) {
            completeProgressSatisfying();
            // Stop the processing animation immediately
            if (window.processingInterval) {
                clearInterval(window.processingInterval);
            }
            
            // Replace spinner with success checkmark
            const processingAnimation = document.querySelector('.processing-animation');
            if (processingAnimation) {
                processingAnimation.innerHTML = `
                    <div style="width: 60px; height: 60px; background: #10B981; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; color: white; font-size: 1.5rem;">
                        ✓
                    </div>
                    <h4 style="color: #10B981; margin-bottom: 16px;">Processing Complete!</h4>
                    <p style="color: #94A3B8;">Your financial statements are ready</p>
                `;
            }
            
            // Complete all processing steps instantly
            const steps = document.querySelectorAll('.processing-step');
            steps.forEach(step => {
                step.classList.remove('active');
                step.classList.add('completed');
                step.querySelector('.step-indicator').textContent = '✓';
            });
            
            // Handle array response format from your backend
            const result = Array.isArray(data) ? data[0] : data;
            
            if (result.status === 'processing') {
                // Backend is still processing, poll for updates
                pollForResults(result.jobId);
            } else if (result.status === 'complete') {
                // Parse the JSON strings from backend into objects
                const financialStatements = {
                    incomeStatement: JSON.parse(result.financialStatements.incomeStatement).incomeStatement,
                    balanceSheet: JSON.parse(result.financialStatements.balanceSheet).balanceSheet,
                    cashFlow: JSON.parse(result.financialStatements.cashFlow).cashFlow
                };
                
                // Processing complete, show results
                populateResults(financialStatements);
                saveAnalysis(financialStatements);
                
                currentStep = 4;
                updateProgress(4);
                setTimeout(() => {
                    showCard(resultsCard);
                    // Hide completed steps after results are shown
                    hideCompletedSteps();
                }, 500);
            }
        }

        function populateResults(financialStatements) {
            window.currentFinancialData = financialStatements;
            // Update company info in report headers
            const reportingPeriod = document.getElementById('reportingPeriod').value;
            const periodText = formatReportingPeriod(reportingPeriod);
            
            document.getElementById('reportPeriod1').textContent = periodText;
            document.getElementById('reportPeriod2').textContent = periodText;
            document.getElementById('reportPeriod3').textContent = periodText;
            
            // Populate each statement
            populateIncomeStatement(financialStatements.incomeStatement);
            populateBalanceSheet(financialStatements.balanceSheet);
            populateCashFlowStatement(financialStatements.cashFlow);
        }
        
        function formatReportingPeriod(period) {
            const periodMap = {
                'jan-2025': 'January 2025',
                'dec-2024': 'December 2024',
                'nov-2024': 'November 2024',
                'oct-2024': 'October 2024',
                'sep-2024': 'September 2024',
                'aug-2024': 'August 2024'
            };
            return periodMap[period] || period;
        }
        
        function formatCurrency(amount) {
            const currency = document.getElementById('currencySelect').value;
            
            const formatOptions = {
                'IDR': { locale: 'id-ID', currency: 'IDR' },
                'USD': { locale: 'en-US', currency: 'USD' },
                'EUR': { locale: 'de-DE', currency: 'EUR' },
                'SGD': { locale: 'en-SG', currency: 'SGD' }
            };
            
            const config = formatOptions[currency] || formatOptions['IDR'];
            
            return new Intl.NumberFormat(config.locale, {
                style: 'currency',
                currency: config.currency,
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function changeCurrency() {
            // Re-populate all visible reports with new currency
            const activeReport = document.querySelector('.report-container.active');
            if (!activeReport) return;
            
            // Get the stored financial data (we need to store this globally)
            if (window.currentFinancialData) {
                populateResults(window.currentFinancialData);
            }
        }
        
        function populateIncomeStatement(incomeData) {
            const incomeTable = document.querySelector('#incomeReport tbody');
            
            // Calculate totals
            const totalRevenue = incomeData.revenue.reduce((sum, item) => sum + item.amount, 0);
            const totalExpenses = incomeData.expenses.reduce((sum, item) => sum + item.amount, 0);
            const netIncome = incomeData.netIncome || (totalRevenue - totalExpenses);
            
            incomeTable.innerHTML = `
                <tr class="section-header">
                    <td><strong>Revenue</strong></td>
                    <td></td>
                </tr>
                ${incomeData.revenue
                    .filter(item => item.amount > 0)
                    .map(item => `
                        <tr>
                            <td>&nbsp;&nbsp;${item.item}</td>
                            <td style="text-align: right;">${formatCurrency(item.amount)}</td>
                        </tr>
                    `).join('')}
                <tr class="subtotal">
                    <td><strong>Total Revenue</strong></td>
                    <td style="text-align: right;"><strong>${formatCurrency(totalRevenue)}</strong></td>
                </tr>
                <tr class="section-header">
                    <td><strong>Expenses</strong></td>
                    <td></td>
                </tr>
                ${incomeData.expenses
                    .filter(item => item.amount > 0)
                    .map(item => `
                        <tr>
                            <td>&nbsp;&nbsp;${item.item}</td>
                            <td style="text-align: right;">${formatCurrency(item.amount)}</td>
                        </tr>
                    `).join('')}
                <tr class="subtotal">
                    <td><strong>Total Expenses</strong></td>
                    <td style="text-align: right;"><strong>${formatCurrency(totalExpenses)}</strong></td>
                </tr>
                <tr class="total-line">
                    <td><strong>Net Income</strong></td>
                    <td style="text-align: right;"><strong>${formatCurrency(netIncome)}</strong></td>
                </tr>
            `;
        }
        
        function populateBalanceSheet(balanceData) {
            const balanceTable = document.querySelector('#balanceReport tbody');
            
            // Calculate totals
            const totalAssets = balanceData.assets.reduce((sum, item) => sum + item.amount, 0);
            const totalLiabilities = balanceData.liabilities.reduce((sum, item) => sum + item.amount, 0);
            const totalEquity = balanceData.equity.reduce((sum, item) => sum + item.amount, 0);
            
            // Calculate missing equity if needed
            const calculatedEquity = totalAssets - totalLiabilities;
            const displayEquity = totalEquity > 0 ? totalEquity : calculatedEquity;
            
            balanceTable.innerHTML = `
                <tr class="section-header">
                    <td><strong>Assets</strong></td>
                    <td></td>
                </tr>
                ${balanceData.assets
                    .filter(item => item.amount > 0)
                    .map(item => `
                        <tr>
                            <td>&nbsp;&nbsp;${item.item}</td>
                            <td style="text-align: right;">${formatCurrency(item.amount)}</td>
                        </tr>
                    `).join('')}
                <tr class="subtotal">
                    <td><strong>Total Assets</strong></td>
                    <td style="text-align: right;"><strong>${formatCurrency(totalAssets)}</strong></td>
                </tr>
                <tr class="section-header">
                    <td><strong>Liabilities</strong></td>
                    <td></td>
                </tr>
                ${balanceData.liabilities
                    .filter(item => item.amount > 0)
                    .map(item => `
                        <tr>
                            <td>&nbsp;&nbsp;${item.item}</td>
                            <td style="text-align: right;">${formatCurrency(item.amount)}</td>
                        </tr>
                    `).join('')}
                <tr class="subtotal">
                    <td><strong>Total Liabilities</strong></td>
                    <td style="text-align: right;"><strong>${formatCurrency(totalLiabilities)}</strong></td>
                </tr>
                <tr class="section-header">
                    <td><strong>Equity</strong></td>
                    <td></td>
                </tr>
                ${totalEquity > 0 ? 
                    balanceData.equity
                        .filter(item => item.amount > 0)
                        .map(item => `
                            <tr>
                                <td>&nbsp;&nbsp;${item.item}</td>
                                <td style="text-align: right;">${formatCurrency(item.amount)}</td>
                            </tr>
                        `).join('') 
                    : 
                    `<tr>
                        <td>&nbsp;&nbsp;Calculated Equity</td>
                        <td style="text-align: right;">${formatCurrency(calculatedEquity)}</td>
                    </tr>`
                }
                <tr class="subtotal">
                    <td><strong>Total Equity</strong></td>
                    <td style="text-align: right;"><strong>${formatCurrency(displayEquity)}</strong></td>
                </tr>
                <tr class="total-line">
                    <td><strong>Total Liabilities & Equity</strong></td>
                    <td style="text-align: right;"><strong>${formatCurrency(totalLiabilities + displayEquity)}</strong></td>
                </tr>
            `;
        }
        
        function populateCashFlowStatement(cashFlowData) {
            const cashFlowTable = document.querySelector('#cashflowReport tbody');
            
            // Calculate section totals
            const netOperating = cashFlowData.operating.reduce((sum, item) => sum + item.amount, 0);
            const netInvesting = cashFlowData.investing.reduce((sum, item) => sum + item.amount, 0);
            const netFinancing = cashFlowData.financing.reduce((sum, item) => sum + item.amount, 0);
            
            // Use backend values if available, otherwise calculate
            const beginningBalance = cashFlowData.beginningBalance || 0;
            const netCashChange = cashFlowData.netChangeInCash || (netOperating + netInvesting + netFinancing);
            const endingBalance = cashFlowData.endingBalance || (beginningBalance + netCashChange);
            
            cashFlowTable.innerHTML = `
                <tr class="section-header">
                    <td><strong>Beginning Cash Balance</strong></td>
                    <td style="text-align: right;"><strong>${formatCurrency(beginningBalance)}</strong></td>
                </tr>
                <tr><td colspan="2" style="height: 12px;"></td></tr>
                
                <tr class="section-header">
                    <td><strong>Operating Activities</strong></td>
                    <td></td>
                </tr>
                ${cashFlowData.operating
                    .filter(item => item.amount !== 0)
                    .map(item => `
                        <tr>
                            <td>&nbsp;&nbsp;${item.item}</td>
                            <td style="text-align: right;">${formatCurrency(item.amount)}</td>
                        </tr>
                    `).join('')}
                <tr class="subtotal">
                    <td><strong>Net Cash from Operating</strong></td>
                    <td style="text-align: right;"><strong>${formatCurrency(netOperating)}</strong></td>
                </tr>
                
                <tr class="section-header">
                    <td><strong>Investing Activities</strong></td>
                    <td></td>
                </tr>
                ${cashFlowData.investing
                    .filter(item => item.amount !== 0)
                    .map(item => `
                        <tr>
                            <td>&nbsp;&nbsp;${item.item}</td>
                            <td style="text-align: right;">${formatCurrency(item.amount)}</td>
                        </tr>
                    `).join('')}
                <tr class="subtotal">
                    <td><strong>Net Cash from Investing</strong></td>
                    <td style="text-align: right;"><strong>${formatCurrency(netInvesting)}</strong></td>
                </tr>
                
                <tr class="section-header">
                    <td><strong>Financing Activities</strong></td>
                    <td></td>
                </tr>
                ${cashFlowData.financing
                    .filter(item => item.amount !== 0)
                    .map(item => `
                        <tr>
                            <td>&nbsp;&nbsp;${item.item}</td>
                            <td style="text-align: right;">${formatCurrency(item.amount)}</td>
                        </tr>
                    `).join('')}
                <tr class="subtotal">
                    <td><strong>Net Cash from Financing</strong></td>
                    <td style="text-align: right;"><strong>${formatCurrency(netFinancing)}</strong></td>
                </tr>
                
                <tr><td colspan="2" style="height: 12px;"></td></tr>
                <tr class="total-line">
                    <td><strong>Net Change in Cash</strong></td>
                    <td style="text-align: right;"><strong>${formatCurrency(netCashChange)}</strong></td>
                </tr>
                <tr class="total-line">
                    <td><strong>Ending Cash Balance</strong></td>
                    <td style="text-align: right;"><strong>${formatCurrency(endingBalance)}</strong></td>
                </tr>
            `;
        }
        
        function updateFileList() {
            fileList.innerHTML = '';
            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                            </svg>
                        </div>
                        <div class="file-details">
                            <h4>${file.name}</h4>
                            <div class="file-size">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                        </div>
                    </div>
                    <button class="file-remove" onclick="removeFile(${index})">✕</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
            
            // Hide generate button if no files left
            if (uploadedFiles.length === 0) {
                document.getElementById('uploadActions').style.display = 'none';
            }
        }

        function startModernProcessing() {
            const segments = document.querySelectorAll('.segment');
            const titleEl = document.getElementById('modernProcessingTitle');
            const subtitleEl = document.getElementById('modernProcessingSubtitle');
            const percentEl = document.getElementById('modernProgressPercent');
            
            const phases = [
                {
                    title: "Parsing Bank Statements...",
                    subtitle: "Extracting transaction data with OCR technology",
                    duration: 18000, // 18 seconds
                    startPercent: 0,
                    endPercent: 25
                },
                {
                    title: "Applying AI Classification...",
                    subtitle: "Categorizing transactions using machine learning", 
                    duration: 22000, // 22 seconds
                    startPercent: 25,
                    endPercent: 50
                },
                {
                    title: "Generating Financial Statements...",
                    subtitle: "Building comprehensive reports and calculations",
                    duration: 12000, // 12 seconds
                    startPercent: 50,
                    endPercent: 75
                },
                {
                    title: "Finalizing Executive Reports...",
                    subtitle: "Applying finishing touches and validations",
                    duration: 8000, // 8 seconds
                    startPercent: 75,
                    endPercent: 100
                }
            ];
            
            let currentPhase = 0;
            
            function updatePhase() {
                if (currentPhase < phases.length) {
                    const phase = phases[currentPhase];
                    
                    // Update text immediately
                    titleEl.textContent = phase.title;
                    subtitleEl.textContent = phase.subtitle;
                    
                    // Activate current segment
                    segments[currentPhase].classList.add('active');
                    
                    // Complete previous segments
                    for (let i = 0; i < currentPhase; i++) {
                        segments[i].classList.remove('active');
                        segments[i].classList.add('completed');
                    }
                    
                    // Smooth progress animation within this phase
                    let progress = phase.startPercent;
                    const increment = (phase.endPercent - phase.startPercent) / (phase.duration / 100);
                    
                    const progressInterval = setInterval(() => {
                        progress += increment;
                        if (progress >= phase.endPercent) {
                            progress = phase.endPercent;
                            clearInterval(progressInterval);
                            
                            // Move to next phase after completing this one
                            currentPhase++;
                            setTimeout(updatePhase, 200);
                        }
                        percentEl.textContent = `${Math.round(progress)}%`;
                    }, 100);
                }
            }
            
            // Start first phase
            updatePhase();
        }

        function showReport(reportType) {
            // Hide all reports
            document.querySelectorAll('.report-container').forEach(container => {
                container.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected report
            const reportMap = {
                'income': 'incomeReport',
                'balance': 'balanceReport', 
                'cashflow': 'cashflowReport'
            };
            
            document.getElementById(reportMap[reportType]).classList.add('active');
            
            // Activate clicked tab
            event.target.classList.add('active');
        }

        // Storage Management System
        const STORAGE_KEY = 'montpro_analyses';
        const MAX_ANALYSES = 50;
        
        function saveAnalysis(financialData) {
            try {
                const analysis = {
                    id: generateAnalysisId(),
                    timestamp: new Date().toISOString(),
                    companyName: document.getElementById('companyName').value,
                    industry: document.getElementById('industry').value,
                    businessSize: document.getElementById('businessSize').value,
                    reportingPeriod: document.getElementById('reportingPeriod').value,
                    financialData: financialData,
                    autoGeneratedName: generateAnalysisName()
                };
        
                let savedAnalyses = getSavedAnalyses();
                
                // Add new analysis to the beginning
                savedAnalyses.unshift(analysis);
                
                // Keep only the latest 50
                if (savedAnalyses.length > MAX_ANALYSES) {
                    savedAnalyses = savedAnalyses.slice(0, MAX_ANALYSES);
                }
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(savedAnalyses));
                
                // Show save confirmation
                showSaveNotification(analysis.autoGeneratedName);
                
                return analysis.id;
            } catch (error) {
                console.error('Error saving analysis:', error);
                alert('Error saving analysis. Storage may be full.');
            }
        }
        
        function getSavedAnalyses() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                return saved ? JSON.parse(saved) : [];
            } catch (error) {
                console.error('Error loading saved analyses:', error);
                return [];
            }
        }
        
        function generateAnalysisId() {
            return 'analysis_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function generateAnalysisName() {
            const companyName = document.getElementById('companyName').value;
            const reportingPeriod = document.getElementById('reportingPeriod').value;
            const periodText = formatReportingPeriod(reportingPeriod);
            
            return `${companyName} - ${periodText}`;
        }
        
        function showSaveNotification(analysisName) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10B981, #059669);
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
                z-index: 10000;
                font-weight: 600;
                animation: slideInRight 0.3s ease;
            `;
            notification.innerHTML = `✓ Analysis saved: ${analysisName}`;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }
        
        function deleteAnalysis(analysisId) {
            let savedAnalyses = getSavedAnalyses();
            savedAnalyses = savedAnalyses.filter(analysis => analysis.id !== analysisId);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedAnalyses));
        }
        
        function loadAnalysis(analysisId) {
            const savedAnalyses = getSavedAnalyses();
            return savedAnalyses.find(analysis => analysis.id === analysisId);
        }

        // History Dashboard Functions
        function showHistoryModal() {
            populateHistoryList();
            document.getElementById('historyModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
        
        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
            document.body.style.overflow = ''; // Restore scrolling
        }
        
        function populateHistoryList() {
            const historyList = document.getElementById('historyList');
            const historyCount = document.getElementById('historyCount');
            const savedAnalyses = getSavedAnalyses();
            
            historyCount.textContent = `${savedAnalyses.length} analyses saved`;
            
            if (savedAnalyses.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-history">
                        <h4>No analyses saved yet</h4>
                        <p>Complete an analysis to start building your history</p>
                    </div>
                `;
                return;
            }
            
            historyList.innerHTML = savedAnalyses.map(analysis => `
                <div class="history-item" data-id="${analysis.id}">
                    <div class="history-item-header">
                        <div class="history-item-title">${analysis.autoGeneratedName}</div>
                        <div class="history-item-date">${formatDate(analysis.timestamp)}</div>
                    </div>
                    <div class="history-item-details">
                        <span>📊 ${analysis.industry}</span>
                        <span>👥 ${analysis.businessSize}</span>
                        <span>📅 ${formatReportingPeriod(analysis.reportingPeriod)}</span>
                    </div>
                    <div class="history-item-actions">
                        <button class="history-btn history-btn-load" onclick="loadSavedAnalysis('${analysis.id}')">
                            Load Analysis
                        </button>
                        <button class="history-btn history-btn-delete" onclick="deleteSavedAnalysis('${analysis.id}')">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function loadSavedAnalysis(analysisId) {
            const analysis = loadAnalysis(analysisId);
            if (!analysis) {
                alert('Analysis not found');
                return;
            }
            
            // Populate form fields
            document.getElementById('companyName').value = analysis.companyName;
            document.getElementById('industry').value = analysis.industry;
            document.getElementById('businessSize').value = analysis.businessSize;
            document.getElementById('reportingPeriod').value = analysis.reportingPeriod;
            
            // Show results directly
            populateResults(analysis.financialData);
            
            // Update UI state
            currentStep = 4;
            updateProgress(4);
            showCard(uploadCard);
            showCard(resultsCard);
            
            // Close modal
            closeHistoryModal();
            
            // Scroll to results
            setTimeout(() => {
                document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
                // Hide completed steps when loading previous analysis
                hideCompletedSteps();
            }, 500);
        }
        
        function deleteSavedAnalysis(analysisId) {
            if (confirm('Are you sure you want to delete this analysis?')) {
                deleteAnalysis(analysisId);
                populateHistoryList();
            }
        }
        
        function clearAllAnalyses() {
            if (confirm('Are you sure you want to delete ALL saved analyses? This cannot be undone.')) {
                localStorage.removeItem(STORAGE_KEY);
                populateHistoryList();
            }
        }
        
        // Search functionality
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('historySearch');
            if (searchInput) {
                searchInput.addEventListener('input', filterHistoryList);
            }
        });
        
        function filterHistoryList() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const historyItems = document.querySelectorAll('.history-item');
            
            historyItems.forEach(item => {
                const title = item.querySelector('.history-item-title').textContent.toLowerCase();
                if (title.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // PDF Export Functions
        function exportReport(format) {
            const exportScope = document.getElementById('exportScope').value;
            const currentReport = getCurrentReportType();
            
            // Show loading state
            const btn = event.target.closest('.export-btn');
            btn.classList.add('loading');
            
            setTimeout(() => {
                btn.classList.remove('loading');
                
                if (format === 'pdf') {
                    if (exportScope === 'current') {
                        generateCurrentReportPDF(currentReport);
                    } else {
                        generateAllReportsPDF();
                    }
                } else if (format === 'csv') {
                    if (exportScope === 'current') {
                        generateCurrentReportCSV(currentReport);
                    } else {
                        generateAllReportsCSV();
                    }
                }
            }, 1000);
        }
        
        function generateCurrentReportPDF(reportType) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get company info
            const companyName = document.getElementById('companyName').value;
            const reportingPeriod = formatReportingPeriod(document.getElementById('reportingPeriod').value);
            const currency = document.getElementById('currencySelect').value;
            
            // PDF Header
            addPDFHeader(doc, companyName, reportingPeriod);
            
            let yPosition = 60;
            
            // Generate specific report
            if (reportType === 'income') {
                yPosition = generateIncomeStatementPDF(doc, yPosition, currency);
            } else if (reportType === 'balance') {
                yPosition = generateBalanceSheetPDF(doc, yPosition, currency);
            } else if (reportType === 'cashflow') {
                yPosition = generateCashFlowPDF(doc, yPosition, currency);
            }
            
            // Add footer
            addPDFFooter(doc);
            
            // Download
            const reportNames = {
                'income': 'Income_Statement',
                'balance': 'Balance_Sheet',
                'cashflow': 'Cash_Flow_Statement'
            };
            
            const fileName = `${companyName.replace(/[^a-zA-Z0-9]/g, '_')}_${reportNames[reportType]}_${getCurrentDateString()}.pdf`;
            doc.save(fileName);
        }
        
        function generateAllReportsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get company info
            const companyName = document.getElementById('companyName').value;
            const reportingPeriod = formatReportingPeriod(document.getElementById('reportingPeriod').value);
            const currency = document.getElementById('currencySelect').value;
            
            // PDF Header
            addPDFHeader(doc, companyName, reportingPeriod);
            
            let yPosition = 60;
            
            // Generate all three reports
            yPosition = generateIncomeStatementPDF(doc, yPosition, currency);
            
            // Add new page for Balance Sheet
            doc.addPage();
            addPDFHeader(doc, companyName, reportingPeriod);
            yPosition = 60;
            yPosition = generateBalanceSheetPDF(doc, yPosition, currency);
            
            // Add new page for Cash Flow
            doc.addPage();
            addPDFHeader(doc, companyName, reportingPeriod);
            yPosition = 60;
            yPosition = generateCashFlowPDF(doc, yPosition, currency);
            
            // Add footer to all pages
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                addPDFFooter(doc);
            }
            
            const fileName = `${companyName.replace(/[^a-zA-Z0-9]/g, '_')}_Financial_Statements_${getCurrentDateString()}.pdf`;
            doc.save(fileName);
        }
        
        function addPDFHeader(doc, companyName, reportingPeriod) {
            // Company name
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text(companyName, 20, 25);
            
            // Report period
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Financial Statements - ${reportingPeriod}`, 20, 35);
            
            // Generated by MontPro
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('Generated by MontPro Financier', 20, 45);
            doc.setTextColor(0, 0, 0);
            
            // Line separator
            doc.setLineWidth(0.5);
            doc.line(20, 50, 190, 50);
        }
        
        function addPDFFooter(doc) {
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on ${new Date().toLocaleDateString()}`, 20, pageHeight - 10);
            doc.text('MontPro Financier - montpro.app', 150, pageHeight - 10);
        }
        
        function generateIncomeStatementPDF(doc, startY, currency) {
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Income Statement', 20, startY);
            
            let yPos = startY + 15;
            
            if (!window.currentFinancialData) return yPos;
            
            const incomeData = window.currentFinancialData.incomeStatement;
            const totalRevenue = incomeData.revenue.reduce((sum, item) => sum + item.amount, 0);
            const totalExpenses = incomeData.expenses.reduce((sum, item) => sum + item.amount, 0);
            const netIncome = incomeData.netIncome || (totalRevenue - totalExpenses);
            
            // Revenue section
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Revenue', 20, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            incomeData.revenue.filter(item => item.amount > 0).forEach(item => {
                doc.text(`  ${item.item}`, 25, yPos);
                doc.text(formatCurrencyForPDF(item.amount, currency), 150, yPos, { align: 'right' });
                yPos += 6;
            });
            
            // Total Revenue
            doc.setFont('helvetica', 'bold');
            doc.text('Total Revenue', 25, yPos);
            doc.text(formatCurrencyForPDF(totalRevenue, currency), 150, yPos, { align: 'right' });
            yPos += 12;
            
            // Expenses section
            doc.text('Expenses', 20, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            incomeData.expenses.filter(item => item.amount > 0).forEach(item => {
                doc.text(`  ${item.item}`, 25, yPos);
                doc.text(formatCurrencyForPDF(item.amount, currency), 150, yPos, { align: 'right' });
                yPos += 6;
            });
            
            // Total Expenses
            doc.setFont('helvetica', 'bold');
            doc.text('Total Expenses', 25, yPos);
            doc.text(formatCurrencyForPDF(totalExpenses, currency), 150, yPos, { align: 'right' });
            yPos += 12;
            
            // Net Income
            doc.setFontSize(14);
            doc.text('Net Income', 25, yPos);
            doc.text(formatCurrencyForPDF(netIncome, currency), 150, yPos, { align: 'right' });
            
            return yPos + 20;
        }
        
        function generateBalanceSheetPDF(doc, startY, currency) {
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Balance Sheet', 20, startY);
            
            let yPos = startY + 15;
            
            if (!window.currentFinancialData) return yPos;
            
            const balanceData = window.currentFinancialData.balanceSheet;
            const totalAssets = balanceData.assets.reduce((sum, item) => sum + item.amount, 0);
            const totalLiabilities = balanceData.liabilities.reduce((sum, item) => sum + item.amount, 0);
            const totalEquity = balanceData.equity.reduce((sum, item) => sum + item.amount, 0);
            const calculatedEquity = totalAssets - totalLiabilities;
            const displayEquity = totalEquity > 0 ? totalEquity : calculatedEquity;
            
            // Assets section
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Assets', 20, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            balanceData.assets.filter(item => item.amount > 0).forEach(item => {
                doc.text(`  ${item.item}`, 25, yPos);
                doc.text(formatCurrencyForPDF(item.amount, currency), 150, yPos, { align: 'right' });
                yPos += 6;
            });
            
            // Total Assets
            doc.setFont('helvetica', 'bold');
            doc.text('Total Assets', 25, yPos);
            doc.text(formatCurrencyForPDF(totalAssets, currency), 150, yPos, { align: 'right' });
            yPos += 12;
            
            // Liabilities section
            doc.text('Liabilities', 20, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            balanceData.liabilities.filter(item => item.amount > 0).forEach(item => {
                doc.text(`  ${item.item}`, 25, yPos);
                doc.text(formatCurrencyForPDF(item.amount, currency), 150, yPos, { align: 'right' });
                yPos += 6;
            });
            
            // Total Liabilities
            doc.setFont('helvetica', 'bold');
            doc.text('Total Liabilities', 25, yPos);
            doc.text(formatCurrencyForPDF(totalLiabilities, currency), 150, yPos, { align: 'right' });
            yPos += 12;
            
            // Equity section
            doc.text('Equity', 20, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            if (totalEquity > 0) {
                balanceData.equity.filter(item => item.amount > 0).forEach(item => {
                    doc.text(`  ${item.item}`, 25, yPos);
                    doc.text(formatCurrencyForPDF(item.amount, currency), 150, yPos, { align: 'right' });
                    yPos += 6;
                });
            } else {
                doc.text('  Calculated Equity', 25, yPos);
                doc.text(formatCurrencyForPDF(calculatedEquity, currency), 150, yPos, { align: 'right' });
                yPos += 6;
            }
            
            // Total Equity
            doc.setFont('helvetica', 'bold');
            doc.text('Total Equity', 25, yPos);
            doc.text(formatCurrencyForPDF(displayEquity, currency), 150, yPos, { align: 'right' });
            
            return yPos + 20;
        }
        
        function generateCashFlowPDF(doc, startY, currency) {
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Cash Flow Statement', 20, startY);
            
            let yPos = startY + 15;
            
            if (!window.currentFinancialData) return yPos;
            
            const cashFlowData = window.currentFinancialData.cashFlow;
            const netOperating = cashFlowData.operating.reduce((sum, item) => sum + item.amount, 0);
            const netInvesting = cashFlowData.investing.reduce((sum, item) => sum + item.amount, 0);
            const netFinancing = cashFlowData.financing.reduce((sum, item) => sum + item.amount, 0);
            
            // Use backend values if available
            const beginningBalance = cashFlowData.beginningBalance || 0;
            const netCashChange = cashFlowData.netChangeInCash || (netOperating + netInvesting + netFinancing);
            const endingBalance = cashFlowData.endingBalance || (beginningBalance + netCashChange);
            
            // Beginning Cash Balance
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Beginning Cash Balance', 25, yPos);
            doc.text(formatCurrencyForPDF(beginningBalance, currency), 150, yPos, { align: 'right' });
            yPos += 12;
            
            // Operating Activities
            doc.text('Operating Activities', 20, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            cashFlowData.operating.filter(item => item.amount !== 0).forEach(item => {
                doc.text(`  ${item.item}`, 25, yPos);
                doc.text(formatCurrencyForPDF(item.amount, currency), 150, yPos, { align: 'right' });
                yPos += 6;
            });
            
            doc.setFont('helvetica', 'bold');
            doc.text('Net Cash from Operating', 25, yPos);
            doc.text(formatCurrencyForPDF(netOperating, currency), 150, yPos, { align: 'right' });
            yPos += 12;
            
            // Investing Activities
            doc.text('Investing Activities', 20, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            cashFlowData.investing.filter(item => item.amount !== 0).forEach(item => {
                doc.text(`  ${item.item}`, 25, yPos);
                doc.text(formatCurrencyForPDF(item.amount, currency), 150, yPos, { align: 'right' });
                yPos += 6;
            });
            
            doc.setFont('helvetica', 'bold');
            doc.text('Net Cash from Investing', 25, yPos);
            doc.text(formatCurrencyForPDF(netInvesting, currency), 150, yPos, { align: 'right' });
            yPos += 12;
            
            // Financing Activities
            doc.text('Financing Activities', 20, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            cashFlowData.financing.filter(item => item.amount !== 0).forEach(item => {
                doc.text(`  ${item.item}`, 25, yPos);
                doc.text(formatCurrencyForPDF(item.amount, currency), 150, yPos, { align: 'right' });
                yPos += 6;
            });
            
            doc.setFont('helvetica', 'bold');
            doc.text('Net Cash from Financing', 25, yPos);
            doc.text(formatCurrencyForPDF(netFinancing, currency), 150, yPos, { align: 'right' });
            yPos += 12;
            
            // Net Change in Cash
            doc.setFontSize(14);
            doc.text('Net Change in Cash', 25, yPos);
            doc.text(formatCurrencyForPDF(netCashChange, currency), 150, yPos, { align: 'right' });
            yPos += 8;
            
            // Ending Cash Balance
            doc.text('Ending Cash Balance', 25, yPos);
            doc.text(formatCurrencyForPDF(endingBalance, currency), 150, yPos, { align: 'right' });
            
            return yPos + 20;
        }
        
        function formatCurrencyForPDF(amount, currency) {
            const formatOptions = {
                'IDR': { locale: 'id-ID', currency: 'IDR' },
                'USD': { locale: 'en-US', currency: 'USD' },
                'EUR': { locale: 'de-DE', currency: 'EUR' },
                'SGD': { locale: 'en-SG', currency: 'SGD' }
            };
            
            const config = formatOptions[currency] || formatOptions['IDR'];
            
            return new Intl.NumberFormat(config.locale, {
                style: 'currency',
                currency: config.currency,
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        function getCurrentDateString() {
            return new Date().toISOString().split('T')[0];
        }

        function generateCurrentReportCSV(reportType) {
            let csvContent = '';
            const companyName = document.getElementById('companyName').value;
            const reportingPeriod = formatReportingPeriod(document.getElementById('reportingPeriod').value);
            
            if (reportType === 'income') {
                csvContent = generateIncomeStatementCSV();
            } else if (reportType === 'balance') {
                csvContent = generateBalanceSheetCSV();
            } else if (reportType === 'cashflow') {
                csvContent = generateCashFlowCSV();
            }
            
            const reportNames = {
                'income': 'Income_Statement',
                'balance': 'Balance_Sheet',
                'cashflow': 'Cash_Flow_Statement'
            };
            
            downloadCSV(csvContent, `${companyName.replace(/[^a-zA-Z0-9]/g, '_')}_${reportNames[reportType]}_${getCurrentDateString()}.csv`);
        }
        
        function generateAllReportsCSV() {
            const companyName = document.getElementById('companyName').value;
            const reportingPeriod = formatReportingPeriod(document.getElementById('reportingPeriod').value);
            
            let csvContent = `Company: ${companyName}\n`;
            csvContent += `Period: ${reportingPeriod}\n\n`;
            
            csvContent += generateIncomeStatementCSV() + '\n\n';
            csvContent += generateBalanceSheetCSV() + '\n\n';
            csvContent += generateCashFlowCSV();
            
            downloadCSV(csvContent, `${companyName.replace(/[^a-zA-Z0-9]/g, '_')}_Financial_Statements_${getCurrentDateString()}.csv`);
        }
        
        function generateIncomeStatementCSV() {
            if (!window.currentFinancialData) return '';
            
            const incomeData = window.currentFinancialData.incomeStatement;
            let csv = 'Income Statement\n';
            csv += 'Item,Amount\n';
            
            csv += 'REVENUE,\n';
            incomeData.revenue.filter(item => item.amount > 0).forEach(item => {
                csv += `"${item.item}",${item.amount}\n`;
            });
            
            const totalRevenue = incomeData.revenue.reduce((sum, item) => sum + item.amount, 0);
            csv += `"Total Revenue",${totalRevenue}\n\n`;
            
            csv += 'EXPENSES,\n';
            incomeData.expenses.filter(item => item.amount > 0).forEach(item => {
                csv += `"${item.item}",${item.amount}\n`;
            });
            
            const totalExpenses = incomeData.expenses.reduce((sum, item) => sum + item.amount, 0);
            csv += `"Total Expenses",${totalExpenses}\n\n`;
            
            const netIncome = incomeData.netIncome || (totalRevenue - totalExpenses);
            csv += `"Net Income",${netIncome}\n`;
            
            return csv;
        }
        
        function generateBalanceSheetCSV() {
            if (!window.currentFinancialData) return '';
            
            const balanceData = window.currentFinancialData.balanceSheet;
            let csv = 'Balance Sheet\n';
            csv += 'Item,Amount\n';
            
            csv += 'ASSETS,\n';
            balanceData.assets.filter(item => item.amount > 0).forEach(item => {
                csv += `"${item.item}",${item.amount}\n`;
            });
            
            const totalAssets = balanceData.assets.reduce((sum, item) => sum + item.amount, 0);
            csv += `"Total Assets",${totalAssets}\n\n`;
            
            csv += 'LIABILITIES,\n';
            balanceData.liabilities.filter(item => item.amount > 0).forEach(item => {
                csv += `"${item.item}",${item.amount}\n`;
            });
            
            const totalLiabilities = balanceData.liabilities.reduce((sum, item) => sum + item.amount, 0);
            csv += `"Total Liabilities",${totalLiabilities}\n\n`;
            
            csv += 'EQUITY,\n';
            const totalEquity = balanceData.equity.reduce((sum, item) => sum + item.amount, 0);
            if (totalEquity > 0) {
                balanceData.equity.filter(item => item.amount > 0).forEach(item => {
                    csv += `"${item.item}",${item.amount}\n`;
                });
                csv += `"Total Equity",${totalEquity}\n`;
            } else {
                const calculatedEquity = totalAssets - totalLiabilities;
                csv += `"Calculated Equity",${calculatedEquity}\n`;
                csv += `"Total Equity",${calculatedEquity}\n`;
            }
            
            return csv;
        }
        
        function generateCashFlowCSV() {
            if (!window.currentFinancialData) return '';
            
            const cashFlowData = window.currentFinancialData.cashFlow;
            let csv = 'Cash Flow Statement\n';
            csv += 'Item,Amount\n';
            
            // Beginning balance
            const beginningBalance = cashFlowData.beginningBalance || 0;
            csv += `"Beginning Cash Balance",${beginningBalance}\n\n`;
            
            csv += 'OPERATING ACTIVITIES,\n';
            cashFlowData.operating.filter(item => item.amount !== 0).forEach(item => {
                csv += `"${item.item}",${item.amount}\n`;
            });
            const netOperating = cashFlowData.operating.reduce((sum, item) => sum + item.amount, 0);
            csv += `"Net Cash from Operating",${netOperating}\n\n`;
            
            csv += 'INVESTING ACTIVITIES,\n';
            cashFlowData.investing.filter(item => item.amount !== 0).forEach(item => {
                csv += `"${item.item}",${item.amount}\n`;
            });
            const netInvesting = cashFlowData.investing.reduce((sum, item) => sum + item.amount, 0);
            csv += `"Net Cash from Investing",${netInvesting}\n\n`;
            
            csv += 'FINANCING ACTIVITIES,\n';
            cashFlowData.financing.filter(item => item.amount !== 0).forEach(item => {
                csv += `"${item.item}",${item.amount}\n`;
            });
            const netFinancing = cashFlowData.financing.reduce((sum, item) => sum + item.amount, 0);
            csv += `"Net Cash from Financing",${netFinancing}\n\n`;
            
            // Use backend values
            const netCashChange = cashFlowData.netChangeInCash || (netOperating + netInvesting + netFinancing);
            const endingBalance = cashFlowData.endingBalance || (beginningBalance + netCashChange);
            
            csv += `"Net Change in Cash",${netCashChange}\n`;
            csv += `"Ending Cash Balance",${endingBalance}\n`;
            
            return csv;
        }
        
        function downloadCSV(csvContent, fileName) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function getCurrentReportType() {
            const activeReport = document.querySelector('.report-container.active');
            if (activeReport.id === 'incomeReport') return 'income';
            if (activeReport.id === 'balanceReport') return 'balance';
            if (activeReport.id === 'cashflowReport') return 'cashflow';
        }
        
        function getCurrentDate() {
            const now = new Date();
            return now.toISOString().split('T')[0]; // Returns YYYY-MM-DD format
        }

        function resetWorkspace() {
            // Reset form
            document.getElementById('companyName').value = '';
            document.getElementById('industry').value = '';
            document.getElementById('businessSize').value = '';
            document.getElementById('reportingPeriod').value = '';
            
            // Clear files
            uploadedFiles = [];
            updateFileList();
            document.getElementById('uploadActions').style.display = 'none';
            
            // Reset progress
            currentStep = 1;
            updateProgress(1);
            
            // Reset card visibility states
            companyCard.classList.remove('hidden');
            companyCard.classList.add('active');
            uploadCard.classList.add('hidden');
            uploadCard.classList.remove('active');
            processingCard.classList.add('hidden');
            processingCard.classList.remove('active');
            resultsCard.classList.add('hidden');
            resultsCard.classList.remove('active');
            
            // Reset any processing intervals
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            if (window.processingInterval) {
                clearInterval(window.processingInterval);
            }
            
            // Reset progress variables
            currentProgress = 0;
            progressSpeed = 1;
            
            // Reset progress bar
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            progressFill.style.width = '25%';
            progressText.textContent = 'Step 1 of 4: Company Information';
            
            // Scroll back to top
            document.querySelector('.workspace-hero').scrollIntoView({ behavior: 'smooth' });
        }

        // Step visibility management
        function hideCompletedSteps() {
            // Hide company card and upload card
            companyCard.classList.add('hidden');
            companyCard.classList.remove('active');
            uploadCard.classList.add('hidden');
            uploadCard.classList.remove('active');
            
            // Also hide processing card since it's complete
            processingCard.classList.add('hidden');
            processingCard.classList.remove('active');
        }
        
        function showAllSteps() {
            // Show company card and upload card again
            companyCard.classList.remove('hidden');
            companyCard.classList.add('active');
            uploadCard.classList.remove('hidden');
            uploadCard.classList.add('active');
            
            // Hide processing and results cards
            processingCard.classList.add('hidden');
            processingCard.classList.remove('active');
            resultsCard.classList.add('hidden');
            resultsCard.classList.remove('active');
        }

        function scrollToForms() {
            const element = document.querySelector('.progress-indicator');
            const elementTop = element.offsetTop;
            const offset = -90; // Extra scroll amount
            
            window.scrollTo({
                top: elementTop + offset,
                behavior: 'smooth'
            });
        }

        function formatReportingPeriod(period) {
            if (period.includes('-')) {
                // Handle month input (YYYY-MM format)
                const [year, month] = period.split('-');
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            }
            return period;
        }

        function openMonthPicker(container) {
            const input = container.querySelector('input[type="month"]');
            input.focus();
            input.showPicker(); // This opens the calendar directly
        }

        // Initialize
        updateProgress(1);
    </script>

<!-- History Dashboard Modal -->
<div class="history-modal hidden" id="historyModal">
    <div class="history-modal-backdrop" onclick="closeHistoryModal()"></div>
    <div class="history-modal-content">
        <div class="history-header">
            <h3>Analysis History</h3>
            <button class="close-btn" onclick="closeHistoryModal()">×</button>
        </div>
        
        <div class="history-controls">
            <div class="search-container">
                <input type="text" id="historySearch" placeholder="Search by company name..." class="search-input">
                <button class="search-btn">🔍</button>
            </div>
            <div class="history-stats">
                <span id="historyCount">0 analyses saved</span>
            </div>
        </div>
        
        <div class="history-list" id="historyList">
            <!-- Analysis items will be populated here -->
        </div>
        
        <div class="history-actions">
            <button class="btn btn-secondary" onclick="clearAllAnalyses()">Clear All History</button>
            <button class="btn btn-secondary" onclick="closeHistoryModal()">Close</button>
        </div>
    </div>
</div>
    
</body>
</html>
