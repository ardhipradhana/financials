<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Statement Generator - MontPro</title>
    <link rel="icon" href="favicon.png" type="image/png">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- AOS Animation Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    
    <style>
        /* Georgetown-inspired Professional Theme */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #E2E8F0;
            position: relative;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(99, 102, 241, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.04) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 100px 20px 40px;
            position: relative;
            z-index: 1;
        }

        /* Navigation */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
            z-index: 1000;
            padding: 0;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .brand-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0px;
        }
        
        .brand-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .brand-text {
            font-size: 1.4rem;
            font-weight: 700;
            color: #F8FAFC;
        }
        
        .nav-links {
            display: flex;
            align-items: center;
            gap: 32px;
        }
        
        .nav-link {
            color: #94A3B8;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .nav-link:hover {
            color: #F8FAFC;
        }
        
        .btn-nav-cta {
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-nav-cta:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-back-home,
        .btn-load-analysis {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .btn-back-home {
            background: rgba(15, 23, 42, 0.6);
            color: #94A3B8;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .btn-back-home:hover {
            color: #F8FAFC;
            border-color: rgba(59, 130, 246, 0.3);
            background: rgba(59, 130, 246, 0.05);
        }

        .btn-load-analysis {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(30, 41, 59, 0.8));
            color: #60A5FA;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .btn-load-analysis:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(30, 41, 59, 0.9));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }
        
        .back-link {
            margin-bottom: 0; /* Remove margin from original style */
        }
        
        .back-link:hover {
            color: #F8FAFC;
        }

        /* Workspace Hero */
        .workspace-hero {
            text-align: center;
            margin-bottom: 60px;
            margin-top: 80px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .trust-badge {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 25px;
            padding: 12px 20px;
            margin-bottom: 32px;
            color: #10B981;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .trust-icon {
            width: 20px;
            height: 20px;
            color: #10B981;
        }

        .workspace-hero h1 {
            font-size: clamp(2.5rem, 5vw, 4rem); 
            font-weight: 800;
            color: #F8FAFC;
            margin-bottom: 24px;
            letter-spacing: -2px;
            line-height: 1.1;
        }

        .hero-description {
            font-size: 1.2rem;
            color: #94A3B8;
            line-height: 1.7;
            margin-bottom: 40px;
        }
        
        .hero-description strong {
            color: #10B981;
            font-weight: 600;
        }
        
        .hero-benefits {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }
        
        .benefit-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #CBD5E1;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .benefit-icon {
            font-size: 1.2rem;
        }
        
        .social-proof {
            padding-top: 24px;
            border-top: 1px solid rgba(59, 130, 246, 0.1);
        }
        
        .proof-text {
            color: #64748B;
            font-size: 0.9rem;
            font-style: italic;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .workspace-hero h1 {
                font-size: 2.2rem;
            }
            
            .hero-benefits {
                gap: 20px;
                justify-content: space-around;
            }
            
            .benefit-item {
                font-size: 0.85rem;
            }
            
            .trust-badge {
                font-size: 0.8rem;
                padding: 10px 16px;
            }
        }

        .workspace-hero p {
            font-size: 1.2rem;
            color: #94A3B8;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Progress Indicator */
        .progress-indicator {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            margin-bottom: 40px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #94A3B8;
            text-align: center;
        }

        /* Workspace Cards */
        .workspace-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .workspace-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .workspace-card.active {
            border-color: rgba(59, 130, 246, 0.4);
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.05), rgba(30, 41, 59, 0.9));
        }

        .workspace-card.hidden {
            display: none;
        }

        .workspace-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #F8FAFC;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #F8FAFC;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            color: #F8FAFC;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #60A5FA;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }

        .form-input::placeholder {
            color: #64748B;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            background: rgba(15, 23, 42, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .upload-zone:hover, .upload-zone.drag-over {
            border-color: #60A5FA;
            background: rgba(59, 130, 246, 0.05);
        }

        .upload-icon {
            font-size: 3rem;
            color: #60A5FA;
            margin-bottom: 16px;
        }

        .upload-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #F8FAFC;
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #94A3B8;
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* File List */
        .file-list {
            margin-top: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(15, 23, 42, 0.6);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-icon {
            color: #60A5FA;
            font-size: 1.2rem;
        }

        .file-details h4 {
            color: #F8FAFC;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .file-size {
            color: #94A3B8;
            font-size: 0.8rem;
        }

        .file-remove {
            background: none;
            border: none;
            color: #EF4444;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .file-remove:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Enhanced Professional Processing Animation */
        .processing-animation {
            text-align: center;
            padding: 40px;
            max-height: 200px; /* Limit height */
        }
        
        .ai-processor-compact {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .processor-core {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s ease-in-out infinite;
            position: relative;
        }
        
        .processor-core::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #3B82F6, #8B5CF6, #10B981, #3B82F6);
            border-radius: 14px;
            z-index: -1;
            animation: borderFlow 3s linear infinite;
            background-size: 400% 400%;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes borderFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .processor-icon {
            color: white;
            animation: rotate 4s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .processing-dots {
            display: flex;
            gap: 8px;
        }
        
        .dot {
            width: 8px;
            height: 8px;
            background: #60A5FA;
            border-radius: 50%;
            animation: dotPulse 1.5s ease-in-out infinite;
        }
        
        .dot:nth-child(1) { animation-delay: 0s; }
        .dot:nth-child(2) { animation-delay: 0.3s; }
        .dot:nth-child(3) { animation-delay: 0.6s; }
        
        @keyframes dotPulse {
            0%, 80%, 100% { opacity: 0.3; transform: scale(1); }
            40% { opacity: 1; transform: scale(1.2); }
        }
        
        .processing-status-compact h4 {
            color: #F8FAFC;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .processing-status-compact p {
            color: #94A3B8;
            font-size: 0.95rem;
        }

        .processing-steps {
            margin-top: 32px;
            max-width: 320px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .processing-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            color: #64748B;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .processing-step::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: rgba(59, 130, 246, 0.2);
            transition: all 0.5s ease;
        }
        
        .processing-step.active {
            color: #60A5FA;
            border-color: rgba(59, 130, 246, 0.3);
            background: rgba(59, 130, 246, 0.05);
            transform: translateX(8px);
        }
        
        .processing-step.active::before {
            background: linear-gradient(180deg, #60A5FA, #3B82F6);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        
        .processing-step.completed {
            color: #10B981;
            border-color: rgba(16, 185, 129, 0.3);
            background: rgba(16, 185, 129, 0.05);
        }
        
        .processing-step.completed::before {
            background: linear-gradient(180deg, #10B981, #059669);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        
        .step-indicator {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            flex-shrink: 0;
            transition: all 0.5s ease;
            background: rgba(15, 23, 42, 0.6);
        }
        
        .processing-step.active .step-indicator {
            background: rgba(59, 130, 246, 0.2);
            border-color: #60A5FA;
            animation: stepPulse 2s ease-in-out infinite;
        }
        
        .processing-step.completed .step-indicator {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10B981;
            animation: none;
        }
        
        @keyframes stepPulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 0 8px rgba(59, 130, 246, 0);
                transform: scale(1.05);
            }
        }
        
        .processing-step span {
            font-weight: 500;
            font-size: 0.85rem;
            letter-spacing: 0.02em;
        }

        .export-btn:first-child {
            border-left: none;
        }

        /* Results Dashboard */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .result-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .result-card:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }

        .result-icon {
            font-size: 2rem;
            color: #60A5FA;
            margin-bottom: 16px;
        }

        .result-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #F8FAFC;
            margin-bottom: 8px;
        }

        .result-description {
            color: #94A3B8;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: #94A3B8;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        .btn-secondary:hover {
            border-color: rgba(59, 130, 246, 0.5);
            color: #F8FAFC;
        }

        .btn-success {
            background: linear-gradient(135deg, #059669, #10B981);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 24px;
            border-top: 1px solid rgba(59, 130, 246, 0.1);
        }

        /* Report Tabs */
        .report-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 32px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #94A3B8;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            color: #60A5FA;
            border-bottom-color: #60A5FA;
        }
        
        .tab-btn:hover {
            color: #F8FAFC;
        }
        
        /* Report Container */
        .report-container {
            display: none;
        }
        
        .report-container.active {
            display: block;
        }
        
        .report-header {
            margin-bottom: 24px;
            text-align: center;
        }
        
        .report-header h4 {
            font-size: 1.3rem;
            color: #F8FAFC;
            margin-bottom: 8px;
        }
        
        .report-header p {
            color: #94A3B8;
            font-size: 0.9rem;
        }
        
        /* Financial Table */
        .financial-table {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .financial-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .financial-table th {
            background: rgba(59, 130, 246, 0.1);
            color: #F8FAFC;
            padding: 16px;
            font-weight: 600;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .financial-table td {
            padding: 12px 16px;
            color: #E2E8F0;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
        }
        
        .financial-table .section-header td {
            background: rgba(30, 41, 59, 0.8);
            color: #60A5FA;
            font-weight: 600;
            padding-top: 16px;
        }
        
        .financial-table .subtotal td {
            border-top: 1px solid rgba(59, 130, 246, 0.3);
            font-weight: 600;
            color: #F8FAFC;
        }
        
        .financial-table .total-line td {
            border-top: 2px solid #60A5FA;
            font-weight: 700;
            color: #60A5FA;
            font-size: 1.05rem;
            padding-top: 16px;
        }

        /* Export Toolbar */
        .export-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 24px;
            backdrop-filter: blur(20px);
        }
        
        .export-actions {
            display: flex;
            gap: 12px;
        }
        
        .export-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            font-size: 0.85rem;
        }
        
        .export-icon {
            font-size: 1rem;
        }
        
        .export-options {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        .export-select {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            color: #F8FAFC;
            padding: 8px 12px;
            font-size: 0.85rem;
            min-width: 180px;
        }
        
        .export-select:focus {
            outline: none;
            border-color: #60A5FA;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
        }
        
        /* Loading state for export buttons */
        .export-btn.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .export-btn.loading::after {
            content: '';
            width: 12px;
            height: 12px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        
        @media (max-width: 768px) {
            .export-options {
                justify-content: center;
                flex-wrap: wrap;
            }
        }
        
        @media (max-width: 768px) {
            .export-toolbar {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .export-actions {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .export-options {
                justify-content: center;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .workspace-hero h1 {
                font-size: 2.2rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .action-bar {
                flex-direction: column;
                gap: 16px;
            }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* History Modal */
        .history-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .history-modal.hidden {
            display: none;
        }
        
        .history-modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        
        .history-modal-content {
            position: relative;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.3),
                0 12px 40px rgba(59, 130, 246, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .history-header h3 {
            color: #F8FAFC;
            font-size: 1.5rem;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #94A3B8;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
        }
        
        .history-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
        }
        
        .search-container {
            display: flex;
            gap: 8px;
            flex: 1;
            max-width: 300px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            color: #F8FAFC;
            font-size: 0.9rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #60A5FA;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
        }
        
        .search-btn {
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            border: none;
            color: white;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .search-btn:hover {
            transform: translateY(-1px);
        }
        
        .history-stats {
            color: #94A3B8;
            font-size: 0.9rem;
        }
        
        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px 24px 0 24px; /* Add top padding */
            max-height: 400px;
        }
        
        .history-item {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.1),
                0 2px 8px rgba(59, 130, 246, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        
        .history-item:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-4px);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.15),
                0 8px 24px rgba(59, 130, 246, 0.1),
                0 4px 16px rgba(59, 130, 246, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .history-item:active {
            transform: translateY(-2px);
            transition: all 0.1s ease;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            padding-right: 40px;
            padding-left: 50px; /* Add space for checkbox */
        }
        
        .history-item-title {
            color: #F8FAFC;
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        .history-item-date {
            color: #64748B;
            font-size: 0.85rem;
            font-weight: 500;
            background: rgba(30, 41, 59, 0.6);
            padding: 4px 12px;
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }
        
        .history-item-details {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .history-detail-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 0.8rem;
            color: #94A3B8;
            font-weight: 500;
        }
        
        .history-detail-badge .badge-icon {
            font-size: 0.9rem;
        }
        
        .history-actions {
            padding: 20px 24px;
            border-top: 1px solid rgba(59, 130, 246, 0.1);
            display: flex;
            justify-content: space-between;
        }
        
        .empty-history {
            text-align: center;
            padding: 40px;
            color: #94A3B8;
        }
        
        @media (max-width: 768px) {
            .history-modal-content {
                width: 95%;
                max-height: 90vh;
            }
            
            .history-controls {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .search-container {
                max-width: none;
            }
        }

        .quick-actions-bar {
            margin-bottom: 40px;
        }
        
        .quick-action-item {
            max-width: 400px;
            margin: 20px auto 40px auto; /* Centered with spacing */
        }
        
        .btn-quick-action {
            width: 100%;
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.05), rgba(30, 41, 59, 0.3));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .btn-quick-action:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }
        
        .quick-action-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        .quick-action-text {
            flex: 1;
        }
        
        .quick-action-title {
            color: #F8FAFC;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .quick-action-subtitle {
            color: #94A3B8;
            font-size: 0.85rem;
        }

        .generate-action { 
            margin-top: 32px; 
            text-align: center; 
            width: 100%;
            display: flex;
            justify-content: center;
        }
        
        .generate-container { 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }
        
        .btn-generate-premium {
            background: linear-gradient(135deg, #1E40AF 0%, #3B82F6 50%, #60A5FA 100%);
            border: none;
            border-radius: 12px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
            white-space: nowrap;
            color: white;
            margin-bottom: 16px;
        }
        
        .btn-generate-premium::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }
        
        .btn-generate-premium:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.4);
        }
        .btn-generate-premium:hover::before { left: 100%; }
        
        .btn-generate-icon {
            width: 28px; height: 28px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .btn-generate-content { 
            flex: 0 0 auto;
            text-align: center; 
        }
        
        .btn-generate-title {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .btn-generate-arrow {
            font-size: 1.2rem; 
            font-weight: bold;
            transition: transform 0.3s ease;
        }
        .btn-generate-premium:hover .btn-generate-arrow { transform: translateX(4px); }
        
        .generate-features {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .feature-badge {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            color: #60A5FA;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .feature-badge.coming-soon {
            background: rgba(75, 85, 99, 0.1);
            border-color: rgba(75, 85, 99, 0.2);
            color: #9CA3AF;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            border-radius: 3px;
            width: 0%;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .progress-text {
            font-size: 0.95rem;
            color: #94A3B8;
            text-align: center;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        /* Modern Processing Animation */
        .modern-processing-container {
            text-align: center;
            padding: 40px 20px;
            max-height: 400px;
        }
        
        .ai-processing-hub {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 32px;
        }
        
        .hub-core {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 20px auto;
            background: linear-gradient(135deg, #1E40AF 0%, #3B82F6 50%, #60A5FA 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.4);
            animation: hubFloat 3s ease-in-out infinite;
        }
        
        .core-icon {
            color: white;
            z-index: 2;
            animation: iconRotate 8s linear infinite;
        }
        
        .pulse-ring {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 100px;
            height: 100px;
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 25px;
            animation: pulseRing 2s ease-out infinite;
        }
        
        .pulse-ring-2 {
            position: absolute;
            top: -20px;
            left: -20px;
            width: 120px;
            height: 120px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 30px;
            animation: pulseRing 2s ease-out infinite 0.5s;
        }
        
        /* Status Text */
        .processing-status-modern {
            margin-bottom: 32px;
        }
        
        .processing-status-modern h4 {
            color: #F8FAFC;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.6s ease;
        }
        
        .processing-status-modern p {
            color: #94A3B8;
            font-size: 1rem;
            transition: all 0.6s ease;
        }
        
        /* Progress Segments */
        .progress-segments {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 24px;
        }
        
        .segment {
            width: 60px;
            height: 6px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 3px;
            position: relative;
            overflow: hidden;
        }
        
        .segment.active {
            background: linear-gradient(90deg, #1E40AF, #60A5FA);
            animation: segmentGlow 1.5s ease-in-out infinite alternate;
        }
        
        .segment.completed {
            background: linear-gradient(90deg, #10B981, #059669);
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.4);
        }
        
        /* Progress Percentage */
        .progress-percentage {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        #modernProgressPercent {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60A5FA, #10B981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s ease;
        }
        
        .progress-label {
            color: #94A3B8;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        /* Animations */
        @keyframes hubFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        
        @keyframes iconRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulseRing {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1.3);
                opacity: 0;
            }
        }
        
        @keyframes segmentGlow {
            0% { box-shadow: 0 0 8px rgba(59, 130, 246, 0.5); }
            100% { box-shadow: 0 0 16px rgba(59, 130, 246, 0.8), 0 0 24px rgba(59, 130, 246, 0.3); }
        }

        .security-notice {
            background: linear-gradient(145deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 40px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .security-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .security-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #10B981, #059669);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        .security-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .security-main {
            color: #10B981;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .security-detail {
            color: #6B7280;
            font-size: 0.85rem;
        }
        
        @media (max-width: 768px) {
            .security-notice {
                margin: 0 20px 40px 20px;
            }
        }

        .file-validation-success,
        .file-validation-error {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(15, 23, 42, 0.6);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #10B981;
            animation: slideInValidation 0.3s ease;
        }
        
        .file-validation-error {
            border-left-color: #EF4444;
        }
        
        @keyframes slideInValidation {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .validation-icon {
            width: 24px;
            height: 24px;
            background: #10B981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        .validation-icon.error {
            background: #EF4444;
        }
        
        .validation-text {
            flex: 1;
        }
        
        .validation-main {
            color: #10B981;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }
        
        .file-validation-error .validation-main {
            color: #EF4444;
        }
        
        .validation-details {
            color: #94A3B8;
            font-size: 0.8rem;
        }

        .actions-grid {
            display: flex;
            justify-content: center;
        }
        
        .security-quick-notice {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(16, 185, 129, 0.05);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 20px;
            padding: 8px 16px;
            color: #10B981;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .security-quick-notice .security-icon {
            width: 16px;
            height: 16px;
            color: #10B981;
        }
        
        .quick-action-item {
            flex: 1;
            max-width: 350px;
        }
        
        @media (max-width: 768px) {
            .actions-grid {
                flex-direction: column;
                align-items: stretch;
            }
            
            .security-quick-notice {
                justify-content: center;
                margin-bottom: 16px;
            }
        }

        .hero-cta {
            margin-bottom: 40px;
            margin-top: 50px;
        }
        
        .btn-hero-start {
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        
        .btn-hero-start:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.4);
        }
        
        .btn-hero-start svg {
            transition: transform 0.3s ease;
        }
        
        .btn-hero-start:hover svg {
            transform: translateX(4px);
        }

        .form-input[type="month"] {
            cursor: pointer;
            position: relative;
        }
        
        .form-input[type="date"] {
            cursor: pointer;
        }
        
        .form-input[type="month"]::-webkit-calendar-picker-indicator,
        .form-input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .form-group {
            position: relative;
        }
        
        .form-group[data-clickable="true"] {
            cursor: pointer;
        }
        
        .form-group[data-clickable="true"]:hover .form-input {
            border-color: #60A5FA;
        }

        .history-delete-btn {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 28px;
            height: 28px;
            border: none;
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2;
        }
        
        .history-item:hover .history-delete-btn {
            opacity: 1;
        }
        
        .history-delete-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: scale(1.1);
        }
        
        .history-item-actions {
            display: none; /* Hide the old action buttons */
        }

        .filter-select {
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            color: #F8FAFC;
            font-size: 0.9rem;
            min-width: 140px;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #60A5FA;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
        }

        /* Financial Ratios Styling */
        .ratios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .ratio-category-card {
            background: linear-gradient(145deg, rgba(15, 23, 42, 0.6), rgba(30, 41, 59, 0.4));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        
        .ratio-category-card:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.1);
        }
        
        .ratio-category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
        }
        
        .ratio-category-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .icon-profitability { background: linear-gradient(135deg, #10B981, #059669); }
        .icon-liquidity { background: linear-gradient(135deg, #3B82F6, #1E40AF); }
        .icon-solvency { background: linear-gradient(135deg, #8B5CF6, #7C3AED); }
        .icon-efficiency { background: linear-gradient(135deg, #F59E0B, #D97706); }
        .icon-cashflow { background: linear-gradient(135deg, #06B6D4, #0891B2); }
        .icon-market { background: linear-gradient(135deg, #EF4444, #DC2626); }
        
        .ratio-category-header h5 {
            color: #F8FAFC;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }
        
        .ratio-items {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .ratio-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .ratio-item:hover {
            background: rgba(59, 130, 246, 0.05);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .ratio-name {
            color: #E2E8F0;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .ratio-value {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ratio-number {
            color: #F8FAFC;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .ratio-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .ratio-excellent {
            background: #10B981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
        }
        
        .ratio-good {
            background: #F59E0B;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
        }
        
        .ratio-poor {
            background: #EF4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
        }
        
        .ratio-neutral {
            background: #6B7280;
            box-shadow: 0 0 8px rgba(107, 114, 128, 0.4);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .ratios-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .ratio-category-card {
                padding: 20px;
            }
        }

        /* Financial Insights Styling */
        .insights-content {
            min-height: 300px;
        }
        
        .insight-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #94A3B8;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .insights-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }
        
        .insight-card {
            background: linear-gradient(145deg, rgba(15, 23, 42, 0.6), rgba(30, 41, 59, 0.4));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        
        .insight-card:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }
        
        .insight-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .insight-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .insight-title {
            color: #F8FAFC;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .insight-content {
            color: #E2E8F0;
            line-height: 1.6;
            margin-bottom: 16px;
        }
        
        .insight-action {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            color: #60A5FA;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Insights Trigger Styling */
        .insights-trigger {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 40px;
            text-align: center;
            min-height: 300px;
        }
        
        .trigger-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-bottom: 24px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .insights-trigger h3 {
            color: #F8FAFC;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 12px;
        }
        
        .insights-trigger p {
            color: #94A3B8;
            font-size: 1.1rem;
            line-height: 1.6;
            max-width: 400px;
            margin-bottom: 32px;
        }
        
        .btn-generate-insights {
            background: linear-gradient(135deg, #1E40AF, #60A5FA);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        
        .btn-generate-insights:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.4);
        }
        
        .btn-generate-insights:active {
            transform: translateY(-1px);
        }

        .export-sections {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .export-section-label {
            color: #F8FAFC;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .export-checkboxes {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .export-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid transparent;
        }

        .checkbox-text {
            color: #CBD5E1;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        @media (max-width: 1024px) {
            .export-toolbar {
                flex-direction: column;
                gap: 20px;
                align-items: stretch;
            }
            
            .export-options {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .export-checkboxes {
                justify-content: center;
                flex-wrap: wrap;
                gap: 12px;
            }
        }

        .export-checkbox:hover .checkbox-text {
            color: #F8FAFC;
        }
        
        .export-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #3B82F6;
            cursor: pointer;
        }
        
        .export-checkbox:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        @media (max-width: 768px) {
            .export-checkboxes {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .checkbox-text {
                font-size: 0.8rem;
            }
        }

        /* Export Modal */
        .export-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .export-modal.hidden {
            display: none;
        }
        
        .export-modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        
        .export-modal-content {
            position: relative;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
        }
        
        .export-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .export-header h3 {
            color: #F8FAFC;
            font-size: 1.5rem;
            margin: 0;
        }
        
        .export-body {
            padding: 24px;
        }
        
        .export-section h4 {
            color: #F8FAFC;
            margin-bottom: 16px;
            font-size: 1.1rem;
        }
        
        .export-checkboxes {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        .export-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }
        
        .export-checkbox:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .export-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #3B82F6;
        }
        
        .checkbox-text {
            color: #CBD5E1;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .export-checkbox:hover .checkbox-text {
            color: #F8FAFC;
        }
        
        .export-actions-modal {
            display: flex;
            justify-content: space-between;
            padding: 24px;
            border-top: 1px solid rgba(59, 130, 246, 0.1);
        }

        .comparison-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(30, 41, 59, 0.3));
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            margin: 0 24px 20px 24px; /* Add horizontal margins */
            transition: all 0.3s ease;
        }
        
        .comparison-controls.hidden {
            display: none;
        }
        
        .comparison-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .comparison-info span:first-child {
            color: #F8FAFC;
            font-weight: 600;
        }
        
        .comparison-hint {
            color: #94A3B8;
            font-size: 0.85rem;
        }
        
        .comparison-actions {
            display: flex;
            gap: 12px;
        }
        
        .history-item-checkbox {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 18px;
            height: 18px;
            accent-color: #3B82F6;
            cursor: pointer;
            z-index: 3;
        }
        
        .history-item.selected {
            border-color: rgba(59, 130, 246, 0.6);
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.1), rgba(30, 41, 59, 0.9));
        }

        .comparison-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .comparison-content {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
        }
        
        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .comparison-table th {
            background: rgba(59, 130, 246, 0.1);
            color: #F8FAFC;
            padding: 12px;
            font-weight: 600;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            text-align: center;
        }
        
        .comparison-table td {
            padding: 10px 12px;
            color: #E2E8F0;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
            text-align: right;
        }
        
        .comparison-table td:first-child {
            text-align: left;
            font-weight: 500;
        }

        .comparison-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 32px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .comparison-tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #94A3B8;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .comparison-tab-btn.active {
            color: #60A5FA;
            border-bottom-color: #60A5FA;
        }
        
        .comparison-tab-btn:hover {
            color: #F8FAFC;
        }
        
        .comparison-tab-content {
            display: none;
        }
        
        .comparison-tab-content.active {
            display: block;
        }
        
        .positive-change {
            color: #10B981;
            font-weight: 600;
        }
        
        .negative-change {
            color: #EF4444;
            font-weight: 600;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation Header -->
        <nav class="top-nav">
            <div class="nav-container">
                <div class="nav-brand">
                    <div class="brand-icon"><img src="logo.png" alt="MontPro Logo"></div>
                    <span class="brand-text">MontPro Financier - Generator</span>
                </div>
                <div class="nav-links">
                    <a href="https://financier.montpro.xyz" class="nav-link">← Back to Home</a>
                    <button class="btn-nav-cta" onclick="showHistoryModal()">Load Previous Analysis</button>
                </div>
            </div>
        </nav>
        
        <!-- Enhanced Workspace Hero -->
        <div class="workspace-hero" data-aos="fade-up">
            <!-- Trust Badge -->
            <div class="trust-badge">
                <div class="trust-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        <path d="m9 12 2 2 4-4"/>
                    </svg>
                </div>
                <span><strong>99% Accuracy</strong> • Bank-Grade Security • SOC 2 Compliant • Zero Data Retention</span>
            </div>
        
            <!-- Main Hero Content -->
            <h1>Statements Generator</h1>
            <p class="hero-description">
                Replace weeks of manual work with minutes of AI precision. Generate 
                <strong>bank-approved financial statements</strong> that unlock financing opportunities, 
                processed securely with <strong>automatic data deletion</strong> after delivery.
            </p>
        
            <!-- CTA Button -->
            <div class="hero-cta">
                <button class="btn-hero-start" onclick="scrollToForms()">
                    <span>Start Generating</span>
                </button>
            </div>
        </div>

        <!-- Progress Indicator -->
        <div class="progress-indicator" data-aos="fade-up" data-aos-delay="100">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Step 1 of 4: Company Information</div>
        </div>

        <!-- Workspace Container -->
        <div class="workspace-container">
            
            <!-- Company Profile Card -->
            <div class="workspace-card active" id="companyCard" data-aos="fade-up" data-aos-delay="200">
                <h3>
                    <span class="card-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                            <polyline points="10,9 9,9 8,9"/>
                        </svg>
                    </span>
                    Executive Summary
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="companyName">Company Name</label>
                        <input type="text" id="companyName" class="form-input" placeholder="e.g. Acme Industries Ltd.">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="industry">Industry</label>
                        <select id="industry" class="form-select">
                            <option value="">Select industry</option>
                            <option value="manufacturing">Manufacturing</option>
                            <option value="retail">Retail & Trade</option>
                            <option value="services">Professional Services</option>
                            <option value="technology">Technology</option>
                            <option value="construction">Construction</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="businessSize">Business Size</label>
                        <select id="businessSize" class="form-select">
                            <option value="">Select size</option>
                            <option value="micro">Micro (1-10 employees)</option>
                            <option value="small">Small (11-50 employees)</option>
                            <option value="medium">Medium (51-250 employees)</option>
                            <option value="big">Big (250+ employees)</option>
                        </select>
                    </div>
                    <div class="form-group" data-clickable="true" onclick="openMonthPicker(this)">
                        <label class="form-label" for="reportingPeriod">Reporting Period</label>
                        <input type="month" id="reportingPeriod" class="form-input" max="2025-06">
                    </div>
                </div>
            </div>

            <!-- Document Upload Card -->
            <div class="workspace-card hidden" id="uploadCard">
                <h3>
                    <span class="card-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7,10 12,15 17,10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </span>
                    Document Processing
                </h3>
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">📄</div>
                    <div class="upload-text">Drag & drop your bank statements here</div>
                    <div class="upload-hint">Click to browse. We only accept PDF files for your security.</div>
                    <input type="file" class="file-input" id="fileInput" multiple accept=".pdf">
                </div>
                <div class="file-list" id="fileList"></div>

                <div class="generate-action" id="uploadActions" style="display: none;">
                    <div class="generate-container">
                        <button class="btn-generate-premium" id="generateBtn" onclick="startAnalysis()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="4" y="4" width="16" height="16" rx="2"/>
                                <rect x="9" y="9" width="6" height="6"/>
                                <line x1="9" y1="1" x2="9" y2="4"/>
                                <line x1="15" y1="1" x2="15" y2="4"/>
                                <line x1="9" y1="20" x2="9" y2="23"/>
                                <line x1="15" y1="20" x2="15" y2="23"/>
                                <line x1="20" y1="9" x2="23" y2="9"/>
                                <line x1="20" y1="14" x2="23" y2="14"/>
                                <line x1="1" y1="9" x2="4" y2="9"/>
                                <line x1="1" y1="14" x2="4" y2="14"/>
                            </svg>
                            <span class="btn-generate-title">Generate Financial Statements</span>
                            <span class="btn-generate-arrow">→</span>
                        </button>
                        <div class="generate-features">
                            <div class="feature-badge">✓ Income Statement</div>
                            <div class="feature-badge">✓ Balance Sheet</div>
                            <div class="feature-badge">✓ Cash Flow</div>
                            <div class="feature-badge">✓ Financial Ratios</div>
                            <div class="feature-badge">✓ Insights Generator</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Processing Card -->
            <div class="workspace-card hidden" id="processingCard">
                <h3>
                    <span class="card-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            <polyline points="7.5,4.21 12,6.81 16.5,4.21"/>
                            <polyline points="7.5,19.79 7.5,14.6 3,12"/>
                            <polyline points="21,12 16.5,14.6 16.5,19.79"/>
                            <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
                            <line x1="12" y1="22.08" x2="12" y2="12"/>
                        </svg>
                    </span>
                    Intelligence Processing
                </h3>
                
                <!-- Modern Processing Animation -->
                <div class="modern-processing-container">
                    <!-- Central AI Hub -->
                    <div class="ai-processing-hub">
                        <div class="hub-core">
                            <div class="core-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="4" y="4" width="16" height="16" rx="2"/>
                                    <rect x="9" y="9" width="6" height="6"/>
                                    <line x1="9" y1="1" x2="9" y2="4"/>
                                    <line x1="15" y1="1" x2="15" y2="4"/>
                                    <line x1="9" y1="20" x2="9" y2="23"/>
                                    <line x1="15" y1="20" x2="15" y2="23"/>
                                    <line x1="20" y1="9" x2="23" y2="9"/>
                                    <line x1="20" y1="14" x2="23" y2="14"/>
                                    <line x1="1" y1="9" x2="4" y2="9"/>
                                    <line x1="1" y1="14" x2="4" y2="14"/>
                                </svg>
                            </div>
                            <div class="pulse-ring"></div>
                            <div class="pulse-ring-2"></div>
                        </div>
                    </div>
                    
                    <!-- Status Display -->
                    <div class="processing-status-modern">
                        <h4 id="modernProcessingTitle">Initializing AI Analysis...</h4>
                        <p id="modernProcessingSubtitle">Preparing your financial intelligence engine</p>
                    </div>
                    
                    <!-- Progress Segments -->
                    <div class="progress-segments">
                        <div class="segment segment-1"></div>
                        <div class="segment segment-2"></div>
                        <div class="segment segment-3"></div>
                        <div class="segment segment-4"></div>
                    </div>
                    
                    <!-- Progress Percentage -->
                    <div class="progress-percentage">
                        <span id="modernProgressPercent">0%</span>
                        <span class="progress-label">Complete</span>
                    </div>
                </div>
            </div>

            <!-- Results Card -->
            <div class="workspace-card hidden" id="resultsCard">
                <h3>
                    <span class="card-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                            <path d="m9 16 2 2 4-4"/>
                        </svg>
                    </span>
                    Financial Intelligence Dashboard
                </h3>
                
                <!-- Report Navigation Tabs -->
                <div class="report-tabs">
                    <button class="tab-btn active" onclick="showReport('income')">Income Statement</button>
                    <button class="tab-btn" onclick="showReport('balance')">Balance Sheet</button>
                    <button class="tab-btn" onclick="showReport('cashflow')">Cash Flow Statement</button>
                    <button class="tab-btn" onclick="showReport('ratios')">Financial Ratios</button>
                    <button class="tab-btn" onclick="showReport('insights')">Insights Generator</button>
                </div>
            
                <!-- Income Statement Report -->
                <div class="report-container active" id="incomeReport">
                    <div class="report-header">
                        <h4>Income Statement</h4>
                        <p>For the period ending <span id="reportPeriod1">December 2024</span></p>
                    </div>
                    <div class="financial-table">
                        <table>
                            <thead>
                                <tr>
                                    <th style="text-align: left;">Item</th>
                                    <th style="text-align: right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="section-header">
                                    <td><strong>Revenue</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Sales Revenue</td>
                                    <td style="text-align: right;">$125,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Service Revenue</td>
                                    <td style="text-align: right;">$45,000</td>
                                </tr>
                                <tr class="subtotal">
                                    <td><strong>Total Revenue</strong></td>
                                    <td style="text-align: right;"><strong>$170,000</strong></td>
                                </tr>
                                <tr class="section-header">
                                    <td><strong>Expenses</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Cost of Goods Sold</td>
                                    <td style="text-align: right;">$65,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Operating Expenses</td>
                                    <td style="text-align: right;">$45,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Interest Expense</td>
                                    <td style="text-align: right;">$2,500</td>
                                </tr>
                                <tr class="subtotal">
                                    <td><strong>Total Expenses</strong></td>
                                    <td style="text-align: right;"><strong>$112,500</strong></td>
                                </tr>
                                <tr class="total-line">
                                    <td><strong>Net Income</strong></td>
                                    <td style="text-align: right;"><strong>$57,500</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            
                <!-- Balance Sheet Report -->
                <div class="report-container" id="balanceReport">
                    <div class="report-header">
                        <h4>Balance Sheet</h4>
                        <p>As of <span id="reportPeriod2">December 31, 2024</span></p>
                    </div>
                    <div class="financial-table">
                        <table>
                            <thead>
                                <tr>
                                    <th style="text-align: left;">Item</th>
                                    <th style="text-align: right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="section-header">
                                    <td><strong>Assets</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Cash and Cash Equivalents</td>
                                    <td style="text-align: right;">$85,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Accounts Receivable</td>
                                    <td style="text-align: right;">$35,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Inventory</td>
                                    <td style="text-align: right;">$25,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Property, Plant & Equipment</td>
                                    <td style="text-align: right;">$120,000</td>
                                </tr>
                                <tr class="subtotal">
                                    <td><strong>Total Assets</strong></td>
                                    <td style="text-align: right;"><strong>$265,000</strong></td>
                                </tr>
                                <tr class="section-header">
                                    <td><strong>Liabilities</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Accounts Payable</td>
                                    <td style="text-align: right;">$15,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Short-term Debt</td>
                                    <td style="text-align: right;">$25,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Long-term Debt</td>
                                    <td style="text-align: right;">$80,000</td>
                                </tr>
                                <tr class="subtotal">
                                    <td><strong>Total Liabilities</strong></td>
                                    <td style="text-align: right;"><strong>$120,000</strong></td>
                                </tr>
                                <tr class="section-header">
                                    <td><strong>Equity</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Owner's Capital</td>
                                    <td style="text-align: right;">$87,500</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Retained Earnings</td>
                                    <td style="text-align: right;">$57,500</td>
                                </tr>
                                <tr class="subtotal">
                                    <td><strong>Total Equity</strong></td>
                                    <td style="text-align: right;"><strong>$145,000</strong></td>
                                </tr>
                                <tr class="total-line">
                                    <td><strong>Total Liabilities & Equity</strong></td>
                                    <td style="text-align: right;"><strong>$265,000</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            
                <!-- Cash Flow Statement Report -->
                <div class="report-container" id="cashflowReport">
                    <div class="report-header">
                        <h4>Cash Flow Statement</h4>
                        <p>For the period ending <span id="reportPeriod3">December 2024</span></p>
                    </div>
                    <div class="financial-table">
                        <table>
                            <thead>
                                <tr>
                                    <th style="text-align: left;">Item</th>
                                    <th style="text-align: right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="section-header">
                                    <td><strong>Operating Activities</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Net Income</td>
                                    <td style="text-align: right;">$57,500</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Depreciation</td>
                                    <td style="text-align: right;">$8,000</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Changes in Working Capital</td>
                                    <td style="text-align: right;">($5,000)</td>
                                </tr>
                                <tr class="subtotal">
                                    <td><strong>Net Cash from Operating</strong></td>
                                    <td style="text-align: right;"><strong>$60,500</strong></td>
                                </tr>
                                <tr class="section-header">
                                    <td><strong>Investing Activities</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Equipment Purchase</td>
                                    <td style="text-align: right;">($15,000)</td>
                                </tr>
                                <tr class="subtotal">
                                    <td><strong>Net Cash from Investing</strong></td>
                                    <td style="text-align: right;"><strong>($15,000)</strong></td>
                                </tr>
                                <tr class="section-header">
                                    <td><strong>Financing Activities</strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Loan Repayment</td>
                                    <td style="text-align: right;">($10,000)</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;&nbsp;Owner Contributions</td>
                                    <td style="text-align: right;">$15,000</td>
                                </tr>
                                <tr class="subtotal">
                                    <td><strong>Net Cash from Financing</strong></td>
                                    <td style="text-align: right;"><strong>$5,000</strong></td>
                                </tr>
                                <tr class="total-line">
                                    <td><strong>Net Change in Cash</strong></td>
                                    <td style="text-align: right;"><strong>$50,500</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Financial Ratios Report -->
                <div class="report-container" id="ratiosReport">
                    <div class="report-header">
                        <h4>Financial Ratios Analysis</h4>
                        <p>For the period ending <span id="reportPeriod4">December 2024</span></p>
                    </div>
                    
                    <div class="ratios-grid">
                        <!-- Profitability Ratios -->
                        <div class="ratio-category-card">
                            <div class="ratio-category-header">
                                <div class="ratio-category-icon icon-profitability">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="22,6 12,13 8,9 2,15"/>
                                        <polyline points="16,6 22,6 22,12"/>
                                    </svg>
                                </div>
                                <h5>Profitability Ratios</h5>
                            </div>
                            <div class="ratio-items" id="profitabilityRatios"></div>
                        </div>
                        
                        <!-- Liquidity Ratios -->
                        <div class="ratio-category-card">
                            <div class="ratio-category-header">
                                <div class="ratio-category-icon icon-liquidity">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
                                    </svg>
                                </div>
                                <h5>Liquidity Ratios</h5>
                            </div>
                            <div class="ratio-items" id="liquidityRatios"></div>
                        </div>
                        
                        <!-- Solvency & Leverage Ratios -->
                        <div class="ratio-category-card">
                            <div class="ratio-category-header">
                                <div class="ratio-category-icon icon-solvency">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                        <path d="M8 14h.01"/>
                                        <path d="M12 14h.01"/>
                                        <path d="M16 14h.01"/>
                                        <path d="M8 18h.01"/>
                                        <path d="M12 18h.01"/>
                                        <path d="M16 18h.01"/>
                                    </svg>
                                </div>
                                <h5>Solvency & Leverage</h5>
                            </div>
                            <div class="ratio-items" id="solvencyRatios"></div>
                        </div>
                        
                        <!-- Efficiency & Activity Ratios -->
                        <div class="ratio-category-card">
                            <div class="ratio-category-header">
                                <div class="ratio-category-icon icon-efficiency">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="13,2 3,14 12,14 11,22 21,10 12,10"/>
                                    </svg>
                                </div>
                                <h5>Efficiency & Activity</h5>
                            </div>
                            <div class="ratio-items" id="efficiencyRatios"></div>
                        </div>
                        
                        <!-- Cash Flow & Coverage Ratios -->
                        <div class="ratio-category-card">
                            <div class="ratio-category-header">
                                <div class="ratio-category-icon icon-cashflow">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="1" x2="12" y2="23"/>
                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                    </svg>
                                </div>
                                <h5>Cash Flow & Coverage</h5>
                            </div>
                            <div class="ratio-items" id="cashflowRatios"></div>
                        </div>
                        
                        <!-- Market & Valuation Ratios -->
                        <div class="ratio-category-card">
                            <div class="ratio-category-header">
                                <div class="ratio-category-icon icon-market">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                        <line x1="8" y1="21" x2="16" y2="21"/>
                                        <line x1="12" y1="17" x2="12" y2="21"/>
                                        <path d="M6 11h4"/>
                                        <path d="M6 7h8"/>
                                        <path d="M18 7v4"/>
                                    </svg>
                                </div>
                                <h5>Market & Valuation</h5>
                            </div>
                            <div class="ratio-items" id="marketRatios"></div>
                        </div>
                    </div>
                </div>

                <!-- Financial Insights Report -->
                <div class="report-container" id="insightsReport">
                    <div class="report-header">
                        <h4>Financial Insights</h4>
                        <p>Smart insights for <span id="reportPeriod5">December 2024</span></p>
                    </div>
                    
                    <div class="insights-content" id="insightsContent">
                        <div class="insights-trigger">
                            <div class="trigger-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 21h6"/>
                                    <path d="M12 17h.01"/>
                                    <path d="M12 3a6.5 6.5 0 0 1 3.5 12"/>
                                    <path d="M12 3a6.5 6.5 0 0 0-3.5 12"/>
                                    <path d="M9 17h6"/>
                                </svg>
                            </div>
                            <h3>Generate AI Insights</h3>
                            <p>Get personalized financial insights and actionable recommendations</p>
                            <button class="btn-generate-insights" onclick="generateInsights()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="13,2 3,14 12,14 11,22 21,10 12,10"/>
                                </svg>
                                <span>Generate Insights</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clean Export Toolbar -->
            <div class="export-toolbar">
                <div class="export-actions">
                    <button class="btn btn-secondary export-btn" onclick="showExportModal('pdf')" id="exportPdfBtn">
                        <span class="export-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10,9 9,9 8,9"/>
                            </svg>
                        </span>
                        Export to PDF
                    </button>
                    <button class="btn btn-secondary export-btn" onclick="showExportModal('csv')" id="exportCsvBtn">
                        <span class="export-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="9" y1="13" x2="15" y2="13"/>
                                <line x1="9" y1="17" x2="15" y2="17"/>
                            </svg>
                        </span>
                        Export to CSV
                    </button>
                </div>
                <div class="export-options">
                    <select class="export-select" id="currencySelect" onchange="changeCurrency()">
                        <option value="IDR">Indonesian Rupiah (Rp)</option>
                        <option value="USD">US Dollar ($)</option>
                        <option value="EUR">Euro (€)</option>
                        <option value="SGD">Singapore Dollar (S$)</option>
                    </select>
                </div>
            </div>

            <div class="action-bar">
                <button class="btn btn-secondary" onclick="resetWorkspace()">Generate New Report</button>
                <button class="btn btn-primary">Analyze Creditworthiness →</button>
            </div>
            
        </div>
    </div>

    <!-- AOS Script -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({
            duration: 750,
            once: false,
        });
    </script>

    <script>
        // Progressive form logic
        let currentStep = 1;
        let uploadedFiles = [];

        // Elements
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const companyCard = document.getElementById('companyCard');
        const uploadCard = document.getElementById('uploadCard');
        const processingCard = document.getElementById('processingCard');
        const resultsCard = document.getElementById('resultsCard');

        // Form validation and progression
        function validateCompanyInfo() {
            const companyName = document.getElementById('companyName').value.trim();
            const industry = document.getElementById('industry').value;
            const businessSize = document.getElementById('businessSize').value;
            const reportingPeriod = document.getElementById('reportingPeriod').value;
            
            return companyName && industry && businessSize && reportingPeriod;
        }
        
        function updateProgress(step) {
            const progressPercentages = [25, 50, 75, 100];
            const progressTexts = [
                'Step 1 of 4: Company Information',
                'Step 2 of 4: Document Upload',
                'Step 3 of 4: Processing Data',
                'Step 4 of 4: Results Ready'
            ];
            
            progressFill.style.width = progressPercentages[step - 1] + '%';
            progressText.textContent = progressTexts[step - 1];
        }

        // Enhanced Progress System
        let progressInterval;
        let currentProgress = 0;
        let progressSpeed = 1;
        
        function startSatisfyingProgress() {
            currentProgress = 0;
            progressSpeed = 1;
            
            // Calculate total estimated time based on uploaded files
            const totalSize = uploadedFiles.reduce((sum, file) => sum + file.size, 0);
            const totalSizeMB = totalSize / 1024 / 1024;
            
            let estimatedSeconds;
            if (totalSizeMB < 5) {
                estimatedSeconds = 30;
            } else if (totalSizeMB < 10) {
                estimatedSeconds = 60;
            } else {
                estimatedSeconds = 90;
            }
            
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            // Add smooth CSS transition
            progressFill.style.transition = 'width 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
            
            let timeRemaining = estimatedSeconds;
            
            progressInterval = setInterval(() => {
                if (currentProgress < 95) {
                    // Variable speed logic (same as before)
                    if (currentProgress < 20) {
                        progressSpeed = 0.5 + Math.random() * 1;
                    } else if (currentProgress < 70) {
                        progressSpeed = 1.5 + Math.random() * 2;
                    } else {
                        progressSpeed = 0.3 + Math.random() * 0.5;
                    }
                    
                    currentProgress += progressSpeed;
                    currentProgress = Math.min(currentProgress, 95);
                    
                    // Update time remaining
                    timeRemaining = Math.max(0, Math.round(estimatedSeconds * (1 - currentProgress / 100)));
                    
                    progressFill.style.width = currentProgress + '%';
                    
                    // Dynamic text with time estimates
                    const roundedProgress = Math.round(currentProgress);
                    let statusText = '';
                    
                    if (currentProgress < 25) {
                        statusText = 'Reading your bank statements...';
                    } else if (currentProgress < 50) {
                        statusText = 'Analyzing transaction patterns...';
                    } else if (currentProgress < 75) {
                        statusText = 'Building financial statements...';
                    } else {
                        statusText = 'Applying finishing touches...';
                    }
                    
                    progressText.textContent = `${roundedProgress}% Complete - ${statusText} (${timeRemaining}s remaining)`;
                    
                    // Milestone effects (same as before)
                    if (roundedProgress === 25 || roundedProgress === 50 || roundedProgress === 75) {
                        progressFill.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.6)';
                        setTimeout(() => {
                            progressFill.style.boxShadow = 'none';
                        }, 500);
                    }
                }
            }, 400);
        }
        
        function completeProgressSatisfying() {
            clearInterval(progressInterval);
            
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            // Dramatic completion
            progressFill.style.transition = 'width 1.2s cubic-bezier(0.2, 0, 0, 1)';
            progressFill.style.width = '100%';
            progressText.textContent = '100% Complete - Your financial statements are ready! ✨';
            
            // Success glow effect
            progressFill.style.background = 'linear-gradient(135deg, #10B981, #059669)';
            progressFill.style.boxShadow = '0 0 30px rgba(16, 185, 129, 0.5)';
            
            // Reset after a moment
            setTimeout(() => {
                progressFill.style.background = 'linear-gradient(135deg, #1E40AF, #60A5FA)';
                progressFill.style.boxShadow = 'none';
            }, 2000);
        }

        function showCard(card) {
            card.classList.remove('hidden');
            card.classList.add('active');
            
            // Smooth scroll to the newly shown card with proper timing
            setTimeout(() => {
                const cardTop = card.offsetTop;
                const navHeight = 70; // Height of the fixed navigation
                const offset = navHeight + 20; // Extra spacing
                
                window.scrollTo({
                    top: cardTop - offset,
                    behavior: 'smooth'
                });
            }, 300); // Give the card time to fully render before scrolling
        }

        // Company info validation
        document.addEventListener('input', (e) => {
            if (['companyName', 'industry', 'businessSize', 'reportingPeriod'].includes(e.target.id)) {
                if (validateCompanyInfo() && currentStep === 1) {
                    currentStep = 2;
                    updateProgress(2);
                    setTimeout(() => showCard(uploadCard), 500);
                }
            }
        });

        // File upload handling - CORRECTED VERSION
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        
        // Only trigger file input on click, not the zone
        uploadZone.addEventListener('click', (e) => {
            // Prevent triggering if clicking on the input itself
            if (e.target !== fileInput) {
                fileInput.click();
            }
        });
        
        // Remove the existing change listener and replace with this
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFiles(e.target.files);
                // Clear the input to allow same file to be selected again
                e.target.value = '';
            }
        });
        
        // Drag and drop (keep as is)
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        function handleFiles(files) {
            const pdfFiles = Array.from(files).filter(file => file.type === 'application/pdf');
            
            if (pdfFiles.length === 0) {
                showFileError('Only PDF files are accepted for bank statements.');
                return;
            }
            
            // Process each file with validation
            pdfFiles.forEach(file => {
                validateAndAddFile(file);
            });
            
            // Show generate button if we have valid files
            if (uploadedFiles.length > 0) {
                document.getElementById('uploadActions').style.display = 'block';
            }
        }
        
        function validateAndAddFile(file) {
            const fileSize = file.size;
            const fileSizeMB = (fileSize / 1024 / 1024).toFixed(1);
            
            // Basic PDF validation (you can enhance this)
            const isValidSize = fileSize > 1000 && fileSize < 50 * 1024 * 1024; // 1KB to 50MB
            
            if (!isValidSize) {
                showFileError(`File "${file.name}" is too large or too small. Please upload files between 1KB and 50MB.`);
                return;
            }
            
            // Add to uploaded files
            uploadedFiles.push(file);
            
            // Show immediate validation feedback
            showFileValidation(file, fileSizeMB);
            
            // Update file list
            updateFileList();
        }
        
        function showFileValidation(file, fileSizeMB) {
            const fileName = file.name;
            const fileSize = file.size;
            
            // Estimate processing time
            let estimatedTime;
            if (fileSize < 5 * 1024 * 1024) { // < 5MB
                estimatedTime = '~30 seconds';
            } else if (fileSize < 10 * 1024 * 1024) { // 5-10MB
                estimatedTime = '~60 seconds';
            } else {
                estimatedTime = '~90 seconds';
            }
            
            // Create validation notification
            const notification = document.createElement('div');
            notification.className = 'file-validation-success';
            notification.innerHTML = `
                <div class="validation-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20,6 9,17 4,12"/>
                    </svg>
                </div>
                <div class="validation-text">
                    <div class="validation-main">✓ Valid bank statement detected</div>
                    <div class="validation-details">PDF, ${fileSizeMB}MB • Est. processing: ${estimatedTime}</div>
                </div>
            `;
            
            // Add to file list (it will be replaced by updateFileList, but shows immediate feedback)
            document.getElementById('fileList').appendChild(notification);
            
            // Remove after file list updates
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }
        
        function showFileError(message) {
            const notification = document.createElement('div');
            notification.className = 'file-validation-error';
            notification.innerHTML = `
                <div class="validation-icon error">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                </div>
                <div class="validation-text">
                    <div class="validation-main">⚠ Upload Error</div>
                    <div class="validation-details">${message}</div>
                </div>
            `;
            
            document.getElementById('fileList').appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        function startAnalysis() {
            if (uploadedFiles.length === 0) {
                alert('Please upload at least one bank statement to continue.');
                return;
            }
            
            // Reset processing animation state
            resetProcessingAnimation();
            
            // Prepare form data
            const formData = new FormData();
            
            // Add company information
            formData.append('companyName', document.getElementById('companyName').value);
            formData.append('industry', document.getElementById('industry').value);
            formData.append('businessSize', document.getElementById('businessSize').value);
            formData.append('reportingPeriod', document.getElementById('reportingPeriod').value);
            
            // Add files
            uploadedFiles.forEach((file, index) => {
                formData.append(`bankStatement_${index}`, file);
            });
            
            // Add metadata
            formData.append('timestamp', new Date().toISOString());
            formData.append('totalFiles', uploadedFiles.length);
            
            // Start UI processing
            currentStep = 3;
            updateProgress(3);
            showCard(processingCard);
        
            startSatisfyingProgress();
            startModernProcessing();
            
            // Send to backend
            sendToBackend(formData);
        }

        function resetProcessingAnimation() {
            // Reset the processing animation to initial state
            const processingAnimation = document.querySelector('.processing-animation');
            if (processingAnimation) {
                processingAnimation.innerHTML = `
                    <div class="ai-processor-compact">
                        <div class="processor-core">
                            <div class="processor-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="4" y="4" width="16" height="16" rx="2"/>
                                    <rect x="9" y="9" width="6" height="6"/>
                                    <line x1="9" y1="1" x2="9" y2="4"/>
                                    <line x1="15" y1="1" x2="15" y2="4"/>
                                    <line x1="9" y1="20" x2="9" y2="23"/>
                                    <line x1="15" y1="20" x2="15" y2="23"/>
                                    <line x1="20" y1="9" x2="23" y2="9"/>
                                    <line x1="20" y1="14" x2="23" y2="14"/>
                                    <line x1="1" y1="9" x2="4" y2="9"/>
                                    <line x1="1" y1="14" x2="4" y2="14"/>
                                </svg>
                            </div>
                        </div>
                        <div class="processing-dots">
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                        </div>
                    </div>
                    <div class="processing-status-compact">
                        <h4>AI Processing Your Financial Data</h4>
                        <p>Analyzing transaction patterns and building statements...</p>
                    </div>
                `;
            }
            
            // Reset all processing steps to initial state
            const steps = document.querySelectorAll('.processing-step');
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed');
                step.querySelector('.step-indicator').textContent = index + 1;
            });
            
            // Clear any existing intervals
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            if (window.processingInterval) {
                clearInterval(window.processingInterval);
            }
            
            // Reset progress variables
            currentProgress = 0;
            progressSpeed = 1;
        }
        
        async function sendToBackend(formData) {
            try {
                const response = await fetch('https://montpro.app.n8n.cloud/webhook/financier-generator', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                handleBackendResponse(result);
                
            } catch (error) {
                console.error('Backend error:', error);
                alert('Error processing your files. Please try again.');
                // Reset to upload step
                currentStep = 2;
                updateProgress(2);
            }
        }
        
        function handleBackendResponse(data) {
            completeProgressSatisfying();
            // Stop the processing animation immediately
            if (window.processingInterval) {
                clearInterval(window.processingInterval);
            }
            
            // Replace spinner with success checkmark
            const processingAnimation = document.querySelector('.processing-animation');
            if (processingAnimation) {
                processingAnimation.innerHTML = `
                    <div style="width: 60px; height: 60px; background: #10B981; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; color: white; font-size: 1.5rem;">
                        ✓
                    </div>
                    <h4 style="color: #10B981; margin-bottom: 16px;">Processing Complete!</h4>
                    <p style="color: #94A3B8;">Your financial statements are ready</p>
                `;
            }
            
            // Complete all processing steps instantly
            const steps = document.querySelectorAll('.processing-step');
            steps.forEach(step => {
                step.classList.remove('active');
                step.classList.add('completed');
                step.querySelector('.step-indicator').textContent = '✓';
            });
            
            // Handle array response format from your backend
            const result = Array.isArray(data) ? data[0] : data;
            
            if (result.status === 'processing') {
                // Backend is still processing, poll for updates
                pollForResults(result.jobId);
            } else if (result.status === 'complete') {
                // Parse the JSON strings from backend into objects
                const financialStatements = {
                    incomeStatement: JSON.parse(result.financialStatements.incomeStatement).incomeStatement,
                    balanceSheet: JSON.parse(result.financialStatements.balanceSheet).balanceSheet,
                    cashFlow: JSON.parse(result.financialStatements.cashFlow).cashFlow
                };
                
                // Processing complete, show results
                populateResults(financialStatements);
                saveAnalysis(financialStatements);
                
                currentStep = 4;
                updateProgress(4);
                setTimeout(() => {
                    showCard(resultsCard);
                    // Hide completed steps after results are shown
                    hideCompletedSteps();
                }, 500);
            }
        }

        function populateResults(financialStatements) {
            window.currentFinancialData = financialStatements;
            // Update company info in report headers
            const reportingPeriod = document.getElementById('reportingPeriod').value;
            const periodText = formatReportingPeriod(reportingPeriod);
            
            document.getElementById('reportPeriod1').textContent = periodText;
            document.getElementById('reportPeriod2').textContent = periodText;
            document.getElementById('reportPeriod3').textContent = periodText;
            document.getElementById('reportPeriod4').textContent = periodText;
            document.getElementById('reportPeriod5').textContent = periodText;
            
            // Populate each statement
            populateIncomeStatement(financialStatements.incomeStatement);
            populateBalanceSheet(financialStatements.balanceSheet);
            populateCashFlowStatement(financialStatements.cashFlow);
            populateFinancialRatios(financialStatements);
        }
        
        function formatReportingPeriod(period) {
            const periodMap = {
                'jan-2025': 'January 2025',
                'dec-2024': 'December 2024',
                'nov-2024': 'November 2024',
                'oct-2024': 'October 2024',
                'sep-2024': 'September 2024',
                'aug-2024': 'August 2024'
            };
            return periodMap[period] || period;
        }
        
        function formatCurrency(amount) {
            const currency = document.getElementById('currencySelect').value;
            
            const formatOptions = {
                'IDR': { locale: 'id-ID', currency: 'IDR' },
                'USD': { locale: 'en-US', currency: 'USD' },
                'EUR': { locale: 'de-DE', currency: 'EUR' },
                'SGD': { locale: 'en-SG', currency: 'SGD' }
            };
            
            const config = formatOptions[currency] || formatOptions['IDR'];
            
            return new Intl.NumberFormat(config.locale, {
                style: 'currency',
                currency: config.currency,
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function changeCurrency() {
            // Re-populate all visible reports with new currency
            const activeReport = document.querySelector('.report-container.active');
            if (!activeReport) return;
            
            // Get the stored financial data (we need to store this globally)
            if (window.currentFinancialData) {
                populateResults(window.currentFinancialData);
            }
        }
        
        function populateIncomeStatement(incomeData) {
            const incomeTable = document.querySelector('#incomeReport tbody');
            
            // Helper function to add rows only if they have values
            function addRowIfValue(label, amount, isSubtotal = false, isTotal = false, indent = false) {
                if (amount && amount !== 0) {
                    const rowClass = isTotal ? 'total-line' : (isSubtotal ? 'subtotal' : '');
                    const labelText = indent ? `&nbsp;&nbsp;${label}` : label;
                    return `
                        <tr class="${rowClass}">
                            <td>${labelText}</td>
                            <td style="text-align: right;">${isSubtotal || isTotal ? '<strong>' : ''}${formatCurrency(amount)}${isSubtotal || isTotal ? '</strong>' : ''}</td>
                        </tr>
                    `;
                }
                return '';
            }
            
            function addSectionHeader(title) {
                return `
                    <tr class="section-header">
                        <td><strong>${title}</strong></td>
                        <td></td>
                    </tr>
                `;
            }
            
            let html = '';
            
            // REVENUE SECTION
            html += addSectionHeader('Revenue');
            
            // Individual revenue items
            incomeData.revenue.forEach(item => {
                html += addRowIfValue(item.item, item.amount, false, false, true);
            });
            
            // Calculate Net Revenue - sum ALL revenue items
            const totalRevenue = incomeData.revenue.reduce((sum, item) => sum + item.amount, 0);
            const discounts = incomeData.revenue.find(item => item.item.toLowerCase().includes('discount'))?.amount || 0;
            const netRevenue = totalRevenue - discounts;
            
            html += addRowIfValue('Net Revenue', netRevenue, true);
            
            // COST OF GOODS SOLD SECTION
            const cogsItems = incomeData.expenses.filter(item => 
                item.item.toLowerCase().includes('cost of goods sold') ||
                item.item.toLowerCase().includes('direct materials') ||
                item.item.toLowerCase().includes('direct labor') ||
                item.item.toLowerCase().includes('manufacturing overhead')
            );
            
            if (cogsItems.length > 0) {
                html += addSectionHeader('Cost of Goods Sold (COGS)');
                cogsItems.forEach(item => {
                    html += addRowIfValue(item.item, item.amount, false, false, true);
                });
                
                const totalCOGS = cogsItems.reduce((sum, item) => sum + item.amount, 0);
                const grossProfit = netRevenue - totalCOGS;
                html += addRowIfValue('Gross Profit', grossProfit, true);
                
                // Store for global use
                window.calculatedGrossProfit = grossProfit;
            } else {
                // If no COGS found, gross profit equals net revenue
                window.calculatedGrossProfit = netRevenue;
            }
            
            // OPERATING EXPENSES SECTION
            const operatingExpenses = incomeData.expenses.filter(item => 
                !item.item.toLowerCase().includes('cost of goods sold') &&
                !item.item.toLowerCase().includes('direct materials') &&
                !item.item.toLowerCase().includes('direct labor') &&
                !item.item.toLowerCase().includes('manufacturing overhead') &&
                !item.item.toLowerCase().includes('depreciation') &&
                !item.item.toLowerCase().includes('amortization') &&
                !item.item.toLowerCase().includes('interest') &&
                !item.item.toLowerCase().includes('tax')
            );
            
            if (operatingExpenses.length > 0) {
                html += addSectionHeader('Operating Expenses');
                operatingExpenses.forEach(item => {
                    html += addRowIfValue(item.item, item.amount, false, false, true);
                });
            }
            
            // Calculate EBITDA
            const totalOperatingExpenses = operatingExpenses.reduce((sum, item) => sum + item.amount, 0);
            const totalCOGS = cogsItems.reduce((sum, item) => sum + item.amount, 0);
            const grossProfit = window.calculatedGrossProfit || netRevenue;
            const ebitda = grossProfit - totalOperatingExpenses;
            html += addRowIfValue('EBITDA', ebitda, true);
            
            // Store for global use
            window.calculatedEBITDA = ebitda;
            
            // DEPRECIATION & AMORTIZATION
            const depreciationItems = incomeData.expenses.filter(item => 
                item.item.toLowerCase().includes('depreciation') ||
                item.item.toLowerCase().includes('amortization')
            );
            
            if (depreciationItems.length > 0) {
                depreciationItems.forEach(item => {
                    html += addRowIfValue(item.item, item.amount, false, false, true);
                });
            }
            
            // Calculate Operating Profit
            const totalDepreciation = depreciationItems.reduce((sum, item) => sum + item.amount, 0);
            const operatingProfit = ebitda - totalDepreciation;
            html += addRowIfValue('Operating Profit', operatingProfit, true);
            
            // NON-OPERATING ITEMS
            html += addSectionHeader('Non-Operating Items');
            
            const interestIncome = incomeData.revenue.find(item => item.item.toLowerCase().includes('interest income'))?.amount || 0;
            const interestExpense = incomeData.expenses.find(item => item.item.toLowerCase().includes('interest'))?.amount || 0;
            const otherIncome = incomeData.revenue.find(item => item.item.toLowerCase().includes('other') && !item.item.toLowerCase().includes('revenue'))?.amount || 0;
            
            html += addRowIfValue('Interest Income', interestIncome, false, false, true);
            html += addRowIfValue('Interest Expense', interestExpense, false, false, true);
            html += addRowIfValue('Other Income', otherIncome, false, false, true);
            
            // Calculate EBT (Earnings Before Tax)
            const ebt = operatingProfit + interestIncome - interestExpense + otherIncome;
            html += addRowIfValue('EBT (Earnings Before Tax)', ebt, true);
            
            // TAX EXPENSES
            const taxExpenses = incomeData.expenses.filter(item => 
                item.item.toLowerCase().includes('tax') && 
                !item.item.toLowerCase().includes('before tax')
            );
            
            if (taxExpenses.length > 0) {
                taxExpenses.forEach(item => {
                    html += addRowIfValue(item.item, item.amount, false, false, true);
                });
            }
            
            // Calculate Net Income
            const totalTaxes = taxExpenses.reduce((sum, item) => sum + item.amount, 0);
            const netIncome = ebt - totalTaxes;
            
            html += addRowIfValue('Net Income', netIncome, false, true);
            
            incomeTable.innerHTML = html;

            window.calculatedNetIncome = netIncome;
            window.calculatedDepreciation = totalDepreciation;
        }
        
        function populateBalanceSheet(balanceData) {
            const balanceTable = document.querySelector('#balanceReport tbody');
            
            // Helper function to add rows only if they have values
            function addRowIfValue(label, amount, isSubtotal = false, isTotal = false, indent = false) {
                if (amount && amount !== 0) {
                    const rowClass = isTotal ? 'total-line' : (isSubtotal ? 'subtotal' : '');
                    const labelText = indent ? `&nbsp;&nbsp;${label}` : label;
                    return `
                        <tr class="${rowClass}">
                            <td>${labelText}</td>
                            <td style="text-align: right;">${isSubtotal || isTotal ? '<strong>' : ''}${formatCurrency(amount)}${isSubtotal || isTotal ? '</strong>' : ''}</td>
                        </tr>
                    `;
                }
                return '';
            }
            
            function addSectionHeader(title) {
                return `
                    <tr class="section-header">
                        <td><strong>${title}</strong></td>
                        <td></td>
                    </tr>
                `;
            }
            
            let html = '';
            
            // ASSETS SECTION
            html += addSectionHeader('ASSETS');
            
            // Current Assets
            const currentAssets = [
                { key: 'cash', labels: ['cash', 'cash and cash equivalents'] },
                { key: 'receivables', labels: ['accounts receivable', 'receivables'] },
                { key: 'inventory', labels: ['inventory'] },
                { key: 'prepaid', labels: ['prepaid expenses', 'prepaid'] },
                { key: 'shortInvestments', labels: ['short-term investments', 'short term investments'] },
                { key: 'otherCurrent', labels: ['other current assets'] }
            ];
            
            let currentAssetsTotal = 0;
            currentAssets.forEach(assetType => {
                const asset = balanceData.assets.find(item => 
                    assetType.labels.some(label => item.item.toLowerCase().includes(label))
                );
                if (asset && asset.amount > 0) {
                    html += addRowIfValue(asset.item, asset.amount, false, false, true);
                    currentAssetsTotal += asset.amount;
                }
            });
            
            // Non-Current Assets
            const nonCurrentAssets = [
                { key: 'ppe', labels: ['property, plant & equipment', 'property, plant and equipment', 'ppe'] },
                { key: 'intangible', labels: ['intangible assets', 'intangible'] },
                { key: 'longInvestments', labels: ['long-term investments', 'long term investments'] },
                { key: 'otherNonCurrent', labels: ['other non-current assets', 'other non current assets'] }
            ];
            
            let nonCurrentAssetsTotal = 0;
            nonCurrentAssets.forEach(assetType => {
                const asset = balanceData.assets.find(item => 
                    assetType.labels.some(label => item.item.toLowerCase().includes(label))
                );
                if (asset && asset.amount > 0) {
                    html += addRowIfValue(asset.item, asset.amount, false, false, true);
                    nonCurrentAssetsTotal += asset.amount;
                }
            });
            
            const totalAssets = currentAssetsTotal + nonCurrentAssetsTotal;
            html += addRowIfValue('Total Assets', totalAssets, false, true);
            
            // LIABILITIES SECTION
            html += addSectionHeader('LIABILITIES');
            
            // Current Liabilities
            const currentLiabilities = [
                { key: 'payables', labels: ['accounts payable', 'payables'] },
                { key: 'accrued', labels: ['accrued liabilities', 'accrued'] },
                { key: 'shortNotes', labels: ['notes payable (short-term)', 'short-term debt', 'short term debt'] },
                { key: 'taxPayable', labels: ['income tax payable', 'tax payable'] },
                { key: 'deferredRevenue', labels: ['deferred revenue'] },
                { key: 'otherCurrentLiab', labels: ['other current liabilities'] }
            ];
            
            let currentLiabilitiesTotal = 0;
            currentLiabilities.forEach(liabType => {
                const liability = balanceData.liabilities.find(item => 
                    liabType.labels.some(label => item.item.toLowerCase().includes(label))
                );
                if (liability && liability.amount > 0) {
                    html += addRowIfValue(liability.item, liability.amount, false, false, true);
                    currentLiabilitiesTotal += liability.amount;
                }
            });
            
            // Non-Current Liabilities
            const nonCurrentLiabilities = [
                { key: 'longNotes', labels: ['notes payable (long-term)', 'long-term debt', 'long term debt'] },
                { key: 'otherNonCurrentLiab', labels: ['other non-current liabilities', 'other non current liabilities'] }
            ];
            
            let nonCurrentLiabilitiesTotal = 0;
            nonCurrentLiabilities.forEach(liabType => {
                const liability = balanceData.liabilities.find(item => 
                    liabType.labels.some(label => item.item.toLowerCase().includes(label))
                );
                if (liability && liability.amount > 0) {
                    html += addRowIfValue(liability.item, liability.amount, false, false, true);
                    nonCurrentLiabilitiesTotal += liability.amount;
                }
            });
            
            const totalLiabilities = currentLiabilitiesTotal + nonCurrentLiabilitiesTotal;
            html += addRowIfValue('Total Liabilities', totalLiabilities, true);
            
            // EQUITY SECTION
            html += addSectionHeader('EQUITY');
            
            const equityItems = [
                { key: 'ownersEquity', labels: ['owner\'s equity', 'owners equity', 'owner equity', 'paid-in capital'] },
                { key: 'retainedEarnings', labels: ['retained earnings'] },
                { key: 'contributedCapital', labels: ['contributed capital', 'additional paid-in capital'] },
                { key: 'otherEquity', labels: ['other equity'] }
            ];
            
            let totalEquity = 0;
            equityItems.forEach(equityType => {
                const equity = balanceData.equity.find(item => 
                    equityType.labels.some(label => item.item.toLowerCase().includes(label.toLowerCase()))
                );
                if (equity && equity.amount > 0) {
                    html += addRowIfValue(equity.item, equity.amount, false, false, true);
                    totalEquity += equity.amount;
                }
            });
            
            // BALANCING LOGIC
            const liabilitiesAndEquity = totalLiabilities + totalEquity;
            const imbalance = totalAssets - liabilitiesAndEquity;
            
            // Add balancing adjustment if needed
            if (Math.abs(imbalance) > 0.01) { // Allow for small rounding differences
                if (imbalance > 0) {
                    // Assets > Liab + Equity, add to Other Current Liabilities
                    html += addRowIfValue('Balancing Adjustment', imbalance, false, false, true);
                    currentLiabilitiesTotal += imbalance;
                } else {
                    // Liab + Equity > Assets, add to Other Current Assets
                    html += addRowIfValue('Balancing Adjustment', Math.abs(imbalance), false, false, true);
                    currentAssetsTotal += Math.abs(imbalance);
                }
                totalEquity += imbalance > 0 ? imbalance : 0;
            }
            
            html += addRowIfValue('Total Equity', totalEquity, true);
            
            // FINAL TOTALS
            const finalLiabilitiesAndEquity = totalLiabilities + totalEquity;
            html += addRowIfValue('Total Liabilities & Equity', finalLiabilitiesAndEquity, false, true);
            
            balanceTable.innerHTML = html;
        }
        
        function populateCashFlowStatement(cashFlowData) {
            const cashFlowTable = document.querySelector('#cashflowReport tbody');
            
            // Helper function to add rows only if they have values
            function addRowIfValue(label, amount, isSubtotal = false, isTotal = false, indent = false) {
                if (amount && amount !== 0) {
                    const rowClass = isTotal ? 'total-line' : (isSubtotal ? 'subtotal' : '');
                    const labelText = indent ? `&nbsp;&nbsp;${label}` : label;
                    return `
                        <tr class="${rowClass}">
                            <td>${labelText}</td>
                            <td style="text-align: right;">${isSubtotal || isTotal ? '<strong>' : ''}${formatCurrency(amount)}${isSubtotal || isTotal ? '</strong>' : ''}</td>
                        </tr>
                    `;
                }
                return '';
            }
            
            function addSectionHeader(title, subtotal = null) {
                if (subtotal !== null) {
                    return `
                        <tr class="section-header">
                            <td><strong>${title}</strong></td>
                            <td style="text-align: right;"><strong>${formatCurrency(subtotal)}</strong></td>
                        </tr>
                    `;
                } else {
                    return `
                        <tr class="section-header">
                            <td><strong>${title}</strong></td>
                            <td></td>
                        </tr>
                    `;
                }
            }
            
            let html = '';
            
            // EXTRACT NET INCOME AND DEPRECIATION FROM INCOME STATEMENT
            // Get the calculated Net Income from Income Statement (stored globally)
            const incomeStatementNetIncome = window.calculatedNetIncome || 0;
            const incomeStatementDepreciation = window.calculatedDepreciation || 0;
            
            // Beginning Cash Balance
            const beginningBalance = cashFlowData.beginningBalance || 0;
            html += addRowIfValue('Beginning Cash Balance', beginningBalance, false, true);
            html += '<tr><td colspan="2" style="height: 12px;"></td></tr>';
            
            // OPERATING ACTIVITIES SECTION
            let operatingTotal = cashFlowData.operating.reduce((sum, item) => sum + item.amount, 0);
            
            // Extract and adjust for Net Income
            let adjustedOtherOperating = 0;
            const otherOperatingItem = cashFlowData.operating.find(item => 
                item.item.toLowerCase().includes('other operating')
            );
            
            if (otherOperatingItem) {
                adjustedOtherOperating = otherOperatingItem.amount - incomeStatementNetIncome - incomeStatementDepreciation;
            }
            
            html += addSectionHeader('CASH FLOW FROM OPERATING ACTIVITIES', operatingTotal);
            
            // Show extracted Net Income
            html += addRowIfValue('Net Income', incomeStatementNetIncome, false, false, true);
            
            // Show extracted Depreciation & Amortization
            html += addRowIfValue('Depreciation & Amortization', incomeStatementDepreciation, false, false, true);
            
            // Show other operating items (excluding the "other operating" item we're adjusting)
            cashFlowData.operating.forEach(item => {
                if (!item.item.toLowerCase().includes('other operating') && 
                    !item.item.toLowerCase().includes('net income') &&
                    !item.item.toLowerCase().includes('depreciation')) {
                    html += addRowIfValue(item.item, item.amount, false, false, true);
                }
            });
            
            // Show adjusted Other Operating Activities
            html += addRowIfValue('Other Operating Cash Flow', adjustedOtherOperating, false, false, true);
            
            // INVESTING ACTIVITIES SECTION
            const investingTotal = cashFlowData.investing.reduce((sum, item) => sum + item.amount, 0);
            html += addSectionHeader('CASH FLOW FROM INVESTING ACTIVITIES', investingTotal);
            
            cashFlowData.investing.forEach(item => {
                if (item.amount !== 0) {
                    html += addRowIfValue(item.item, item.amount, false, false, true);
                }
            });
            
            // FINANCING ACTIVITIES SECTION
            const financingTotal = cashFlowData.financing.reduce((sum, item) => sum + item.amount, 0);
            html += addSectionHeader('CASH FLOW FROM FINANCING ACTIVITIES', financingTotal);
            
            cashFlowData.financing.forEach(item => {
                if (item.amount !== 0) {
                    html += addRowIfValue(item.item, item.amount, false, false, true);
                }
            });
            
            // FINAL CALCULATIONS
            html += '<tr><td colspan="2" style="height: 12px;"></td></tr>';
            
            const netCashChange = operatingTotal + investingTotal + financingTotal;
            const endingBalance = beginningBalance + netCashChange;
            
            // Check if backend ending balance matches our calculation
            const backendEndingBalance = cashFlowData.endingBalance;
            let finalEndingBalance = endingBalance;
            
            if (backendEndingBalance && Math.abs(backendEndingBalance - endingBalance) > 0.01) {
                // There's an imbalance, adjust Other Operating Activities
                const balancingAdjustment = backendEndingBalance - endingBalance;
                adjustedOtherOperating += balancingAdjustment;
                finalEndingBalance = backendEndingBalance;
                
                // Update the Other Operating Activities row (we'll need to regenerate)
                // For now, use the backend ending balance
            }
            
            html += addRowIfValue('Net Change in Cash', netCashChange, false, true);
            html += addRowIfValue('Ending Cash Balance', finalEndingBalance, false, true);
            
            cashFlowTable.innerHTML = html;
        }

        function populateFinancialRatios(financialData) {
            const income = financialData.incomeStatement;
            const balance = financialData.balanceSheet;
            const cashFlow = financialData.cashFlow;
            
            // Calculate key totals
            const revenue = income.revenue.reduce((sum, item) => sum + item.amount, 0);
            const netIncome = window.calculatedNetIncome || 0;
            const ebit = window.calculatedOperatingProfit || 0;
            const totalAssets = balance.assets.reduce((sum, item) => sum + item.amount, 0);
            const totalLiabilities = balance.liabilities.reduce((sum, item) => sum + item.amount, 0);
            const totalEquity = balance.equity.reduce((sum, item) => sum + item.amount, 0);
            
            // Get specific items
            const currentAssets = getCurrentAssets(balance.assets);
            const currentLiabilities = getCurrentLiabilities(balance.liabilities);
            const inventory = getItemAmount(balance.assets, ['inventory']);
            const cash = getItemAmount(balance.assets, ['cash']);
            const accountsReceivable = getItemAmount(balance.assets, ['accounts receivable', 'receivable']);
            const accountsPayable = getItemAmount(balance.liabilities, ['accounts payable', 'payable']);
            const interestExpense = getItemAmount(income.expenses, ['interest expense', 'interest']);
            const cogs = getItemAmount(income.expenses, ['cost of goods sold', 'cogs']);
            const operatingCashFlow = cashFlow.operating.reduce((sum, item) => sum + item.amount, 0);
            
            // Calculate ratios by category
            const ratios = {
                profitability: calculateProfitabilityRatios(revenue, netIncome, totalAssets, totalEquity),
                liquidity: calculateLiquidityRatios(currentAssets, currentLiabilities, inventory, cash, accountsReceivable, cogs, revenue, accountsPayable),
                solvency: calculateSolvencyRatios(totalLiabilities, totalAssets, totalEquity, ebit, interestExpense),
                efficiency: calculateEfficiencyRatios(revenue, totalAssets, accountsReceivable, inventory, cogs),
                cashflow: calculateCashFlowRatios(operatingCashFlow, currentLiabilities, totalLiabilities, ebit, interestExpense),
                market: calculateMarketRatios(revenue, totalAssets, totalEquity, netIncome)
            };
            
            // Populate each category
            populateRatioCategory('profitabilityRatios', ratios.profitability);
            populateRatioCategory('liquidityRatios', ratios.liquidity);
            populateRatioCategory('solvencyRatios', ratios.solvency);
            populateRatioCategory('efficiencyRatios', ratios.efficiency);
            populateRatioCategory('cashflowRatios', ratios.cashflow);
            populateRatioCategory('marketRatios', ratios.market);
        }

        // Helper functions to extract specific data
        function getCurrentAssets(assets) {
            const currentAssetLabels = ['cash', 'accounts receivable', 'inventory', 'prepaid', 'short-term investments'];
            return assets.filter(item => 
                currentAssetLabels.some(label => item.item.toLowerCase().includes(label))
            ).reduce((sum, item) => sum + item.amount, 0);
        }
        
        function getCurrentLiabilities(liabilities) {
            const currentLiabLabels = ['accounts payable', 'accrued', 'short-term', 'tax payable', 'deferred revenue', 'current liabilities'];
            return liabilities.filter(item => 
                currentLiabLabels.some(label => item.item.toLowerCase().includes(label))
            ).reduce((sum, item) => sum + item.amount, 0);
        }
        
        function getItemAmount(items, searchLabels) {
            const item = items.find(item => 
                searchLabels.some(label => item.item.toLowerCase().includes(label))
            );
            return item ? item.amount : 0;
        }
        
        // Ratio calculation functions
        function calculateProfitabilityRatios(revenue, netIncome, totalAssets, totalEquity) {
            const grossProfit = window.calculatedGrossProfit || 0;
            const operatingProfit = window.calculatedOperatingProfit || 0;
            const ebitda = window.calculatedEBITDA || 0;
            
            return [
                {
                    name: 'Gross Margin',
                    value: revenue > 0 ? ((grossProfit / revenue) * 100) : 0,
                    format: 'percentage',
                    benchmark: { excellent: 40, good: 20, poor: 10 }
                },
                {
                    name: 'Net Margin',
                    value: revenue > 0 ? ((netIncome / revenue) * 100) : 0,
                    format: 'percentage',
                    benchmark: { excellent: 15, good: 5, poor: 0 }
                },
                {
                    name: 'Operating Margin',
                    value: revenue > 0 ? ((operatingProfit / revenue) * 100) : 0,
                    format: 'percentage',
                    benchmark: { excellent: 20, good: 10, poor: 0 }
                },
                {
                    name: 'EBITDA Margin',
                    value: revenue > 0 ? ((ebitda / revenue) * 100) : 0,
                    format: 'percentage',
                    benchmark: { excellent: 25, good: 15, poor: 5 }
                },
                {
                    name: 'Return on Assets (ROA)',
                    value: totalAssets > 0 ? ((netIncome / totalAssets) * 100) : 0,
                    format: 'percentage',
                    benchmark: { excellent: 10, good: 5, poor: 0 }
                },
                {
                    name: 'Return on Equity (ROE)',
                    value: totalEquity > 0 ? ((netIncome / totalEquity) * 100) : 0,
                    format: 'percentage',
                    benchmark: { excellent: 15, good: 10, poor: 0 }
                }
            ];
        }
        
        function calculateLiquidityRatios(currentAssets, currentLiabilities, inventory, cash, accountsReceivable, cogs, revenue, accountsPayable) {
            const workingCapital = currentAssets - currentLiabilities;
            
            // Calculate Cash Conversion Cycle components
            const daysInventoryOutstanding = inventory > 0 && cogs > 0 ? (inventory / cogs) * 365 : 0;
            const daysSalesOutstanding = accountsReceivable > 0 && revenue > 0 ? (accountsReceivable / revenue) * 365 : 0;
            
            // Calculate Days Payable Outstanding properly
            const daysPayableOutstanding = accountsPayable > 0 && cogs > 0 ? (accountsPayable / cogs) * 365 : null;
            
            // Cash Conversion Cycle - only calculate if we have all components
            let cashConversionCycle = null;
            if (daysPayableOutstanding !== null && (daysInventoryOutstanding > 0 || daysSalesOutstanding > 0)) {
                cashConversionCycle = daysInventoryOutstanding + daysSalesOutstanding - daysPayableOutstanding;
            }
            
            return [
                {
                    name: 'Current Ratio',
                    value: currentLiabilities > 0 ? (currentAssets / currentLiabilities) : 0,
                    format: 'ratio',
                    benchmark: { excellent: 2.0, good: 1.5, poor: 1.0 }
                },
                {
                    name: 'Quick Ratio',
                    value: currentLiabilities > 0 ? ((currentAssets - inventory) / currentLiabilities) : 0,
                    format: 'ratio',
                    benchmark: { excellent: 1.5, good: 1.0, poor: 0.5 }
                },
                {
                    name: 'Cash Ratio',
                    value: currentLiabilities > 0 ? (cash / currentLiabilities) : 0,
                    format: 'ratio',
                    benchmark: { excellent: 0.5, good: 0.2, poor: 0.1 }
                },
                {
                    name: 'Working Capital',
                    value: workingCapital,
                    format: 'currency',
                    benchmark: { excellent: 1000000, good: 100000, poor: 0 }
                },
                {
                    name: 'Cash Conversion Cycle',
                    value: cashConversionCycle,
                    format: 'days',
                    benchmark: { excellent: 30, good: 60, poor: 90 },
                    reverse: true
                }
            ];
        }
        
        function calculateSolvencyRatios(totalLiabilities, totalAssets, totalEquity, ebit, interestExpense) {
            return [
                {
                    name: 'Debt-to-Equity',
                    value: totalEquity > 0 ? (totalLiabilities / totalEquity) : 0,
                    format: 'ratio',
                    benchmark: { excellent: 0.3, good: 0.6, poor: 1.0 },
                    reverse: true
                },
                {
                    name: 'Debt-to-Assets',
                    value: totalAssets > 0 ? ((totalLiabilities / totalAssets) * 100) : 0,
                    format: 'percentage',
                    benchmark: { excellent: 30, good: 50, poor: 70 },
                    reverse: true
                },
                {
                    name: 'Equity Ratio',
                    value: totalAssets > 0 ? ((totalEquity / totalAssets) * 100) : 0,
                    format: 'percentage',
                    benchmark: { excellent: 70, good: 50, poor: 30 }
                },
                {
                    name: 'Times Interest Earned',
                    value: interestExpense > 0 ? (ebit / interestExpense) : 0,
                    format: 'ratio',
                    benchmark: { excellent: 5.0, good: 2.5, poor: 1.5 }
                }
            ];
        }
        
        // Updated Efficiency & Activity Ratios (expanded)
        function calculateEfficiencyRatios(revenue, totalAssets, accountsReceivable, inventory, cogs) {
            const receivablesTurnover = accountsReceivable > 0 ? (revenue / accountsReceivable) : 0;
            const inventoryTurnover = inventory > 0 ? (cogs / inventory) : 0;
            const daysSalesOutstanding = receivablesTurnover > 0 ? (365 / receivablesTurnover) : 0;
            
            return [
                {
                    name: 'Asset Turnover',
                    value: totalAssets > 0 ? (revenue / totalAssets) : 0,
                    format: 'ratio',
                    benchmark: { excellent: 1.5, good: 1.0, poor: 0.5 }
                },
                {
                    name: 'Receivables Turnover',
                    value: receivablesTurnover,
                    format: 'ratio',
                    benchmark: { excellent: 12, good: 8, poor: 4 }
                },
                {
                    name: 'Inventory Turnover',
                    value: inventoryTurnover,
                    format: 'ratio',
                    benchmark: { excellent: 8, good: 5, poor: 2 }
                },
                {
                    name: 'Days Sales Outstanding',
                    value: daysSalesOutstanding,
                    format: 'days',
                    benchmark: { excellent: 30, good: 45, poor: 60 },
                    reverse: true
                }
            ];
        }
        
        // Updated Cash Flow & Coverage Ratios (expanded)
        function calculateCashFlowRatios(operatingCashFlow, currentLiabilities, totalLiabilities, ebit, interestExpense) {
            const cashCoverage = ebit > 0 ? ((ebit + operatingCashFlow) / interestExpense) : 0;
            
            return [
                {
                    name: 'Operating Cash Flow Ratio',
                    value: currentLiabilities > 0 ? (operatingCashFlow / currentLiabilities) : 0,
                    format: 'ratio',
                    benchmark: { excellent: 0.4, good: 0.2, poor: 0.1 }
                },
                {
                    name: 'Cash Coverage Ratio',
                    value: totalLiabilities > 0 ? (operatingCashFlow / totalLiabilities) : 0,
                    format: 'ratio',
                    benchmark: { excellent: 0.3, good: 0.15, poor: 0.05 }
                },
                {
                    name: 'Cash to Debt',
                    value: interestExpense > 0 ? cashCoverage : 0,
                    format: 'ratio',
                    benchmark: { excellent: 3.0, good: 1.5, poor: 1.0 }
                }
            ];
        }
        
        // New Market & Valuation Ratios
        function calculateMarketRatios(revenue, totalAssets, totalEquity, netIncome) {
            return [
                {
                    name: 'Asset Intensity',
                    value: revenue > 0 ? (totalAssets / revenue) : 0,
                    format: 'ratio',
                    benchmark: { excellent: 0.5, good: 1.0, poor: 2.0 },
                    reverse: true
                },
                {
                    name: 'Capital Efficiency',
                    value: totalEquity > 0 ? (revenue / totalEquity) : 0,
                    format: 'ratio',
                    benchmark: { excellent: 3.0, good: 2.0, poor: 1.0 }
                },
                {
                    name: 'Equity Multiplier',
                    value: totalEquity > 0 ? (totalAssets / totalEquity) : 0,
                    format: 'ratio',
                    benchmark: { excellent: 1.5, good: 2.0, poor: 3.0 },
                    reverse: true
                }
            ];
        }
        
        function populateRatioCategory(containerId, ratios) {
            const container = document.getElementById(containerId);
            
            container.innerHTML = ratios.map(ratio => {
                const indicator = getRatioIndicator(ratio);
                const formattedValue = formatRatioValue(ratio.value, ratio.format);
                
                return `
                    <div class="ratio-item">
                        <div class="ratio-name">${ratio.name}</div>
                        <div class="ratio-value">
                            <div class="ratio-number">${formattedValue}</div>
                            <div class="ratio-indicator ${indicator}"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getRatioIndicator(ratio) {
            if (!ratio.benchmark) return 'ratio-neutral';
            
            const value = ratio.value;
            const { excellent, good, poor } = ratio.benchmark;
            const isReverse = ratio.reverse;
            
            if (isReverse) {
                if (value <= excellent) return 'ratio-excellent';
                if (value <= good) return 'ratio-good';
                if (value <= poor) return 'ratio-poor';
                return 'ratio-poor';
            } else {
                if (value >= excellent) return 'ratio-excellent';
                if (value >= good) return 'ratio-good';
                if (value >= poor) return 'ratio-poor';
                return 'ratio-poor';
            }
        }
        
        function formatRatioValue(value, format) {
            if (value === null || value === undefined) {
                return 'N/A';
            }
            
            switch (format) {
                case 'percentage':
                    return `${value.toFixed(1)}%`;
                case 'ratio':
                    return `${value.toFixed(2)}x`;
                case 'currency':
                    return formatCurrency(value);
                case 'days':
                    return `${value.toFixed(0)} days`;
                default:
                    return value.toFixed(2);
            }
        }
        
        function updateFileList() {
            fileList.innerHTML = '';
            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                            </svg>
                        </div>
                        <div class="file-details">
                            <h4>${file.name}</h4>
                            <div class="file-size">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                        </div>
                    </div>
                    <button class="file-remove" onclick="removeFile(${index})">✕</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
            
            // Hide generate button if no files left
            if (uploadedFiles.length === 0) {
                document.getElementById('uploadActions').style.display = 'none';
            }
        }

        function startModernProcessing() {
            const segments = document.querySelectorAll('.segment');
            const titleEl = document.getElementById('modernProcessingTitle');
            const subtitleEl = document.getElementById('modernProcessingSubtitle');
            const percentEl = document.getElementById('modernProgressPercent');
            
            const phases = [
                {
                    title: "Parsing Bank Statements...",
                    subtitle: "Extracting transaction data with OCR technology",
                    duration: 18000, // 18 seconds
                    startPercent: 0,
                    endPercent: 25
                },
                {
                    title: "Applying AI Classification...",
                    subtitle: "Categorizing transactions using machine learning", 
                    duration: 22000, // 22 seconds
                    startPercent: 25,
                    endPercent: 50
                },
                {
                    title: "Generating Financial Statements...",
                    subtitle: "Building comprehensive reports and calculations",
                    duration: 12000, // 12 seconds
                    startPercent: 50,
                    endPercent: 75
                },
                {
                    title: "Finalizing Executive Reports...",
                    subtitle: "Applying finishing touches and validations",
                    duration: 8000, // 8 seconds
                    startPercent: 75,
                    endPercent: 100
                }
            ];
            
            let currentPhase = 0;
            
            function updatePhase() {
                if (currentPhase < phases.length) {
                    const phase = phases[currentPhase];
                    
                    // Update text immediately
                    titleEl.textContent = phase.title;
                    subtitleEl.textContent = phase.subtitle;
                    
                    // Activate current segment
                    segments[currentPhase].classList.add('active');
                    
                    // Complete previous segments
                    for (let i = 0; i < currentPhase; i++) {
                        segments[i].classList.remove('active');
                        segments[i].classList.add('completed');
                    }
                    
                    // Smooth progress animation within this phase
                    let progress = phase.startPercent;
                    const increment = (phase.endPercent - phase.startPercent) / (phase.duration / 100);
                    
                    const progressInterval = setInterval(() => {
                        progress += increment;
                        if (progress >= phase.endPercent) {
                            progress = phase.endPercent;
                            clearInterval(progressInterval);
                            
                            // Move to next phase after completing this one
                            currentPhase++;
                            setTimeout(updatePhase, 200);
                        }
                        percentEl.textContent = `${Math.round(progress)}%`;
                    }, 100);
                }
            }
            
            // Start first phase
            updatePhase();
        }

        function showReport(reportType) {
            // Hide all reports
            document.querySelectorAll('.report-container').forEach(container => {
                container.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected report
            const reportMap = {
                'income': 'incomeReport',
                'balance': 'balanceReport', 
                'cashflow': 'cashflowReport',
                'ratios': 'ratiosReport',
                'insights': 'insightsReport'
            };
            
            document.getElementById(reportMap[reportType]).classList.add('active');
            
            // Activate clicked tab
            event.target.classList.add('active');
            
            // No auto-generation - user clicks button manually
        }

        // Storage Management System
        const STORAGE_KEY = 'montpro_analyses';
        const MAX_ANALYSES = 50;
        
        function saveAnalysis(financialData) {
            try {
                const analysis = {
                    id: generateAnalysisId(),
                    timestamp: new Date().toISOString(),
                    companyName: document.getElementById('companyName').value,
                    industry: document.getElementById('industry').value,
                    businessSize: document.getElementById('businessSize').value,
                    reportingPeriod: document.getElementById('reportingPeriod').value,
                    financialData: financialData,
                    autoGeneratedName: generateAnalysisName()
                };
        
                let savedAnalyses = getSavedAnalyses();
                
                // Add new analysis to the beginning
                savedAnalyses.unshift(analysis);
                
                // Keep only the latest 50
                if (savedAnalyses.length > MAX_ANALYSES) {
                    savedAnalyses = savedAnalyses.slice(0, MAX_ANALYSES);
                }
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(savedAnalyses));
                
                // Show save confirmation
                showSaveNotification(analysis.autoGeneratedName);
                
                return analysis.id;
            } catch (error) {
                console.error('Error saving analysis:', error);
                alert('Error saving analysis. Storage may be full.');
            }
        }
        
        function getSavedAnalyses() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                return saved ? JSON.parse(saved) : [];
            } catch (error) {
                console.error('Error loading saved analyses:', error);
                return [];
            }
        }
        
        function generateAnalysisId() {
            return 'analysis_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function generateAnalysisName() {
            const companyName = document.getElementById('companyName').value;
            const reportingPeriod = document.getElementById('reportingPeriod').value;
            const periodText = formatReportingPeriod(reportingPeriod);
            
            return `${companyName} - ${periodText}`;
        }
        
        function showSaveNotification(analysisName) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10B981, #059669);
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
                z-index: 10000;
                font-weight: 600;
                animation: slideInRight 0.3s ease;
            `;
            notification.innerHTML = `✓ Analysis saved: ${analysisName}`;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }
        
        function deleteAnalysis(analysisId) {
            let savedAnalyses = getSavedAnalyses();
            savedAnalyses = savedAnalyses.filter(analysis => analysis.id !== analysisId);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savedAnalyses));
        }
        
        function loadAnalysis(analysisId) {
            const savedAnalyses = getSavedAnalyses();
            return savedAnalyses.find(analysis => analysis.id === analysisId);
        }

        // History Dashboard Functions
        function showHistoryModal() {
            populateHistoryList();
            document.getElementById('historyModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
        
        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
            document.body.style.overflow = ''; // Restore scrolling
        }
        
        function populateHistoryList() {
            const historyList = document.getElementById('historyList');
            const historyCount = document.getElementById('historyCount');
            const savedAnalyses = getSavedAnalyses();
            
            historyCount.textContent = `${savedAnalyses.length} analyses saved`;
            
            if (savedAnalyses.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-history">
                        <h4>No analyses saved yet</h4>
                        <p>Complete an analysis to start building your history</p>
                    </div>
                `;
                return;
            }
            
            historyList.innerHTML = savedAnalyses.map(analysis => `
                <div class="history-item" data-id="${analysis.id}" onclick="handleHistoryItemClick(event, '${analysis.id}')">
                    <input type="checkbox" class="history-item-checkbox" onchange="handleCheckboxChange(event, '${analysis.id}')" onclick="event.stopPropagation()">
                    <div class="history-item-header">
                        <div class="history-item-title">${analysis.autoGeneratedName}</div>
                        <div class="history-item-date">${formatDate(analysis.timestamp)}</div>
                    </div>
                    <div class="history-item-details">
                        <div class="history-detail-badge">
                            <span>${analysis.industry}</span>
                        </div>
                        <div class="history-detail-badge">
                            <span>${formatBusinessSize(analysis.businessSize)}</span>
                        </div>
                        <div class="history-detail-badge">
                            <span>${formatReportingPeriod(analysis.reportingPeriod)}</span>
                        </div>
                    </div>
                    <button class="history-delete-btn" onclick="event.stopPropagation(); deleteSavedAnalysis('${analysis.id}')" title="Delete analysis">
                        ×
                    </button>
                </div>
            `).join('');
        
            populateMonthFilter();
            
            // Reset comparison state
            selectedComparisons = [];
            updateComparisonControls();
        }
        
        function formatBusinessSize(size) {
            const sizeMap = {
                'micro': 'Micro (1-10)',
                'small': 'Small (11-50)', 
                'medium': 'Medium (51-250)',
                'big': 'Large (250+)'
            };
            return sizeMap[size] || size;
        }
        
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function loadSavedAnalysis(analysisId) {
            const analysis = loadAnalysis(analysisId);
            if (!analysis) {
                alert('Analysis not found');
                return;
            }
            
            // Populate form fields
            document.getElementById('companyName').value = analysis.companyName;
            document.getElementById('industry').value = analysis.industry;
            document.getElementById('businessSize').value = analysis.businessSize;
            document.getElementById('reportingPeriod').value = analysis.reportingPeriod;
            
            // Show results directly
            populateResults(analysis.financialData);
            
            // Update UI state
            currentStep = 4;
            updateProgress(4);
            showCard(uploadCard);
            showCard(resultsCard);
            
            // Close modal
            closeHistoryModal();
            
            // Scroll specifically to the Financial Intelligence Dashboard
            setTimeout(() => {
                const resultsCard = document.getElementById('resultsCard');
                if (resultsCard) {
                    const cardTop = resultsCard.offsetTop;
                    const navHeight = 70; // Height of the fixed navigation
                    const offset = navHeight + 20; // Extra spacing for perfect positioning
                    
                    window.scrollTo({
                        top: cardTop - offset,
                        behavior: 'smooth'
                    });
                }
            }, 500);
        }
        
        function deleteSavedAnalysis(analysisId) {
            if (confirm('Are you sure you want to delete this analysis?')) {
                deleteAnalysis(analysisId);
                populateHistoryList();
            }
        }
        
        function clearAllAnalyses() {
            if (confirm('Are you sure you want to delete ALL saved analyses? This cannot be undone.')) {
                localStorage.removeItem(STORAGE_KEY);
                populateHistoryList();
            }
        }

        // Global variables for comparison
        let selectedComparisons = [];
        
        function handleHistoryItemClick(event, analysisId) {
            const checkbox = event.currentTarget.querySelector('.history-item-checkbox');
            
            // If clicking on the item but not checkbox, load the analysis (original behavior)
            if (!checkbox.checked && selectedComparisons.length === 0) {
                loadSavedAnalysis(analysisId);
            }
        }
        
        function handleCheckboxChange(event, analysisId) {
            const checkbox = event.target;
            const historyItem = checkbox.closest('.history-item');
            
            if (checkbox.checked) {
                // Add to comparison selection
                if (selectedComparisons.length < 2) {
                    selectedComparisons.push(analysisId);
                    historyItem.classList.add('selected');
                } else {
                    // Limit to 2 selections
                    checkbox.checked = false;
                    showComparisonError('You can only compare 2 periods at a time.');
                }
            } else {
                // Remove from comparison selection
                selectedComparisons = selectedComparisons.filter(id => id !== analysisId);
                historyItem.classList.remove('selected');
            }
            
            updateComparisonControls();
        }
        
        function updateComparisonControls() {
            const comparisonControls = document.getElementById('comparisonControls');
            const selectedCount = document.getElementById('selectedCount');
            const compareBtn = document.getElementById('compareBtn');
            
            if (selectedComparisons.length > 0) {
                comparisonControls.classList.remove('hidden');
                selectedCount.textContent = `${selectedComparisons.length} period${selectedComparisons.length > 1 ? 's' : ''} selected`;
                compareBtn.disabled = selectedComparisons.length !== 2;
            } else {
                comparisonControls.classList.add('hidden');
            }
        }
        
        function clearComparisons() {
            selectedComparisons = [];
            
            // Uncheck all checkboxes and remove selection styling
            document.querySelectorAll('.history-item-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('.history-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
            
            updateComparisonControls();
        }
        
        function showComparisonError(message) {
            // Create temporary error message
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #EF4444, #DC2626);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
                z-index: 10001;
                font-weight: 500;
                animation: slideInRight 0.3s ease;
            `;
            errorDiv.textContent = message;
            
            document.body.appendChild(errorDiv);
            
            // Remove after 3 seconds
            setTimeout(() => {
                errorDiv.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => document.body.removeChild(errorDiv), 300);
            }, 3000);
        }
        
        function startComparison() {
            if (selectedComparisons.length !== 2) {
                showComparisonError('Please select exactly 2 periods to compare.');
                return;
            }
            
            // Get the analyses data
            const savedAnalyses = getSavedAnalyses();
            const analysis1 = savedAnalyses.find(a => a.id === selectedComparisons[0]);
            const analysis2 = savedAnalyses.find(a => a.id === selectedComparisons[1]);
            
            if (!analysis1 || !analysis2) {
                showComparisonError('Error loading analysis data.');
                return;
            }
            
            // Debug log to check data
            console.log('Analysis 1:', analysis1);
            console.log('Analysis 2:', analysis2);
            
            // Close history modal and show comparison
            closeHistoryModal();
            showComparisonView(analysis1, analysis2);
        }
        
        // Also need to fix the parseFinancialData function
        function showComparisonView(analysis1, analysis2) {
            // Parse financial data - handle the JSON string format
            let data1, data2;
            
            try {
                data1 = {
                    income: typeof analysis1.financialData.incomeStatement === 'string' 
                        ? JSON.parse(analysis1.financialData.incomeStatement).incomeStatement
                        : analysis1.financialData.incomeStatement,
                    balance: typeof analysis1.financialData.balanceSheet === 'string'
                        ? JSON.parse(analysis1.financialData.balanceSheet).balanceSheet  
                        : analysis1.financialData.balanceSheet,
                    cashFlow: typeof analysis1.financialData.cashFlow === 'string'
                        ? JSON.parse(analysis1.financialData.cashFlow).cashFlow
                        : analysis1.financialData.cashFlow
                };
                
                data2 = {
                    income: typeof analysis2.financialData.incomeStatement === 'string'
                        ? JSON.parse(analysis2.financialData.incomeStatement).incomeStatement
                        : analysis2.financialData.incomeStatement,
                    balance: typeof analysis2.financialData.balanceSheet === 'string'
                        ? JSON.parse(analysis2.financialData.balanceSheet).balanceSheet
                        : analysis2.financialData.balanceSheet,
                    cashFlow: typeof analysis2.financialData.cashFlow === 'string'
                        ? JSON.parse(analysis2.financialData.cashFlow).cashFlow
                        : analysis2.financialData.cashFlow
                };
            } catch (error) {
                console.error('Error parsing financial data:', error);
                showComparisonError('Error parsing financial data.');
                return;
            }
            
            const comparisonModal = document.createElement('div');
            comparisonModal.className = 'comparison-view';
            comparisonModal.id = 'comparisonModal';
            
            comparisonModal.innerHTML = `
                <div class="comparison-content">
                    <div class="comparison-header">
                        <h3>Period Comparison Analysis</h3>
                        <button class="close-btn" onclick="closeComparisonView()">×</button>
                    </div>
                    <div style="padding: 24px;">
                        <div style="margin-bottom: 24px;">
                            <h4 style="color: #F8FAFC; margin-bottom: 16px;">Comparing:</h4>
                            <div style="display: flex; gap: 24px; margin-bottom: 32px;">
                                <div style="flex: 1; padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                                    <strong style="color: #60A5FA;">Period 1:</strong> ${analysis1.autoGeneratedName}
                                </div>
                                <div style="flex: 1; padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                                    <strong style="color: #10B981;">Period 2:</strong> ${analysis2.autoGeneratedName}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Comparison Tabs -->
                        <div class="comparison-tabs">
                            <button class="comparison-tab-btn active" onclick="showComparisonTab('income')">Income Statement</button>
                            <button class="comparison-tab-btn" onclick="showComparisonTab('balance')">Balance Sheet</button>
                            <button class="comparison-tab-btn" onclick="showComparisonTab('cashflow')">Cash Flow Statement</button>
                        </div>
                        
                        <!-- Income Statement Comparison -->
                        <div class="comparison-tab-content active" id="incomeComparison">
                            <h4 style="color: #F8FAFC; margin-bottom: 16px;">Income Statement Comparison</h4>
                            <table class="comparison-table">
                                <thead>
                                    <tr>
                                        <th style="text-align: left;">Item</th>
                                        <th>Period 1</th>
                                        <th>Period 2</th>
                                        <th>Change ($)</th>
                                        <th>Change (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="incomeComparisonBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Balance Sheet Comparison -->
                        <div class="comparison-tab-content" id="balanceComparison">
                            <h4 style="color: #F8FAFC; margin-bottom: 16px;">Balance Sheet Comparison</h4>
                            <table class="comparison-table">
                                <thead>
                                    <tr>
                                        <th style="text-align: left;">Item</th>
                                        <th>Period 1</th>
                                        <th>Period 2</th>
                                        <th>Change ($)</th>
                                        <th>Change (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="balanceComparisonBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Cash Flow Comparison -->
                        <div class="comparison-tab-content" id="cashflowComparison">
                            <h4 style="color: #F8FAFC; margin-bottom: 16px;">Cash Flow Statement Comparison</h4>
                            <table class="comparison-table">
                                <thead>
                                    <tr>
                                        <th style="text-align: left;">Item</th>
                                        <th>Period 1</th>
                                        <th>Period 2</th>
                                        <th>Change ($)</th>
                                        <th>Change (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="cashflowComparisonBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(comparisonModal);
            document.body.style.overflow = 'hidden';
            
            // Populate comparison data
            populateIncomeComparison(data1.income, data2.income);
            populateBalanceComparison(data1.balance, data2.balance);
            populateCashFlowComparison(data1.cashFlow, data2.cashFlow);
        }
        
        // Add tab switching function
        function showComparisonTab(tabType) {
            // Hide all tab contents
            document.querySelectorAll('.comparison-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.comparison-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            const tabMap = {
                'income': 'incomeComparison',
                'balance': 'balanceComparison',
                'cashflow': 'cashflowComparison'
            };
            
            document.getElementById(tabMap[tabType]).classList.add('active');
            
            // Activate clicked tab button
            event.target.classList.add('active');
        }
        
        function closeComparisonView() {
            const modal = document.getElementById('comparisonModal');
            if (modal) {
                document.body.removeChild(modal);
                // Don't restore body overflow yet - we're going back to history modal
                
                // Show history modal again
                showHistoryModal();
            }
        }
        
        function populateKeyMetricsComparison(data1, data2) {
            const tbody = document.getElementById('keyMetricsComparison');
            
            // Calculate key metrics for both periods
            const metrics1 = calculateKeyMetrics(data1);
            const metrics2 = calculateKeyMetrics(data2);
            
            const comparisons = [
                { name: 'Total Revenue', value1: metrics1.revenue, value2: metrics2.revenue },
                { name: 'Net Income', value1: metrics1.netIncome, value2: metrics2.netIncome },
                { name: 'Total Assets', value1: metrics1.totalAssets, value2: metrics2.totalAssets },
                { name: 'Total Liabilities', value1: metrics1.totalLiabilities, value2: metrics2.totalLiabilities },
                { name: 'Total Equity', value1: metrics1.totalEquity, value2: metrics2.totalEquity },
                { name: 'Working Capital', value1: metrics1.workingCapital, value2: metrics2.workingCapital }
            ];
            
            tbody.innerHTML = comparisons.map(metric => {
                const change = metric.value2 - metric.value1;
                const changePercent = metric.value1 !== 0 ? ((change / Math.abs(metric.value1)) * 100) : 0;
                const changeClass = change >= 0 ? 'positive-change' : 'negative-change';
                const changeSign = change >= 0 ? '+' : '';
                
                return `
                    <tr>
                        <td>${metric.name}</td>
                        <td>${formatCurrency(metric.value1)}</td>
                        <td>${formatCurrency(metric.value2)}</td>
                        <td class="${changeClass}">${changeSign}${formatCurrency(change)}</td>
                        <td class="${changeClass}">${changeSign}${changePercent.toFixed(1)}%</td>
                    </tr>
                `;
            }).join('');
        }

        function populateCashFlowComparison(cashFlow1, cashFlow2) {
            const tbody = document.getElementById('cashflowComparisonBody');
            
            // Get all unique items from both periods
            const allItems = new Set();
            cashFlow1.operating.forEach(item => allItems.add(item.item));
            cashFlow1.investing.forEach(item => allItems.add(item.item));
            cashFlow1.financing.forEach(item => allItems.add(item.item));
            cashFlow2.operating.forEach(item => allItems.add(item.item));
            cashFlow2.investing.forEach(item => allItems.add(item.item));
            cashFlow2.financing.forEach(item => allItems.add(item.item));
            
            const comparisons = Array.from(allItems).map(itemName => {
                const item1 = [...cashFlow1.operating, ...cashFlow1.investing, ...cashFlow1.financing].find(item => item.item === itemName);
                const item2 = [...cashFlow2.operating, ...cashFlow2.investing, ...cashFlow2.financing].find(item => item.item === itemName);
                
                const value1 = item1 ? item1.amount : 0;
                const value2 = item2 ? item2.amount : 0;
                
                return { name: itemName, value1, value2 };
            }).filter(item => item.value1 !== 0 || item.value2 !== 0); // Show items with any values
            
            tbody.innerHTML = comparisons.map(item => {
                const change = item.value2 - item.value1;
                const changePercent = item.value1 !== 0 ? ((change / Math.abs(item.value1)) * 100) : (item.value2 > 0 ? 100 : item.value2 < 0 ? -100 : 0);
                const changeClass = change >= 0 ? 'positive-change' : 'negative-change';
                const changeSign = change >= 0 ? '+' : '';
                
                return `
                    <tr>
                        <td>${item.name}</td>
                        <td>${formatCurrency(item.value1)}</td>
                        <td>${formatCurrency(item.value2)}</td>
                        <td class="${changeClass}">${changeSign}${formatCurrency(change)}</td>
                        <td class="${changeClass}">${changeSign}${changePercent.toFixed(1)}%</td>
                    </tr>
                `;
            }).join('');
        }
        
        function calculateKeyMetrics(data) {
            const revenue = data.income.revenue.reduce((sum, item) => sum + item.amount, 0);
            const expenses = data.income.expenses.reduce((sum, item) => sum + item.amount, 0);
            const netIncome = revenue - expenses;
            const totalAssets = data.balance.assets.reduce((sum, item) => sum + item.amount, 0);
            const totalLiabilities = data.balance.liabilities.reduce((sum, item) => sum + item.amount, 0);
            const totalEquity = data.balance.equity.reduce((sum, item) => sum + item.amount, 0);
            
            // Calculate working capital
            const currentAssets = getCurrentAssets(data.balance.assets);
            const currentLiabilities = getCurrentLiabilities(data.balance.liabilities);
            const workingCapital = currentAssets - currentLiabilities;
            
            return {
                revenue,
                netIncome,
                totalAssets,
                totalLiabilities,
                totalEquity,
                workingCapital
            };
        }
        
        function populateIncomeComparison(income1, income2) {
            const tbody = document.getElementById('incomeComparisonBody');
            
            // Get all unique items from both periods
            const allItems = new Set();
            income1.revenue.forEach(item => allItems.add(item.item));
            income1.expenses.forEach(item => allItems.add(item.item));
            income2.revenue.forEach(item => allItems.add(item.item));
            income2.expenses.forEach(item => allItems.add(item.item));
            
            const comparisons = Array.from(allItems).map(itemName => {
                const item1 = [...income1.revenue, ...income1.expenses].find(item => item.item === itemName);
                const item2 = [...income2.revenue, ...income2.expenses].find(item => item.item === itemName);
                
                const value1 = item1 ? item1.amount : 0;
                const value2 = item2 ? item2.amount : 0;
                
                return { name: itemName, value1, value2 };
            }).filter(item => item.value1 > 0 || item.value2 > 0); // Only show items with values
            
            tbody.innerHTML = comparisons.map(item => {
                const change = item.value2 - item.value1;
                const changePercent = item.value1 !== 0 ? ((change / Math.abs(item.value1)) * 100) : (item.value2 > 0 ? 100 : 0);
                const changeClass = change >= 0 ? 'positive-change' : 'negative-change';
                const changeSign = change >= 0 ? '+' : '';
                
                return `
                    <tr>
                        <td>${item.name}</td>
                        <td>${formatCurrency(item.value1)}</td>
                        <td>${formatCurrency(item.value2)}</td>
                        <td class="${changeClass}">${changeSign}${formatCurrency(change)}</td>
                        <td class="${changeClass}">${changeSign}${changePercent.toFixed(1)}%</td>
                    </tr>
                `;
            }).join('');
        }
        
        function populateBalanceComparison(balance1, balance2) {
            const tbody = document.getElementById('balanceComparisonBody');
            
            // Get all unique items from both periods
            const allItems = new Set();
            balance1.assets.forEach(item => allItems.add(item.item));
            balance1.liabilities.forEach(item => allItems.add(item.item));
            balance1.equity.forEach(item => allItems.add(item.item));
            balance2.assets.forEach(item => allItems.add(item.item));
            balance2.liabilities.forEach(item => allItems.add(item.item));
            balance2.equity.forEach(item => allItems.add(item.item));
            
            const comparisons = Array.from(allItems).map(itemName => {
                const item1 = [...balance1.assets, ...balance1.liabilities, ...balance1.equity].find(item => item.item === itemName);
                const item2 = [...balance2.assets, ...balance2.liabilities, ...balance2.equity].find(item => item.item === itemName);
                
                const value1 = item1 ? item1.amount : 0;
                const value2 = item2 ? item2.amount : 0;
                
                return { name: itemName, value1, value2 };
            }).filter(item => item.value1 > 0 || item.value2 > 0); // Only show items with values
            
            tbody.innerHTML = comparisons.map(item => {
                const change = item.value2 - item.value1;
                const changePercent = item.value1 !== 0 ? ((change / Math.abs(item.value1)) * 100) : (item.value2 > 0 ? 100 : 0);
                const changeClass = change >= 0 ? 'positive-change' : 'negative-change';
                const changeSign = change >= 0 ? '+' : '';
                
                return `
                    <tr>
                        <td>${item.name}</td>
                        <td>${formatCurrency(item.value1)}</td>
                        <td>${formatCurrency(item.value2)}</td>
                        <td class="${changeClass}">${changeSign}${formatCurrency(change)}</td>
                        <td class="${changeClass}">${changeSign}${changePercent.toFixed(1)}%</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Search functionality
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('historySearch');
            if (searchInput) {
                searchInput.addEventListener('input', filterHistoryList);
            }
        });
        
        function filterHistoryList() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const monthFilter = document.getElementById('monthFilter').value;
            const historyItems = document.querySelectorAll('.history-item');
            
            historyItems.forEach(item => {
                const title = item.querySelector('.history-item-title').textContent.toLowerCase();
                const analysisId = item.getAttribute('data-id');
                const savedAnalyses = getSavedAnalyses();
                const analysis = savedAnalyses.find(a => a.id === analysisId);
                
                const matchesSearch = title.includes(searchTerm);
                let matchesMonth = true;
                
                if (monthFilter && analysis) {
                    const reportingPeriod = analysis.reportingPeriod; // e.g., "2025-06"
                    const [year, month] = reportingPeriod.split('-');
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                       'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const formattedPeriod = `${monthNames[parseInt(month) - 1]} ${year}`;
                    matchesMonth = formattedPeriod === monthFilter;
                }
                
                if (matchesSearch && matchesMonth) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function populateMonthFilter() {
            const savedAnalyses = getSavedAnalyses();
            const monthFilter = document.getElementById('monthFilter');
            const periods = new Set();
            
            savedAnalyses.forEach(analysis => {
                if (analysis.reportingPeriod) {
                    const [year, month] = analysis.reportingPeriod.split('-');
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                       'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const formattedPeriod = `${monthNames[parseInt(month) - 1]} ${year}`;
                    periods.add(formattedPeriod);
                }
            });
            
            const sortedPeriods = Array.from(periods).sort((a, b) => {
                // Sort by year desc, then month desc
                const [monthA, yearA] = a.split(' ');
                const [monthB, yearB] = b.split(' ');
                if (yearA !== yearB) return yearB - yearA;
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return monthNames.indexOf(monthB) - monthNames.indexOf(monthA);
            });
            
            monthFilter.innerHTML = '<option value="">All periods</option>' + 
                sortedPeriods.map(period => `<option value="${period}">${period}</option>`).join('');
        }
        
        function addPDFHeader(doc, companyName, reportingPeriod) {
            // Company name
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text(companyName, 20, 25);
            
            // Report period
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Financial Statements - ${reportingPeriod}`, 20, 35);
            
            // Generated by MontPro
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('Generated by MontPro Financier', 20, 45);
            doc.setTextColor(0, 0, 0);
            
            // Line separator
            doc.setLineWidth(0.5);
            doc.line(20, 50, 190, 50);
        }
        
        function addPDFFooter(doc) {
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on ${new Date().toLocaleDateString()}`, 20, pageHeight - 10);
            doc.text('MontPro Financier - financier.montpro.xyz', 150, pageHeight - 10);
        }
        
        function generateIncomeStatementPDF(doc, startY, currency) {
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Income Statement', 20, startY);
            
            let yPos = startY + 15;
            
            if (!window.currentFinancialData) return yPos;
            
            const incomeData = window.currentFinancialData.incomeStatement;
            const totalRevenue = incomeData.revenue.reduce((sum, item) => sum + item.amount, 0);
            const totalExpenses = incomeData.expenses.reduce((sum, item) => sum + item.amount, 0);
            const netIncome = incomeData.netIncome || (totalRevenue - totalExpenses);
            
            // Revenue section
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Revenue', 20, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            incomeData.revenue.filter(item => item.amount > 0).forEach(item => {
                doc.text(`  ${item.item}`, 25, yPos);
                doc.text(formatCurrencyForPDF(item.amount, currency), 150, yPos, { align: 'right' });
                yPos += 6;
            });
            
            // Total Revenue
            doc.setFont('helvetica', 'bold');
            doc.text('Total Revenue', 25, yPos);
            doc.text(formatCurrencyForPDF(totalRevenue, currency), 150, yPos, { align: 'right' });
            yPos += 12;
            
            // Expenses section
            doc.text('Expenses', 20, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            incomeData.expenses.filter(item => item.amount > 0).forEach(item => {
                doc.text(`  ${item.item}`, 25, yPos);
                doc.text(formatCurrencyForPDF(item.amount, currency), 150, yPos, { align: 'right' });
                yPos += 6;
            });
            
            // Total Expenses
            doc.setFont('helvetica', 'bold');
            doc.text('Total Expenses', 25, yPos);
            doc.text(formatCurrencyForPDF(totalExpenses, currency), 150, yPos, { align: 'right' });
            yPos += 12;
            
            // Net Income
            doc.setFontSize(14);
            doc.text('Net Income', 25, yPos);
            doc.text(formatCurrencyForPDF(netIncome, currency), 150, yPos, { align: 'right' });
            
            return yPos + 20;
        }
        
        function generateBalanceSheetPDF(doc, startY, currency) {
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Balance Sheet', 20, startY);
            
            let yPos = startY + 15;
            
            if (!window.currentFinancialData) return yPos;
            
            const balanceData = window.currentFinancialData.balanceSheet;
            const totalAssets = balanceData.assets.reduce((sum, item) => sum + item.amount, 0);
            const totalLiabilities = balanceData.liabilities.reduce((sum, item) => sum + item.amount, 0);
            const totalEquity = balanceData.equity.reduce((sum, item) => sum + item.amount, 0);
            const calculatedEquity = totalAssets - totalLiabilities;
            const displayEquity = totalEquity > 0 ? totalEquity : calculatedEquity;
            
            // Assets section
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Assets', 20, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            balanceData.assets.filter(item => item.amount > 0).forEach(item => {
                doc.text(`  ${item.item}`, 25, yPos);
                doc.text(formatCurrencyForPDF(item.amount, currency), 150, yPos, { align: 'right' });
                yPos += 6;
            });
            
            // Total Assets
            doc.setFont('helvetica', 'bold');
            doc.text('Total Assets', 25, yPos);
            doc.text(formatCurrencyForPDF(totalAssets, currency), 150, yPos, { align: 'right' });
            yPos += 12;
            
            // Liabilities section
            doc.text('Liabilities', 20, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            balanceData.liabilities.filter(item => item.amount > 0).forEach(item => {
                doc.text(`  ${item.item}`, 25, yPos);
                doc.text(formatCurrencyForPDF(item.amount, currency), 150, yPos, { align: 'right' });
                yPos += 6;
            });
            
            // Total Liabilities
            doc.setFont('helvetica', 'bold');
            doc.text('Total Liabilities', 25, yPos);
            doc.text(formatCurrencyForPDF(totalLiabilities, currency), 150, yPos, { align: 'right' });
            yPos += 12;
            
            // Equity section
            doc.text('Equity', 20, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            if (totalEquity > 0) {
                balanceData.equity.filter(item => item.amount > 0).forEach(item => {
                    doc.text(`  ${item.item}`, 25, yPos);
                    doc.text(formatCurrencyForPDF(item.amount, currency), 150, yPos, { align: 'right' });
                    yPos += 6;
                });
            } else {
                doc.text('  Calculated Equity', 25, yPos);
                doc.text(formatCurrencyForPDF(calculatedEquity, currency), 150, yPos, { align: 'right' });
                yPos += 6;
            }
            
            // Total Equity
            doc.setFont('helvetica', 'bold');
            doc.text('Total Equity', 25, yPos);
            doc.text(formatCurrencyForPDF(displayEquity, currency), 150, yPos, { align: 'right' });
            
            return yPos + 20;
        }
        
        function generateCashFlowPDF(doc, startY, currency) {
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Cash Flow Statement', 20, startY);
            
            let yPos = startY + 15;
            
            if (!window.currentFinancialData) return yPos;
            
            const cashFlowData = window.currentFinancialData.cashFlow;
            const netOperating = cashFlowData.operating.reduce((sum, item) => sum + item.amount, 0);
            const netInvesting = cashFlowData.investing.reduce((sum, item) => sum + item.amount, 0);
            const netFinancing = cashFlowData.financing.reduce((sum, item) => sum + item.amount, 0);
            
            // Use backend values if available
            const beginningBalance = cashFlowData.beginningBalance || 0;
            const netCashChange = cashFlowData.netChangeInCash || (netOperating + netInvesting + netFinancing);
            const endingBalance = cashFlowData.endingBalance || (beginningBalance + netCashChange);
            
            // Beginning Cash Balance
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Beginning Cash Balance', 25, yPos);
            doc.text(formatCurrencyForPDF(beginningBalance, currency), 150, yPos, { align: 'right' });
            yPos += 12;
            
            // Operating Activities
            doc.text('Operating Activities', 20, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            cashFlowData.operating.filter(item => item.amount !== 0).forEach(item => {
                doc.text(`  ${item.item}`, 25, yPos);
                doc.text(formatCurrencyForPDF(item.amount, currency), 150, yPos, { align: 'right' });
                yPos += 6;
            });
            
            doc.setFont('helvetica', 'bold');
            doc.text('Net Cash from Operating', 25, yPos);
            doc.text(formatCurrencyForPDF(netOperating, currency), 150, yPos, { align: 'right' });
            yPos += 12;
            
            // Investing Activities
            doc.text('Investing Activities', 20, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            cashFlowData.investing.filter(item => item.amount !== 0).forEach(item => {
                doc.text(`  ${item.item}`, 25, yPos);
                doc.text(formatCurrencyForPDF(item.amount, currency), 150, yPos, { align: 'right' });
                yPos += 6;
            });
            
            doc.setFont('helvetica', 'bold');
            doc.text('Net Cash from Investing', 25, yPos);
            doc.text(formatCurrencyForPDF(netInvesting, currency), 150, yPos, { align: 'right' });
            yPos += 12;
            
            // Financing Activities
            doc.text('Financing Activities', 20, yPos);
            yPos += 8;
            
            doc.setFont('helvetica', 'normal');
            cashFlowData.financing.filter(item => item.amount !== 0).forEach(item => {
                doc.text(`  ${item.item}`, 25, yPos);
                doc.text(formatCurrencyForPDF(item.amount, currency), 150, yPos, { align: 'right' });
                yPos += 6;
            });
            
            doc.setFont('helvetica', 'bold');
            doc.text('Net Cash from Financing', 25, yPos);
            doc.text(formatCurrencyForPDF(netFinancing, currency), 150, yPos, { align: 'right' });
            yPos += 12;
            
            // Net Change in Cash
            doc.setFontSize(14);
            doc.text('Net Change in Cash', 25, yPos);
            doc.text(formatCurrencyForPDF(netCashChange, currency), 150, yPos, { align: 'right' });
            yPos += 8;
            
            // Ending Cash Balance
            doc.text('Ending Cash Balance', 25, yPos);
            doc.text(formatCurrencyForPDF(endingBalance, currency), 150, yPos, { align: 'right' });
            
            return yPos + 20;
        }
        
        function formatCurrencyForPDF(amount, currency) {
            const formatOptions = {
                'IDR': { locale: 'id-ID', currency: 'IDR' },
                'USD': { locale: 'en-US', currency: 'USD' },
                'EUR': { locale: 'de-DE', currency: 'EUR' },
                'SGD': { locale: 'en-SG', currency: 'SGD' }
            };
            
            const config = formatOptions[currency] || formatOptions['IDR'];
            
            return new Intl.NumberFormat(config.locale, {
                style: 'currency',
                currency: config.currency,
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        function getCurrentDateString() {
            return new Date().toISOString().split('T')[0];
        }
        
        function generateIncomeStatementCSV() {
            if (!window.currentFinancialData) return '';
            
            const incomeData = window.currentFinancialData.incomeStatement;
            let csv = 'Income Statement\n';
            csv += 'Item,Amount\n';
            
            csv += 'REVENUE,\n';
            incomeData.revenue.filter(item => item.amount > 0).forEach(item => {
                csv += `"${item.item}",${item.amount}\n`;
            });
            
            const totalRevenue = incomeData.revenue.reduce((sum, item) => sum + item.amount, 0);
            csv += `"Total Revenue",${totalRevenue}\n\n`;
            
            csv += 'EXPENSES,\n';
            incomeData.expenses.filter(item => item.amount > 0).forEach(item => {
                csv += `"${item.item}",${item.amount}\n`;
            });
            
            const totalExpenses = incomeData.expenses.reduce((sum, item) => sum + item.amount, 0);
            csv += `"Total Expenses",${totalExpenses}\n\n`;
            
            const netIncome = incomeData.netIncome || (totalRevenue - totalExpenses);
            csv += `"Net Income",${netIncome}\n`;
            
            return csv;
        }
        
        function generateBalanceSheetCSV() {
            if (!window.currentFinancialData) return '';
            
            const balanceData = window.currentFinancialData.balanceSheet;
            let csv = 'Balance Sheet\n';
            csv += 'Item,Amount\n';
            
            csv += 'ASSETS,\n';
            balanceData.assets.filter(item => item.amount > 0).forEach(item => {
                csv += `"${item.item}",${item.amount}\n`;
            });
            
            const totalAssets = balanceData.assets.reduce((sum, item) => sum + item.amount, 0);
            csv += `"Total Assets",${totalAssets}\n\n`;
            
            csv += 'LIABILITIES,\n';
            balanceData.liabilities.filter(item => item.amount > 0).forEach(item => {
                csv += `"${item.item}",${item.amount}\n`;
            });
            
            const totalLiabilities = balanceData.liabilities.reduce((sum, item) => sum + item.amount, 0);
            csv += `"Total Liabilities",${totalLiabilities}\n\n`;
            
            csv += 'EQUITY,\n';
            const totalEquity = balanceData.equity.reduce((sum, item) => sum + item.amount, 0);
            if (totalEquity > 0) {
                balanceData.equity.filter(item => item.amount > 0).forEach(item => {
                    csv += `"${item.item}",${item.amount}\n`;
                });
                csv += `"Total Equity",${totalEquity}\n`;
            } else {
                const calculatedEquity = totalAssets - totalLiabilities;
                csv += `"Calculated Equity",${calculatedEquity}\n`;
                csv += `"Total Equity",${calculatedEquity}\n`;
            }
            
            return csv;
        }
        
        function generateCashFlowCSV() {
            if (!window.currentFinancialData) return '';
            
            const cashFlowData = window.currentFinancialData.cashFlow;
            let csv = 'Cash Flow Statement\n';
            csv += 'Item,Amount\n';
            
            // Beginning balance
            const beginningBalance = cashFlowData.beginningBalance || 0;
            csv += `"Beginning Cash Balance",${beginningBalance}\n\n`;
            
            csv += 'OPERATING ACTIVITIES,\n';
            cashFlowData.operating.filter(item => item.amount !== 0).forEach(item => {
                csv += `"${item.item}",${item.amount}\n`;
            });
            const netOperating = cashFlowData.operating.reduce((sum, item) => sum + item.amount, 0);
            csv += `"Net Cash from Operating",${netOperating}\n\n`;
            
            csv += 'INVESTING ACTIVITIES,\n';
            cashFlowData.investing.filter(item => item.amount !== 0).forEach(item => {
                csv += `"${item.item}",${item.amount}\n`;
            });
            const netInvesting = cashFlowData.investing.reduce((sum, item) => sum + item.amount, 0);
            csv += `"Net Cash from Investing",${netInvesting}\n\n`;
            
            csv += 'FINANCING ACTIVITIES,\n';
            cashFlowData.financing.filter(item => item.amount !== 0).forEach(item => {
                csv += `"${item.item}",${item.amount}\n`;
            });
            const netFinancing = cashFlowData.financing.reduce((sum, item) => sum + item.amount, 0);
            csv += `"Net Cash from Financing",${netFinancing}\n\n`;
            
            // Use backend values
            const netCashChange = cashFlowData.netChangeInCash || (netOperating + netInvesting + netFinancing);
            const endingBalance = cashFlowData.endingBalance || (beginningBalance + netCashChange);
            
            csv += `"Net Change in Cash",${netCashChange}\n`;
            csv += `"Ending Cash Balance",${endingBalance}\n`;
            
            return csv;
        }
        
        function downloadCSV(csvContent, fileName) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function resetWorkspace() {
            scrollToForms();
            // Reset form
            document.getElementById('companyName').value = '';
            document.getElementById('industry').value = '';
            document.getElementById('businessSize').value = '';
            document.getElementById('reportingPeriod').value = '';
            
            // Clear files
            uploadedFiles = [];
            updateFileList();
            document.getElementById('uploadActions').style.display = 'none';
            
            // Reset progress
            currentStep = 1;
            updateProgress(1);
            
            // Reset card visibility states
            companyCard.classList.remove('hidden');
            companyCard.classList.add('active');
            uploadCard.classList.add('hidden');
            uploadCard.classList.remove('active');
            processingCard.classList.add('hidden');
            processingCard.classList.remove('active');
            resultsCard.classList.add('hidden');
            resultsCard.classList.remove('active');
            
            // Reset any processing intervals
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            if (window.processingInterval) {
                clearInterval(window.processingInterval);
            }
            
            // Reset progress variables
            currentProgress = 0;
            progressSpeed = 1;
            
            // Reset progress bar
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            progressFill.style.width = '25%';
            progressText.textContent = 'Step 1 of 4: Company Information';
            
            // Scroll back to top
            document.querySelector('.workspace-hero').scrollIntoView({ behavior: 'smooth' });
        }

        // Step visibility management
        function hideCompletedSteps() {
            // Hide company card and upload card
            companyCard.classList.add('hidden');
            companyCard.classList.remove('active');
            uploadCard.classList.add('hidden');
            uploadCard.classList.remove('active');
            
            // Also hide processing card since it's complete
            processingCard.classList.add('hidden');
            processingCard.classList.remove('active');
        }
        
        function showAllSteps() {
            // Show company card and upload card again
            companyCard.classList.remove('hidden');
            companyCard.classList.add('active');
            uploadCard.classList.remove('hidden');
            uploadCard.classList.add('active');
            
            // Hide processing and results cards
            processingCard.classList.add('hidden');
            processingCard.classList.remove('active');
            resultsCard.classList.add('hidden');
            resultsCard.classList.remove('active');
        }

        function scrollToForms() {
            const element = document.querySelector('.progress-indicator');
            const elementTop = element.offsetTop;
            const offset = -90; // Extra scroll amount
            
            window.scrollTo({
                top: elementTop + offset,
                behavior: 'smooth'
            });
        }

        function formatReportingPeriod(period) {
            if (period.includes('-')) {
                // Handle month input (YYYY-MM format)
                const [year, month] = period.split('-');
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            }
            return period;
        }

        function openMonthPicker(container) {
            const input = container.querySelector('input[type="month"]');
            input.focus();
            input.showPicker(); // This opens the calendar directly
        }

        function calculateSimpleCurrentRatio() {
            const assets = window.currentFinancialData.balanceSheet.assets;
            const liabilities = window.currentFinancialData.balanceSheet.liabilities;
            
            const currentAssets = assets.reduce((sum, item) => sum + item.amount, 0);
            const currentLiabilities = liabilities.reduce((sum, item) => sum + item.amount, 0);
            
            return currentLiabilities > 0 ? (currentAssets / currentLiabilities) : 0;
        }
        
        function calculateSimpleDebtToEquity() {
            const totalLiabilities = window.currentFinancialData.balanceSheet.liabilities.reduce((sum, item) => sum + item.amount, 0);
            const totalEquity = window.currentFinancialData.balanceSheet.equity.reduce((sum, item) => sum + item.amount, 0);
            
            return totalEquity > 0 ? (totalLiabilities / totalEquity) : 0;
        }
        
        function calculateSimpleROA() {
            const netIncome = window.calculatedNetIncome || 0;
            const totalAssets = window.currentFinancialData.balanceSheet.assets.reduce((sum, item) => sum + item.amount, 0);
            
            return totalAssets > 0 ? ((netIncome / totalAssets) * 100) : 0;
        }
        
        function calculateSimpleROE() {
            const netIncome = window.calculatedNetIncome || 0;
            const totalEquity = window.currentFinancialData.balanceSheet.equity.reduce((sum, item) => sum + item.amount, 0);
            
            return totalEquity > 0 ? ((netIncome / totalEquity) * 100) : 0;
        }

        async function generateInsights() {
            const insightsContent = document.getElementById('insightsContent');
            
            // Show loading state
            insightsContent.innerHTML = `
                <div class="insight-loading">
                    <div class="loading-spinner"></div>
                    <p>Generating your personalized insights...</p>
                </div>
            `;
            
            try {
                // Prepare enhanced data for backend
                const requestData = {
                    // Company Info
                    companyName: document.getElementById('companyName').value,
                    industry: document.getElementById('industry').value,
                    businessSize: document.getElementById('businessSize').value,
                    reportingPeriod: document.getElementById('reportingPeriod').value,
                    
                    // Complete Financial Data
                    financialData: window.currentFinancialData,
                    
                    // Pre-calculated Key Metrics
                    keyMetrics: {
                        // Revenue & Profitability
                        totalRevenue: window.currentFinancialData.incomeStatement.revenue.reduce((sum, item) => sum + item.amount, 0),
                        totalExpenses: window.currentFinancialData.incomeStatement.expenses.reduce((sum, item) => sum + item.amount, 0),
                        netIncome: window.calculatedNetIncome || 0,
                        grossProfit: window.calculatedGrossProfit || 0,
                        netMargin: window.currentFinancialData ? (window.calculatedNetIncome / window.currentFinancialData.incomeStatement.revenue.reduce((sum, item) => sum + item.amount, 0)) * 100 : 0,
                        
                        // Balance Sheet
                        totalAssets: window.currentFinancialData.balanceSheet.assets.reduce((sum, item) => sum + item.amount, 0),
                        totalLiabilities: window.currentFinancialData.balanceSheet.liabilities.reduce((sum, item) => sum + item.amount, 0),
                        totalEquity: window.currentFinancialData.balanceSheet.equity.reduce((sum, item) => sum + item.amount, 0),
                        
                        // Cash Flow
                        operatingCashFlow: window.currentFinancialData.cashFlow.operating.reduce((sum, item) => sum + item.amount, 0),
                        beginningCash: window.currentFinancialData.cashFlow.beginningBalance || 0,
                        endingCash: window.currentFinancialData.cashFlow.endingBalance || 0,
                        netCashChange: window.currentFinancialData.cashFlow.netChangeInCash || 0,
                        cashBalance: window.currentFinancialData.balanceSheet.assets.find(item => 
                            item.item.toLowerCase().includes('cash'))?.amount || 0,
                        
                        // Key Ratios (simplified calculations)
                        currentRatio: calculateSimpleCurrentRatio(),
                        debtToEquity: calculateSimpleDebtToEquity(),
                        roa: calculateSimpleROA(),
                        roe: calculateSimpleROE()
                    },
                    
                    // Currency for formatting
                    currency: document.getElementById('currencySelect').value,
                    
                    // Metadata
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                
                // Call backend
                const response = await fetch('https://montpro.app.n8n.cloud/webhook/financier-generator-insights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
        
                console.log('Response status:', response.status);
        
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
        
                // Get the raw text first to see exactly what we're receiving
                const responseText = await response.text();
                console.log('Raw response text:', responseText);
        
                // Then parse it
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    console.error('Raw response that failed to parse:', responseText);
                    throw new Error('Invalid JSON response from server');
                }
        
                console.log('Parsed result:', result);
                console.log('Type of result:', typeof result);
                console.log('Is result an array?', Array.isArray(result));
        
                // Extract insights from the nested structure
                let insights;
                if (result.result && Array.isArray(result.result)) {
                    // Backend returned {result: [insights...]}
                    insights = result.result;
                } else if (Array.isArray(result)) {
                    // Backend returned [insights...] directly
                    insights = result;
                } else {
                    // Single insight object
                    insights = [result];
                }
        
                console.log('Final insights to display:', insights);
                
                displayInsights(insights);
                
            } catch (error) {
                console.error('Error generating insights:', error);
                
                // Show detailed error message
                insightsContent.innerHTML = `
                    <div class="insight-loading">
                        <p style="color: #EF4444;">Error: ${error.message}</p>
                        <p style="color: #94A3B8; font-size: 0.9rem;">Check console for details. Showing demo insights...</p>
                    </div>
                `;
                
                // Show demo insights after 2 seconds
                setTimeout(() => {
                    displayDemoInsights();
                }, 2000);
            }
        }
        
        function displayInsights(insights) {
            const insightsContent = document.getElementById('insightsContent');
            
            console.log('displayInsights received:', insights);
            console.log('insights length:', insights.length);
            
            if (!Array.isArray(insights) || insights.length === 0) {
                insightsContent.innerHTML = `
                    <div class="insight-loading">
                        <p style="color: #EF4444;">No insights generated. Please try again.</p>
                    </div>
                `;
                return;
            }
            
            insightsContent.innerHTML = `
                <div class="insights-grid">
                    ${insights.map((insight, index) => {
                        console.log(`Processing insight ${index}:`, insight);
                        return `
                            <div class="insight-card ${insight.priority === 'high' ? 'priority-high' : ''}">
                                <div class="insight-header">
                                    <div class="insight-icon" style="background: ${insight.iconColor}">
                                        ${insight.icon}
                                    </div>
                                    <div class="insight-title">${insight.title}</div>
                                    <div class="insight-category">${insight.category}</div>
                                </div>
                                <div class="insight-content">${insight.content}</div>
                                <div class="insight-action">💡 ${insight.action}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function displayDemoInsights() {
            // Demo insights for testing
            const demoInsights = [
                {
                    title: "Cash Flow Health",
                    content: "You have approximately 3.2 months of operating expenses in cash reserves. This provides a good safety cushion for your business operations.",
                    action: "💡 Consider building up to 6 months for stronger financial security",
                    icon: "💰",
                    iconColor: "linear-gradient(135deg, #10B981, #059669)"
                },
                {
                    title: "Revenue Growth",
                    content: "Your revenue shows steady growth patterns. The current trajectory indicates healthy business expansion.",
                    action: "📈 Focus on maintaining this growth momentum",
                    icon: "📊",
                    iconColor: "linear-gradient(135deg, #3B82F6, #1E40AF)"
                }
            ];
            
            displayInsights(demoInsights);
        }

        function exportSelectedReports(format) {
            // Get selected reports
            const selectedReports = {
                income: document.getElementById('exportIncome').checked,
                balance: document.getElementById('exportBalance').checked,
                cashflow: document.getElementById('exportCashflow').checked,
                ratios: document.getElementById('exportRatios').checked,
                insights: document.getElementById('exportInsights').checked
            };
            
            // Check if at least one report is selected
            const hasSelection = Object.values(selectedReports).some(selected => selected);
            if (!hasSelection) {
                alert('Please select at least one report to export.');
                return;
            }
            
            // Get company info for filename
            const companyName = document.getElementById('companyName').value;
            const timestamp = getCurrentDateString();
            
            if (format === 'pdf') {
                generateSelectedPDF(selectedReports, companyName, timestamp);
            } else if (format === 'csv') {
                generateSelectedCSV(selectedReports, companyName, timestamp);
            }
        }
        
        function generateSelectedPDF(selectedReports, companyName, timestamp) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const reportingPeriod = formatReportingPeriod(document.getElementById('reportingPeriod').value);
            const currency = document.getElementById('currencySelect').value;
            
            let isFirstPage = true;
            let yPosition = 60;
            
            // Add reports in order
            if (selectedReports.income) {
                if (!isFirstPage) {
                    doc.addPage();
                    yPosition = 60;
                }
                addPDFHeader(doc, companyName, reportingPeriod);
                yPosition = generateIncomeStatementPDF(doc, yPosition, currency);
                isFirstPage = false;
            }
            
            if (selectedReports.balance) {
                if (!isFirstPage) {
                    doc.addPage();
                    yPosition = 60;
                }
                addPDFHeader(doc, companyName, reportingPeriod);
                yPosition = generateBalanceSheetPDF(doc, yPosition, currency);
                isFirstPage = false;
            }
            
            if (selectedReports.cashflow) {
                if (!isFirstPage) {
                    doc.addPage();
                    yPosition = 60;
                }
                addPDFHeader(doc, companyName, reportingPeriod);
                yPosition = generateCashFlowPDF(doc, yPosition, currency);
                isFirstPage = false;
            }
            
            if (selectedReports.ratios) {
                if (!isFirstPage) {
                    doc.addPage();
                    yPosition = 60;
                }
                addPDFHeader(doc, companyName, reportingPeriod);
                yPosition = generateRatiosPDF(doc, yPosition, currency);
                isFirstPage = false;
            }
            
            if (selectedReports.insights) {
                if (!isFirstPage) {
                    doc.addPage();
                    yPosition = 60;
                }
                addPDFHeader(doc, companyName, reportingPeriod);
                yPosition = generateInsightsPDF(doc, yPosition);
                isFirstPage = false;
            }
            
            // Add footer to all pages
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                addPDFFooter(doc);
            }
            
            // Generate filename based on selected reports
            const reportTypes = [];
            if (selectedReports.income) reportTypes.push('Income');
            if (selectedReports.balance) reportTypes.push('Balance');
            if (selectedReports.cashflow) reportTypes.push('CashFlow');
            if (selectedReports.ratios) reportTypes.push('Ratios');
            if (selectedReports.insights) reportTypes.push('Insights');
            
            const fileName = `${companyName.replace(/[^a-zA-Z0-9]/g, '_')}_${reportTypes.join('_')}_${timestamp}.pdf`;
            doc.save(fileName);
        }
        
        function generateSelectedCSV(selectedReports, companyName, timestamp) {
            const reportingPeriod = formatReportingPeriod(document.getElementById('reportingPeriod').value);
            
            let csvContent = `Company: ${companyName}\n`;
            csvContent += `Period: ${reportingPeriod}\n`;
            csvContent += `Generated: ${new Date().toLocaleDateString()}\n\n`;
            
            if (selectedReports.income) {
                csvContent += generateIncomeStatementCSV() + '\n\n';
            }
            
            if (selectedReports.balance) {
                csvContent += generateBalanceSheetCSV() + '\n\n';
            }
            
            if (selectedReports.cashflow) {
                csvContent += generateCashFlowCSV() + '\n\n';
            }
            
            if (selectedReports.ratios) {
                csvContent += generateRatiosCSV() + '\n\n';
            }
            
            if (selectedReports.insights) {
                csvContent += generateInsightsCSV() + '\n\n';
            }
            
            // Generate filename
            const reportTypes = [];
            if (selectedReports.income) reportTypes.push('Income');
            if (selectedReports.balance) reportTypes.push('Balance');
            if (selectedReports.cashflow) reportTypes.push('CashFlow');
            if (selectedReports.ratios) reportTypes.push('Ratios');
            if (selectedReports.insights) reportTypes.push('Insights');
            
            const fileName = `${companyName.replace(/[^a-zA-Z0-9]/g, '_')}_${reportTypes.join('_')}_${timestamp}.csv`;
            downloadCSV(csvContent, fileName);
        }
        
        // New PDF generation functions for Ratios and Insights
        function generateRatiosPDF(doc, startY, currency) {
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Financial Ratios Analysis', 20, startY);
            
            let yPos = startY + 15;
            const pageHeight = doc.internal.pageSize.height;
            const maxY = pageHeight - 40; // Leave space for footer
            
            // Get ratios data
            const ratiosData = extractRatiosData();
            
            Object.keys(ratiosData).forEach(category => {
                // Check if we need a new page
                if (yPos > maxY - 60) { // 60px needed for category + some ratios
                    doc.addPage();
                    addPDFHeader(doc, document.getElementById('companyName').value, formatReportingPeriod(document.getElementById('reportingPeriod').value));
                    yPos = 60;
                }
                
                // Category header
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(category, 20, yPos);
                yPos += 10;
                
                // Ratios in this category
                doc.setFont('helvetica', 'normal');
                ratiosData[category].forEach(ratio => {
                    // Check if we need a new page for individual ratios
                    if (yPos > maxY - 20) {
                        doc.addPage();
                        addPDFHeader(doc, document.getElementById('companyName').value, formatReportingPeriod(document.getElementById('reportingPeriod').value));
                        yPos = 60;
                    }
                    
                    doc.text(`  ${ratio.name}`, 25, yPos);
                    doc.text(ratio.formattedValue, 150, yPos, { align: 'right' });
                    yPos += 6;
                });
                yPos += 8;
            });
            
            return yPos + 20;
        }
        
        function generateInsightsPDF(doc, startY) {
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Financial Insights', 20, startY);
            
            let yPos = startY + 15;
            const pageHeight = doc.internal.pageSize.height;
            const maxY = pageHeight - 40; // Leave space for footer
            
            // Get insights data
            const insights = extractInsightsData();
            
            insights.forEach(insight => {
                // Check if we need a new page for this insight
                const estimatedHeight = 80; // Rough estimate for insight block
                if (yPos > maxY - estimatedHeight) {
                    doc.addPage();
                    addPDFHeader(doc, document.getElementById('companyName').value, formatReportingPeriod(document.getElementById('reportingPeriod').value));
                    yPos = 60;
                }
                
                // Category and Title
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(`${insight.category}: ${insight.title}`, 20, yPos);
                yPos += 10;
                
                // Content
                doc.setFont('helvetica', 'normal');
                const contentLines = doc.splitTextToSize(insight.content, 170);
                contentLines.forEach(line => {
                    // Check for page break on each line
                    if (yPos > maxY - 15) {
                        doc.addPage();
                        addPDFHeader(doc, document.getElementById('companyName').value, formatReportingPeriod(document.getElementById('reportingPeriod').value));
                        yPos = 60;
                    }
                    doc.text(line, 25, yPos);
                    yPos += 6;
                });
                yPos += 4;
                
                // Action
                doc.setFont('helvetica', 'italic');
                const actionLines = doc.splitTextToSize(`Action: ${insight.action}`, 170);
                actionLines.forEach(line => {
                    if (yPos > maxY - 15) {
                        doc.addPage();
                        addPDFHeader(doc, document.getElementById('companyName').value, formatReportingPeriod(document.getElementById('reportingPeriod').value));
                        yPos = 60;
                    }
                    doc.text(line, 25, yPos);
                    yPos += 6;
                });
                yPos += 12;
            });
            
            return yPos + 20;
        }
        
        // CSV generation functions for new reports
        function generateRatiosCSV() {
            let csv = 'Financial Ratios Analysis\n';
            csv += 'Category,Ratio Name,Value\n';
            
            const ratiosData = extractRatiosData();
            
            Object.keys(ratiosData).forEach(category => {
                ratiosData[category].forEach(ratio => {
                    csv += `"${category}","${ratio.name}","${ratio.formattedValue}"\n`;
                });
            });
            
            return csv;
        }
        
        function generateInsightsCSV() {
            let csv = 'Financial Insights\n';
            csv += 'Category,Title,Content,Action,Priority\n';
            
            const insights = extractInsightsData();
            
            insights.forEach(insight => {
                csv += `"${insight.category}","${insight.title}","${insight.content}","${insight.action}","${insight.priority}"\n`;
            });
            
            return csv;
        }
        
        // Helper functions to extract data from current display
        function extractRatiosData() {
            // Extract ratios from the current DOM display
            const ratiosData = {};
            
            document.querySelectorAll('.ratio-category-card').forEach(card => {
                const categoryName = card.querySelector('h5').textContent;
                const ratios = [];
                
                card.querySelectorAll('.ratio-item').forEach(item => {
                    const name = item.querySelector('.ratio-name').textContent;
                    const value = item.querySelector('.ratio-number').textContent;
                    ratios.push({ name, formattedValue: value });
                });
                
                ratiosData[categoryName] = ratios;
            });
            
            return ratiosData;
        }
        
        function extractInsightsData() {
            // Extract insights from the current DOM display
            const insights = [];
            
            document.querySelectorAll('.insight-card').forEach(card => {
                const category = card.querySelector('.insight-category').textContent;
                const title = card.querySelector('.insight-title').textContent;
                const content = card.querySelector('.insight-content').textContent;
                const action = card.querySelector('.insight-action').textContent.replace('💡 ', '');
                const priority = card.classList.contains('priority-high') ? 'high' : 'medium';
                
                insights.push({ category, title, content, action, priority });
            });
            
            return insights;
        }

        let currentExportFormat = 'pdf';

        function showExportModal(format) {
            currentExportFormat = format;
            document.getElementById('exportModalTitle').textContent = `Export to ${format.toUpperCase()}`;
            document.getElementById('executeExportBtn').textContent = `Export to ${format.toUpperCase()}`;
            document.getElementById('exportModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
            document.body.style.overflow = '';
        }
        
        function executeExport() {
            const selectedReports = {
                income: document.getElementById('modalExportIncome').checked,
                balance: document.getElementById('modalExportBalance').checked,
                cashflow: document.getElementById('modalExportCashflow').checked,
                ratios: document.getElementById('modalExportRatios').checked,
                insights: document.getElementById('modalExportInsights').checked
            };
            
            // Check if at least one report is selected
            const hasSelection = Object.values(selectedReports).some(selected => selected);
            if (!hasSelection) {
                alert('Please select at least one report to export.');
                return;
            }
            
            // Close modal and export
            closeExportModal();
            
            // Use your existing export logic
            const companyName = document.getElementById('companyName').value;
            const timestamp = getCurrentDateString();
            
            if (currentExportFormat === 'pdf') {
                generateSelectedPDF(selectedReports, companyName, timestamp);
            } else if (currentExportFormat === 'csv') {
                generateSelectedCSV(selectedReports, companyName, timestamp);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('historySearch');
            const monthFilter = document.getElementById('monthFilter');
            
            if (searchInput) {
                searchInput.addEventListener('input', filterHistoryList);
            }
            if (monthFilter) {
                monthFilter.addEventListener('change', filterHistoryList);
            }
        });

        // Initialize
        updateProgress(1);
    </script>

<!-- History Dashboard Modal -->
<div class="history-modal hidden" id="historyModal">
    <div class="history-modal-backdrop" onclick="closeHistoryModal()"></div>
    <div class="history-modal-content">
        <div class="history-header">
            <h3>Analysis History</h3>
            <button class="close-btn" onclick="closeHistoryModal()">×</button>
        </div>
        
        <div class="history-controls">
            <div class="search-container">
                <input type="text" id="historySearch" placeholder="Search by company name..." class="search-input">
                <select id="monthFilter" class="filter-select">
                    <option value="">All months</option>
                </select>
            </div>
            <div class="history-stats">
                <span id="historyCount">0 analyses saved</span>
            </div>
        </div>

        <div class="comparison-controls hidden" id="comparisonControls">
            <div class="comparison-info">
                <span id="selectedCount">0 periods selected</span>
                <span class="comparison-hint">Select 2 periods to compare</span>
            </div>
            <div class="comparison-actions">
                <button class="btn btn-secondary" onclick="clearComparisons()">Clear Selection</button>
                <button class="btn btn-primary" onclick="startComparison()" id="compareBtn" disabled>Compare Selected Periods</button>
            </div>
        </div>
        
        <div class="history-list" id="historyList">
            <!-- Analysis items will be populated here -->
        </div>
        
        <div class="history-actions">
            <button class="btn btn-secondary" onclick="clearAllAnalyses()">Clear All History</button>
            <button class="btn btn-secondary" onclick="closeHistoryModal()">Close</button>
        </div>
    </div>
</div>

<!-- Export Selection Modal -->
<div class="export-modal hidden" id="exportModal">
    <div class="export-modal-backdrop" onclick="closeExportModal()"></div>
    <div class="export-modal-content">
        <div class="export-header">
            <h3 id="exportModalTitle">Export to PDF</h3>
            <button class="close-btn" onclick="closeExportModal()">×</button>
        </div>
        
        <div class="export-body">
            <div class="export-section">
                <h4>Select Reports to Include:</h4>
                <div class="export-checkboxes">
                    <label class="export-checkbox">
                        <input type="checkbox" id="modalExportIncome" checked>
                        <span class="checkbox-text">Income Statement</span>
                    </label>
                    <label class="export-checkbox">
                        <input type="checkbox" id="modalExportBalance" checked>
                        <span class="checkbox-text">Balance Sheet</span>
                    </label>
                    <label class="export-checkbox">
                        <input type="checkbox" id="modalExportCashflow" checked>
                        <span class="checkbox-text">Cash Flow Statement</span>
                    </label>
                    <label class="export-checkbox">
                        <input type="checkbox" id="modalExportRatios" checked>
                        <span class="checkbox-text">Financial Ratios</span>
                    </label>
                    <label class="export-checkbox">
                        <input type="checkbox" id="modalExportInsights">
                        <span class="checkbox-text">Financial Insights</span>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="export-actions-modal">
            <button class="btn btn-secondary" onclick="closeExportModal()">Cancel</button>
            <button class="btn btn-primary" onclick="executeExport()" id="executeExportBtn">Export Selected Reports</button>
        </div>
    </div>
</div>
    
</body>
</html>
